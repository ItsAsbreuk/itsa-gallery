YUI.add("gallery-itsachangemodeltemplate",function(e,t){"use strict";var n=e.Lang,r=e.Array,i="yui3-itsaformelement",s=i+"-changed",o="originaltemplate",u="secondtemplate",a="edittemplate",f="itsa-model",l="Error: Attribute editTemplate is undefined",c="Error: gallery-itsaeditmodel should be loaded in the loader",h=function(e){var t=/<%(.+)%>/;return t.test(e)},p="pluggedin";e.namespace("Plugin").ITSAChangeModelTemplate=e.Base.create("itsachangemodeltemplate",e.Plugin.Base,[],{initializer:function(){var t=this,n;n=t.host=t.get("host"),t._secondTempl=null,t._secondTemplIsMicro=null,t._editTempl=null,t._editTemplIsMicro=null,t._initialEditAttrs={},t._secondModels={},t._editModels={},t._prevMode={},t._eventhandlers=[],t._currentModelHasChanged={},t._newModelCanChangeTemplate={},t._fireEventTimer=null,t._prevComparator={},t._bindUI(),t._fireEventTimer=e.later(50,t,function(){n.itsacmtemplate&&(t._fireEventTimer.cancel(),t.fire(p))},null,!0)},setModelToOriginalTemplate:function(e){var t=this,n=t.host,r=n.getModelAttr(e,"clientId"),i=n.get("modelList"),s=i&&i.comparator,o;o=t._getMode(e),o!==1&&(t._prevMode[r]=t._getMode(e),delete t._secondModels[r],delete t._initialEditAttrs[r],delete t._editModels[r],t._currentModelHasChanged[r]&&s&&t._prevComparator[r]!==t._getComparator(i,s,e)?(i.sort(),n._listLazy&&i.free(),n._repositionModel(e)):t._renderOriginalTemplate(e),delete t._prevComparator[r],delete t._currentModelHasChanged[r])},setModelToSecondTemplate:function(t){var n=this,r=n.host,i=r.getModelAttr(t,"clientId"),s=r.get("modelList"),o=s&&e.bind(s.comparator,s),u;u=n._getMode(t),u!==2&&(delete n._initialEditAttrs[i],n._prevMode[i]=n._getMode(t),n._secondModels[i]=!0,delete n._editModels[i],n._currentModelHasChanged[i]&&o&&n._prevComparator[i]!==n._getComparator(s,o,t)?(s.sort(),r._listLazy&&s.free(),r._renderView()):n._renderSecondTemplate(t),delete n._prevComparator[i],delete n._currentModelHasChanged[i])},setModelToEditTemplate:function(t){var r=this,i=r.host,s=i.get("modelList"),o=s&&e.bind(s.comparator,s),u=i.getModelAttr(t,"clientId"),a;r.get("modelsEditable")&&(a=r._getMode(t),a!==3&&(delete r._currentModelHasChanged[u],r._prevComparator[u]=o&&r._getComparator(s,o,t),r._prevMode[u]=a,r._editModels[u]=!0,delete r._secondModels[u],r._renderEditTemplate(t,function(){var e=n.isNumber(t)?i.getNodeFromIndex(t,0):i.getNodeFromModel(t,0);e&&e.itsatabkeymanager&&e.itsatabkeymanager.focusInitialItem()})))},restoreTemplate:function(e){var t=this,n=t.host,r=n.getModelAttr(e,"clientId"),i=t._prevMode[r]||1;n.isNewModel(e)&&(t._newModelCanChangeTemplate[r]=!0);switch(i){case 1:t.setModelToOriginalTemplate(e);break;case 2:t.setModelToSecondTemplate(e);break;case 3:t.setModelToEditTemplate(e)}},destructor:function(){var e=this;e._fireEventTimer&&e._fireEventTimer.cancel(),e._clearEventhandlers(),e._initialEditAttrs={},e._secondModels={},e._editModels={},e._prevMode={},e._prevComparator={},e._currentModelHasChanged={},e._newModelCanChangeTemplate={}},_bindUI:function(){var t=this,r=t.host,i=t._eventhandlers;i.push(r.after("itsaeditmodel:focusnext",function(e){var t=e.target.get("host"),n=r.getNodeFromModel(t),i;while(n&&!n.hasClass("itsa-model"))n=n.get("parentNode");n&&(i=n.itsatabkeymanager,i&&n.hasClass("itsa-model-focus")&&i.next())})),i.push(r.after("*:resetclick",function(i){var s=i.target,o={fromEditModel:!0},u;s instanceof e.Model&&(u=t._initialEditAttrs[s.get("clientId")],u&&(s.setAttrs(u,o),t._getMode(s)===3&&t._renderEditTemplate(s,function(){var e=n.isNumber(s)?r.getNodeFromIndex(s,0):r.getNodeFromModel(s,0);e&&e.itsatabkeymanager&&e.itsatabkeymanager.focusInitialItem()}),r.modelIsSelected(s)&&r._fireSelectedModels()))})),i.push(r.after(["itsaeditmodel:editmodelConfigAttrsChange","itsaeditmodel:templateChange"],function(){t.get("modelsEditable")&&r._renderView(null,null)})),i.push(r.after("*:submitclick",function(n){var r=n.target;r instanceof e.Model&&t.get("restoreOnSubmit")&&t.restoreTemplate(r)})),i.push(r.after("*:saveclick",function(n){var r=n.target;r instanceof e.Model&&t.get("restoreOnSave")&&t.restoreTemplate(r)})),i.push(t.after("modelsEditableChange",e.bind(r._renderView,r,null,null))),i.push(t.after("editmodelConfigAttrsChange",function(){t._editTempl=null})),i.push(r.after("*:change",function(n){var i=n.target,o,u;i instanceof e.Model&&t._getMode(i)===3&&(u=r.getModelAttr(i,"clientId"),t._currentModelHasChanged[u]=!0,o=r.getNodeFromModel(i,0),o.all("."+s).removeClass(s))})),i.push(r.on("*:destroy",function(n){var i=n.target;i instanceof e.Model&&(delete t._editModels[i.get("clientId")],r.modelIsSelected(i)&&r.unselectModels(i,!1,!0))})),i.push(r.on("itsaeditmodel:destroy",function(e){var n=e.target.get("host");t.restoreTemplate(n)})),i.push(r.get("boundingBox").delegate("click",function(e){var n=e.currentTarget,i=n.hasClass(o),s=n.hasClass(u),l=n.hasClass(a),c,h;if(i||s||l){c=n.get("parentNode");while(c&&!c.hasClass(f))c=n.get("parentNode");c&&(h=r.getModelFromNode(c),i?t.setModelToOriginalTemplate(h):s?t.setModelToSecondTemplate(h):l&&t.setModelToEditTemplate(h))}},"button"))},_clearEventhandlers:function(){r.each(this._eventhandlers,function(e){e.detach()})},_getComparator:function(e,t,n){var r=this,i=r.host,s;return n?(i._listLazy&&n.get&&typeof n.get=="function"&&(s=e.getByClientId(n.get("clientId"))),t(s||n)):0},_getMode:function(t){var n=this,r=n.get("modelsEditable"),i=n.get("secondTemplate"),s=n.get("editTemplate"),o=n.host,u=o.getModelAttr(t,"clientId"),a=1,f,c,h,p;return i&&n._secondModels[u]?a=2:r&&s&&n._editModels[u]?a=3:o.isNewModel(t)&&!n._newModelCanChangeTemplate[u]&&(f=n.get("newModelMode"),f===2&&i?(a=2,n._secondModels[u]=!0):f===3&&r&&s&&(a=3,c=t.get&&typeof t.get=="function",!c&&o._listLazy&&(p=o.get("modelList").revive(t)),h=p||t,n._initialEditAttrs[u]=h.getAttrs(),h.itsaeditmodel||e.use("gallery-itsaeditmodel",function(e){h.plug(e.Plugin.ITSAEditModel,n.get("configForEditModel")),n._editTempl||n._setEditTemplate(n.get("editTemplate")||h.itsaeditmodel.get("template"
)||l)}),n._editModels[u]=!0)),a},_getModelEngine:function(e,t,r){var i=this,s=i.host,o=i._getMode(e),u,a;switch(o){case 1:u=s.getModelToJSON(e),a=r?r(u):n.sub(t,u);break;case 2:a=i._altTempl(e);break;case 3:a=i._editTempl(e)}return a},_renderEditTemplate:function(t,r){var i=this,s=i.host,o,u,a,f;o=n.isNumber(t)?s.getNodeFromIndex(t,0):s.getNodeFromModel(t,0),o&&((h(i.get("template"))||i._secondTempl&&i._secondTemplIsMicro)&&o.cleanup(),e.use("gallery-itsatabkeymanager",function(e){o.itsatabkeymanager||o.plug(e.Plugin.ITSATabKeyManager),u=t.get&&typeof t.get=="function",!u&&s._listLazy&&(a=s.get("modelList").revive(t)),f=a||t,i._initialEditAttrs[f.get("clientId")]=f.getAttrs(),f.itsaeditmodel?(i._editTempl||i._setEditTemplate(i.get("editTemplate")||f.itsaeditmodel.get("template")||l),o.setHTML(i._editTempl(f)),typeof r=="function"&&r()):e.use("gallery-itsaeditmodel",function(e){f.plug(e.Plugin.ITSAEditModel,i.get("configForEditModel")),i._editTempl||i._setEditTemplate(i.get("editTemplate")||f.itsaeditmodel.get("template")||l),o.setHTML(i._editTempl(f)),typeof r=="function"&&r()})}))},_renderSecondTemplate:function(e){var t=this,r=t.host,i=t._secondTempl||r._templFns.template,s;s=n.isNumber(e)?r.getNodeFromIndex(e,0):r.getNodeFromModel(e,0),s&&i&&((h(t.get("template"))||e.itsaeditmodel)&&s.cleanup(),s.setHTML(i(e)))},_renderOriginalTemplate:function(e){var t=this,r=t.host,i;i=n.isNumber(e)?r.getNodeFromIndex(e,0):r.getNodeFromModel(e,0),i&&((t._secondTempl&&t._secondTemplIsMicro||e.itsaeditmodel)&&i.cleanup(),i.setHTML(r._templFns.template(e)))},_setEditTemplate:function(t){var r=this,i=r.host,s,o;!t||t===""?r._editTempl=i._templFns.template:(o=r._editTemplIsMicro=h(t),o?(s=e.TemplateMicro.compile(t),r._editTempl=function(t){var n,o,u;return n=t.get&&typeof t.get=="function",!n&&i._listLazy&&(u=i.get("modelList").revive(t)),o=u||t,o.itsaeditmodel||e.use("gallery-itsaeditmodel",function(e){o.plug(e.Plugin.ITSAEditModel,r.get("configForEditModel"))}),o.itsaeditmodel?s(o.itsaeditmodel.toJSON(r.get("editmodelConfigAttrs")||o.itsaeditmodel.get("editmodelConfigAttrs"))):c}):r._editTempl=function(s){var o,u,a;return o=s.get&&typeof s.get=="function",!o&&i._listLazy&&(a=i.get("modelList").revive(s)),u=a||s,u.itsaeditmodel||e.use("gallery-itsaeditmodel",function(e){u.plug(e.Plugin.ITSAEditModel,r.get("configForEditModel"))}),u.itsaeditmodel?n.sub(t,u.itsaeditmodel.toJSON(r.get("editmodelConfigAttrs")||u.itsaeditmodel.get("editmodelConfigAttrs"))):c})},_setSecondTemplate:function(t){var r=this,i=r.host,s,o;!t||t===""?r._secondTempl=null:(o=r._secondTemplIsMicro=h(t),o?(s=e.TemplateMicro.compile(t),r._secondTempl=function(e){return s(i.getModelToJSON(e))}):r._secondTempl=function(e){return n.sub(t,i.getModelToJSON(e))})}},{NS:"itsacmtemplate",ATTRS:{editmodelConfigAttrs:{value:{},validator:function(e){return n.isObject(e)}},configForEditModel:{value:null,validator:function(e){return n.isObject(e)}},editTemplate:{value:null,validator:function(e){return typeof e=="string"},setter:"_setEditTemplate"},modelsEditable:{value:!0,lazyAdd:!1,validator:function(e){return n.isBoolean(e)}},newModelMode:{value:1,validator:function(e){return typeof e=="number"&&e>0&&e<4}},restoreOnSave:{value:!0,validator:function(e){return n.isBoolean(e)}},restoreOnSubmit:{value:!0,validator:function(e){return n.isBoolean(e)}},secondTemplate:{value:null,validator:function(e){return typeof e=="string"},setter:"_setSecondTemplate"}}})},"@VERSION@",{requires:["yui-base","node-core","node-event-delegate","base-base","base-build","model","plugin","pluginhost-base","oop","template-micro"]});
