YUI.add("gallery-itsamodelsyncpromise",function(e,t){"use strict";var n=e.Model,r=e.Object,i=e.Array,s="start",o="destroy",u="error",a="load",f="save",l=a+s,c=f+s,h=function(t){if(typeof t=="string")try{return e.JSON.parse(t)}catch(n){return this.fire(u,{error:n,response:t,src:"parse"}),{}}return t||{}};n.prototype.destroy=function(e,t){var n=this;return n.destroyPromise(e).then(function(e){t&&t.apply(null,e)},function(e){t&&t.apply(null,e)}),n},n.prototype._prevDefFnDestroy=function(e){console.log("model destroy preventdefaultFunc"),e.promiseReject(new Error("preventDefaulted"))},n.prototype._defDestroyFn=function(e){this._baseDestroy();var t=this,n=e.promiseResolve,r=e.promiseReject,s=e.options,o=e.remove||e["delete"],u,a,f;return f=function(){i.each(t.lists.concat(),function(e){e.remove(t,s)})},o?(u=function(e){var n={error:e,src:"Model.destroyPromise()",options:s};t._lazyFireErrorEvent(n),console.log("model destroy error.."),r(new Error(e))},a=function(e){f(),console.log("resoving model destroy..."),n(e)},t.syncPromise?t._syncTimeoutPromise("delete",s).then(a,u):t.sync("delete",s,function(e,t){console.log("callback delete"),e?u(e):a(t)})):(f(),console.log("model destroy about to resolve without remove.."),n()),e.promise},n.prototype.destroyPromise=function(t){var n=this,i,s,u,a;return i=new e.Promise(function(e,t){s=e,u=t}),a={promise:i,promiseResolve:s,promiseReject:u},t&&r.each(t,function(e,t){a[t]=e}),n.publishAsync(o,{defaultTargetOnly:!0,emitFacade:!0,defaultFn:n._defDestroyFn,preventedFn:n._prevDefFnDestroy}),n.fire(o,a),i},n.prototype.load=function(e,t){var n=this;return n.loadPromise(e).then(function(e){t&&t.apply(null,e)},function(e){t&&t.apply(null,e)}),n},n.prototype.loadPromise=function(t){var n=this,r;return t=t||{},r=new e.Promise(function(e,r){var i,s,o={options:t};i=function(e){o.error=e,o.src="Model.loadPromise()",n._lazyFireErrorEvent(o),r(new Error(e))},s=function(r){var i;n._loadEvent||(n._loadEvent=n.publish(a,{preventable:!1})),o.response=r,i=h(r),i.responseText&&(i=i.responseText),o.parsed=i,n.setAttrs(i,t),n.changed={},n.fire(a,o),e(r)},n.syncPromise?n._syncTimeoutPromise("read",t).then(s,i):n.sync("read",t,function(e,t){e?i(e):s(t)})}),n.fire(l,{target:n,promise:r,options:t}),r},n.prototype.publishAsync=function(t,n){var r=this,i=this.publish(t,n);i._firing=new e.Promise(function(e){e()}),i.fire=function(t){var n=e.Array(arguments,0,!0);i._firing=i._firing.then(function(){i.details=n;var s=i._subscribers,o=[],u,a,f;o.push.apply(o,t),u=i._createFacade(o);if(s)for(a=0,f=s.length;a<f;++a)s[a].fn.call(s[a].context,u);return u.prevented?e.bind(i.preventedFn,r,u)().then(null,function(e){return!1}):e.bind(i.defaultFn,r,u)().then(function(e){s=i._afters;for(a=0,f=s.length;a<f;++a)s[a].fn.call(s[a].context,e)}).then(null,function(e){return!1})},function(e){var t={error:e,src:"Model.publishAsync()"};r._lazyFireErrorEvent(t)})},i._fire=function(e){return i.fire(e[0])}},n.prototype.save=function(e,t){var n=this;return n.savePromise(e).then(function(e){t&&t.apply(null,e)},function(e){t&&t.apply(null,e)}),n},n.prototype.savePromise=function(t){var n=this,r=n.isNew()?"create":"update",i;return t=t||{},i=new e.Promise(function(e,i){var s,o,u={options:t,method:r};n._validate(n.toJSON(),function(a){a?(u.error=a,u.src="Model.savePromise() - validate",n._lazyFireErrorEvent(u),i(new Error(a))):(s=function(e){u.error=e,u.src="Model.savePromise()",n._lazyFireErrorEvent(u),i(new Error(e))},o=function(r){var i;n._saveEvent||(n._saveEvent=n.publish(f,{preventable:!1})),u.response=r,i=h(r),i.responseText&&(i=i.responseText),u.parsed=i,n.setAttrs(i,t),n.changed={},n.fire(f,u),e(r)},n.syncPromise?n._syncTimeoutPromise(r,t).then(o,s):n.sync(r,t,function(e,t){e?s(e):o(t)}))})}),n.fire(c,{target:n,promise:i,options:t,method:r}),i},n.prototype._lazyFireErrorEvent=function(e){var t=this;t._errorEvent||(t._errorEvent=t.publish(u,{broadcast:1})),t.fire(u,e)},n.prototype._syncTimeoutPromise=function(t,n){var r=this,i;return i=r.syncPromise(t,n),i instanceof e.Promise||(i=new e.Promise(function(e,n){var r="syncPromise is rejected --> "+t+" not defined as a Promise inside syncPromise()";n(new Error(r))})),i}},"@VERSION@",{requires:["yui-base","base-base","base-build","node-base","json-parse","promise","model"]});
