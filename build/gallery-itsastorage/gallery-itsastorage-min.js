YUI.add("gallery-itsastorage",function(e,t){"use strict";function N(){N.superclass.constructor.apply(this,arguments)}var n=e.config.doc,r=e.config.win,i=e.JSON,s=e.namespace("ITSAStorageLite"),o=function(e,t){e.setTime(e.getTime()+6e4*t)},u="yui_itsastorage_lite",a="YUI ITSAStorageLite data",f=1048576,l="1.0",c="ready",h=0,p=1,d=2,v=3,m=4,g="yui_itsastorage_lite",y="data",b=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/,w={},E,S;try{r.localStorage?S=p:r.globalStorage?S=d:r.openDatabase&&navigator.userAgent.indexOf("Chrome")===-1?S=v:e.UA.ie>=5?S=m:S=h}catch(x){S=h}e.StorageFullError=function(t){e.StorageFullError.superclass.constructor.call(t),this.name="StorageFullError",this.message=t||"Maximum storage capacity reached",e.UA.ie&&(this.description=this.message)},e.extend(e.StorageFullError,Error),e.augment(s,e.EventTarget,!0,null,{emitFacade:!0,prefix:"storage-lite",preventable:!1}),s.publish(c,{fireOnce:!0,emitFacade:!0}),e.mix(s,{clear:function(){},getItem:function(){return null},length:function(){return 0},removeItem:function(){},setItem:function(){}}),S===p||S===d?(e.mix(s,{length:function(){return E.length},removeItem:function(e){E.removeItem(e)},setItem:function(e,t,n){E.setItem(e,n?i.stringify(t):t)}},!0),S===p?(E=r.localStorage,e.Node.DOM_EVENTS.pageshow=1,e.on("pageshow",function(){E=r.localStorage}),e.mix(s,{clear:function(){E.clear()},getItem:function(e,t){try{return t?i.parse(E.getItem(e),b):E.getItem(e)}catch(n){return null}}},!0)):S===d&&(E=r.globalStorage[r.location.hostname],e.mix(s,{clear:function(){for(var e in E)E.hasOwnProperty(e)&&(E.removeItem(e),delete E[e])},getItem:function(e,t){try{return t?i.parse(E[e].value,b):E[e].value}catch(n){return null}}},!0)),s.fire(c)):S===v||S===m?(e.mix(s,{clear:function(){w={},s._save()},getItem:function(e){return w.hasOwnProperty(e)?w[e]:null},length:function(){var e=0,t;for(t in w)w.hasOwnProperty(t)&&(e+=1);return e},removeItem:function(e){delete w[e],s._save()},setItem:function(e,t){w[e]=t,s._save()}},!0),S===v?(E=r.openDatabase(u,l,a,f),e.mix(s,{_save:function(){E.transaction(function(e){e.executeSql("REPLACE INTO "+u+" (name, value) VALUES ('data', ?)",[i.stringify(w)])})}},!0),E.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS "+u+"(name TEXT PRIMARY KEY, value TEXT NOT NULL)"),e.executeSql("SELECT value FROM "+u+" WHERE name = 'data'",[],function(e,t){if(t.rows.length)try{w=i.parse(t.rows.item(0).value,b)}catch(n){w={}}s.fire(c)})})):S===m&&(E=n.createElement("span"),E.addBehavior("#default#userData"),e.mix(s,{_save:function(){var t=i.stringify(w);n.body.appendChild(E);try{E.setAttribute(y,t),E.save(g)}catch(r){throw new e.StorageFullError}finally{n.body.removeChild(E)}}},!0),e.on("domready",function(){n.body.appendChild(E),E.load(g);try{w=i.parse(E.getAttribute(y)||"{}",b)}catch(e){w={}}finally{n.body.removeChild(E)}s.fire(c)}))):s.fire(c,{noop:!0});var T=e.ITSAStorageLite;N.NAME="itsastorage",e.ITSAStorageClass=e.extend(N,e.Base),N.prototype.initializer=function(){var t=this;t._ready=new e.Promise(function(e,t){T.on("storage-lite:ready",function(n){n.noop?t("noop"):e()})})},N.prototype.clear=function(){var e=this;return e._ready.then(function(){T.clear()})},N.prototype.getItem=function(e){var t=this;return t._ready.then(function(){var t=T.getItem(e,!0),n;t&&t.expire&&(n=(new Date).getTime(),t.expire<n&&(T.removeItem(e),t=null));if(!t)throw new Error("item not found");return t.value})},N.prototype.length=function(){var e=this;return e._ready.then(function(){return T.length()})},N.prototype.removeItem=function(e){var t=this;return t._ready.then(function(){T.removeItem(e)})},N.prototype.setItem=function(e,t,n){var r=this,i;return r._ready.then(function(){var r={value:t};typeof n=="number"&&(i=n,n=new Date,o(n,i)),n&&(r.expire=n.getTime()),T.setItem(e,r,!0)})},e.Global.ITSAStorage||(e.Global.ITSAStorage=new N),e.ITSAStorage=e.Global.ITSAStorage},"@VERSION@",{requires:["yui-base","base-base","node","promise","gallery-itsautils"]});
