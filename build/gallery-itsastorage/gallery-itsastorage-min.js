YUI.add("gallery-itsastorage",function(e,t){"use strict";function C(){C.superclass.constructor.apply(this,arguments)}var n=e.config.doc,r=e.config.win,i=e.JSON,s=e.namespace("ITSAStorageLite"),o=function(e,t){e.setTime(e.getTime()+6e4*t)},u="yui_itsastorage_lite",a="YUI ITSAStorageLite data",f=1048576,l="1.0",c="ready",h=0,p=1,d=2,v=3,m=4,g="yui_itsastorage_lite",y="data",b=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z/,w=function(e,t){return b.test(t)?new Date(t):t},E={},S,x;try{r.localStorage?x=p:r.globalStorage?x=d:r.openDatabase&&navigator.userAgent.indexOf("Chrome")===-1?x=v:e.UA.ie>=5?x=m:x=h}catch(T){x=h}e.StorageFullError=function(t){e.StorageFullError.superclass.constructor.call(t),this.name="StorageFullError",this.message=t||"Maximum storage capacity reached",e.UA.ie&&(this.description=this.message)},e.extend(e.StorageFullError,Error),e.augment(s,e.EventTarget,!0,null,{emitFacade:!0,prefix:"storage-lite",preventable:!1}),s.publish(c,{fireOnce:!0,emitFacade:!0}),e.mix(s,{clear:function(){},getItem:function(){return null},length:function(){return 0},removeItem:function(){},setItem:function(){}}),x===p||x===d?(e.mix(s,{length:function(){return S.length},removeItem:function(e){S.removeItem(e)},setItem:function(e,t,n){S.setItem(e,n?i.stringify(t):t)}},!0),x===p?(S=r.localStorage,e.Node.DOM_EVENTS.pageshow=1,e.on("pageshow",function(){S=r.localStorage}),e.mix(s,{clear:function(){S.clear()},getItem:function(e,t){try{return t?i.parse(S.getItem(e),w):S.getItem(e)}catch(n){return null}}},!0)):x===d&&(S=r.globalStorage[r.location.hostname],e.mix(s,{clear:function(){for(var e in S)S.hasOwnProperty(e)&&(S.removeItem(e),delete S[e])},getItem:function(e,t){try{return t?i.parse(S[e].value,w):S[e].value}catch(n){return null}}},!0)),s.fire(c)):x===v||x===m?(e.mix(s,{clear:function(){E={},s._save()},getItem:function(e){return E.hasOwnProperty(e)?E[e]:null},length:function(){var e=0,t;for(t in E)E.hasOwnProperty(t)&&(e+=1);return e},removeItem:function(e){delete E[e],s._save()},setItem:function(e,t){E[e]=t,s._save()}},!0),x===v?(S=r.openDatabase(u,l,a,f),e.mix(s,{_save:function(){S.transaction(function(e){e.executeSql("REPLACE INTO "+u+" (name, value) VALUES ('data', ?)",[i.stringify(E)])})}},!0),S.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS "+u+"(name TEXT PRIMARY KEY, value TEXT NOT NULL)"),e.executeSql("SELECT value FROM "+u+" WHERE name = 'data'",[],function(e,t){if(t.rows.length)try{E=i.parse(t.rows.item(0).value,w)}catch(n){E={}}s.fire(c)})})):x===m&&(S=n.createElement("span"),S.addBehavior("#default#userData"),e.mix(s,{_save:function(){var t=i.stringify(E);n.body.appendChild(S);try{S.setAttribute(y,t),S.save(g)}catch(r){throw new e.StorageFullError}finally{n.body.removeChild(S)}}},!0),e.on("domready",function(){n.body.appendChild(S),S.load(g);try{E=i.parse(S.getAttribute(y)||"{}",w)}catch(e){E={}}finally{n.body.removeChild(S)}s.fire(c)}))):s.fire(c,{noop:!0});var N=e.ITSAStorageLite;C.NAME="itsastorage",e.ITSAStorageClass=e.extend(C,e.Base),C.prototype.initializer=function(){var t=this;t._ready=new e.Promise(function(e,t){N.on("storage-lite:ready",function(n){n.noop?t("noop"):e()})})},C.prototype.clear=function(){var e=this;return e._ready.then(function(){N.clear()})},C.prototype.getItem=function(e){var t=this;return t._ready.then(function(){var t=N.getItem(e,!0),n;t&&t.expire&&(n=(new Date).getTime(),t.expire<n&&(N.removeItem(e),t=null));if(!t)throw new Error("item not found");return t.value})},C.prototype.length=function(){var e=this;return e._ready.then(function(){return N.length()})},C.prototype.removeItem=function(e){var t=this;return t._ready.then(function(){N.removeItem(e)})},C.prototype.setItem=function(e,t,n){var r=this,i;return r._ready.then(function(){var r={value:t};typeof n=="number"&&(i=n,n=new Date,o(n,i)),n&&(r.expire=n.getTime()),N.setItem(e,r,!0)})},e.Global.ITSAStorage||(e.Global.ITSAStorage=new C),e.ITSAStorage=e.Global.ITSAStorage},"@VERSION@",{requires:["yui-base","base-base","node","promise","json","gallery-itsautils"]});
