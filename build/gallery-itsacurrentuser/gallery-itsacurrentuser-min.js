YUI.add("gallery-itsacurrentuser",function(e,t){"use strict";function c(){c.superclass.constructor.apply(this,arguments)}var n=e.Array,r="logged",i=r+"in",s=r+"out",o="string",u=60,a=256320,f="currentuser",l=function(e,t){e.setTime(e.getTime()+6e4*t)};c.NAME="itsacurrentuser",e.ITSACurrentUserClass=e.extend(c,e.Model),c.prototype.username=null,c.prototype.password=null,c.prototype.remember=null,c.prototype._expire=0,c.prototype.expireAfter=u,c.prototype.displayname=null,c.prototype.messageLoggedin=null,c.prototype._isLoggedin=!1,c.prototype.initializer=function(){var t=this,n=t._eventhandlers=[];n.push(e.after(i,function(e){var n=e.username,r=e.password,i=e.remember||!1,s=e.expireAfter,u=e.displayname,a=e.messageLoggedin,f=e.userdata;typeof n===o&&typeof r===o&&n.length>0&&r.length>0?t.dologin(n,r,i,s,u,a,f):t.dologout()})),n.push(e.after(s,e.bind(t.dologout,t))),t._isReady=new e.Promise(function(e){t._loadUser().then(e,e)})},c.prototype.dologin=function(e,t,n,r,i,s,o){var f=this,c;f.username=e,f.password=t,f.remember=n,f.displayname=i,f.messageLoggedin=s,f.setAttrs(o),f.expireAfter=r||(n?a:u),f._isLoggedin=!0,c=new Date,l(c,f.expireAfter),f._expire=c.getTime(),f._saveUser(c)},c.prototype.dologout=function(){var e=this;return e.reset(),e.set("id",undefined),e.username=null,e.password=null,e.remember=!1,e.displayname=null,e.messageLoggedin=null,e._expire=0,e.expireAfter=u,e._isLoggedin=!1,e._clearUser()},c.prototype.getCurrent=function(){var e=this,t;return e.isReady().then(function(){if(!e._isLoggedin)throw new Error("not loggedin");return t=new Date,l(t,e.expireAfter),e._expire=t.getTime(),e._saveUser(t),{username:e.username,password:e.password,remember:e.remember,expire:t,displayname:e.displayname,messageLoggedin:e.messageLoggedin,userdata:e.toJSON()}})},c.prototype.isReady=function(){return this._isReady},c.prototype.destructor=function(){this._clearEventhandlers()},c.prototype._clearEventhandlers=function(){n.each(this._eventhandlers,function(e){e.detach()})},c.prototype._clearUser=function(){return e.ITSAStorage.removeItem(f)},c.prototype._loadUser=function(){var t=this;return e.ITSAStorage.getItem(f).then(function(e){t.username=e.username,t.password=e.password,t.remember=e.remember,t.displayname=e.displayname,t.messageLoggedin=e.messageLoggedin,t.setAttrs(e.userdata),t._isLoggedin=!0},function(){return t.dologout()})},c.prototype._saveUser=function(t){var n=this,r={username:n.username,password:n.password,remember:n.remember,displayname:n.displayname,messageLoggedin:n.messageLoggedin,userdata:n.toJSON()};return e.ITSAStorage.setItem(f,r,t)},e.ITSACurrentUser=new e.ITSACurrentUserClass},"@VERSION@",{requires:["yui-base","promise","gallery-itsastorage"]});
