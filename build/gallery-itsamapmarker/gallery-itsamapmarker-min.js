YUI.add("gallery-itsamapmarker",function(e,t){"use strict";function Y(){Y.superclass.constructor.apply(this,arguments)}var n=e.Lang,r=e.Node,i=e.Array,s=e.Object,o=60,u="markers",a="Change",f="Template",l="marker",c="Visible",h="Header",p="Body",d="Footer",v="Classname",m="ColorClass",g="HTML",y="clientId",b="contentBox",w="px",E="hidden",S="walkThroughPopups",x="lat",T="lon",N="extraZ",C="itsa-",k=C+"mobile-walkthrough-"+E,L="details",A="DetailsClosable",O=C+"marker",M=O+L,_=O+"balloon",D=L+"-visible",P=L+"-outofrange",H=C+"markerheader"+L,B=C+"markerbody"+L,j=C+"markerfooter"+L,F=l+"ColorClass",I=l+"Size",q="offsetWidth",R="offsetHeight",U="markerMargin",z="destroyed",W="autoNumber",X="markerNumber",V="itsa-all-markers-hidden",$='<i class="itsaicon-dialog-error"></i>',J='<button class="pure-button itsa-closedetails" data-markerid="{clientid}">'+$+"</button>",K='<div data-id="{mapid}_{clientid}" class="{colorclass} itsa-mapmarker {classname}" {hidden}style="z-index:{zindex}"><div class="itsa-markerballoon {markersize}" data-markerid="{clientid}">{markerhtml}</div><div class="itsa-markerpin"></div><div class="'+L+"-fade "+P+" "+M+'">'+'<div class="'+H+'">{header}{closebutton}</div>'+'<div class="'+B+'">{body}</div>'+'<div class="'+j+'">{footer}</div>'+'<div class="'+C+L+'-pin">'+"</div>"+"</div>"+"</div>",Q='<div id="map_markers_{mapid}" class="{markersize} itsa-mapmarker-container {colorclass}"></div>',G='<div id="movewalkthrough_{mapid}" class="itsa-mobile-walkthrough"><button class="pure-button itsabutton-halfoval itsabutton-bordered itsabutton-onlyicon itsa-walkthrough-nav"><i class="itsaicon-arrows-left"></i></button><button class="pure-button itsabutton-halfoval itsabutton-bordered itsabutton-onlyicon itsa-walkthrough-nav itsa-walknext"><i class="itsaicon-arrows-right"></i></button></div>';Y.NAME="itsamapmarker",Y.NS="itsamapmarker",Y.ATTRS={autoNumber:{value:!1,validator:function(e){return typeof e=="boolean"}},detailsOnClick:{value:!1,validator:function(e){return typeof e=="boolean"||e==="multiple"}},markerDetailsClosable:{value:!0,validator:function(e){return typeof e=="boolean"}},markers:{value:null,validator:function(t){return t===null||t instanceof e.ModelList}},markerColorClass:{value:null,validator:function(e){return e===null||typeof e=="string"}},markerMargin:{value:80,validator:function(e){return typeof e=="number"}},markerSize:{value:null,validator:function(e){return e===null||e==="small"||e==="large"||e==="extralarge"}},walkThroughPopups:{value:!1,validator:function(e){return typeof e=="boolean"}}},e.Plugin.ITSAMapMarker=e.extend(Y,e.Plugin.Base),Y.prototype.initializer=function(){var t=this,n;e.use("gallerycss-itsa-dialog"),t._renderedPromise=new e.Promise(function(e){t._resolveHandler=e}),n=t.host=t.get("host"),t._mobile=e.UA.mobile!==null,t._currentPopup=[],n.renderPromise().then(e.bind(t._renderer,t))},Y.prototype._renderer=function(){var e=this;e.renderUI().then(function(){e.bindUI(),e.get(W)&&e._calcPosMarkers(),e.syncUI(!0),e._resolveHandler()})},Y.prototype.renderUI=function(){var t=this,i=t.host,s=i.mapid,o,u,a=t.get(F)||"",f=t.get(I)||"",l,c;return r.availablePromise("#map_"+s,1e4).then(function(){l=e.one("#map_"+s),o=t._markerlayer=r.create(n.sub(Q,{mapid:s,colorclass:a,markersize:f})),u=t.host.currentZoomedMap(),o.setStyle("left",u.getStyle("left")),o.setStyle("top",u.getStyle("top")),l.prepend(o),t._mobile&&(c=i.get("contentBox"),c.toggleClass(k,!t.get(S)),c.prepend(n.sub(G,{mapid:s})),e.use("gallerycss-itsa-base","gallerycss-itsa-arrows"))})},Y.prototype.bindUI=function(){var t=this,n=t.get(u),r=t._markerlayer,i=t.host.get(b),o;o=t._eventhandlers=[],n&&n.addTarget(t),o.push(t.after(u+a,function(e){var n=e.prevVal,r=e.newVal,i=t._centerview,s=t._markersinview;t._currentPopup=[],n&&(n.removeTarget(t),r||t._clearMarkers()),r&&(t.get(W)&&t._calcPosMarkers(),t.syncUI(),r.addTarget(t),i&&t.centerView(i),s&&!i&&t.markersInView(s))})),o.push(t.after([F+a,I+a],function(e){var n=t._markerlayer,r=e.newVal,i=e.prevVal;i&&n.removeClass(i),r&&n.addClass(r)})),o.push(t.after("*:add",function(e){var n=t._centerview,r=t._markersinview;t.get(W)&&t._calcPosMarkers(),t._addMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r)})),o.push(t.after("*:change",function(n){var r=n.target,i=n.changed,o=t._centerview,u=t._markersinview,a,f;r instanceof e.ITSAMarkerModel&&(s.some(i,function(t,n){var r=n===x||n===T,i=e.JSON.stringify(t.newVal)!==e.JSON.stringify(t.prevVal);return i&&(a=i,!r&&(f=!0)),i&&f}),a&&(t.get(W)&&t._calcPosMarkers(),t.syncMarker(r,{positiononly:!f}),o&&t.centerView(o),u&&!o&&t.markersInView(u)))})),o.push(t.after("*:remove",function(e){var n=t._centerview,r=t._markersinview;t._removeMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r),t.get(W)&&(t._calcPosMarkers(),t.syncUI())})),o.push(t.after("*:reset",function(e){var n=t._centerview,r=t._markersinview;e.src==="reset"&&(t._currentPopup=[],t.get(W)&&t._calcPosMarkers(),t.syncUI(),n&&t.centerView(n),r&&!n&&t.markersInView(r))})),o.push(r.delegate("tap",function(e){var n=e.currentTarget,r=n.getAttribute("data-markerid"),i=r&&t.get(u).getByClientId(r);i&&t.hidePopup(i)},".itsa-closedetails")),o.push(r.delegate("tap",function(e){var n=e.currentTarget,r=t.get("detailsOnClick"),i=r&&n.getAttribute("data-markerid"),s,o,a,f;i&&(s=t.get(u).getByClientId(i),o=t.getMarkerNode(s),a=o&&o.one("."+M),a&&(f=a.hasClass(D),f?t.hidePopup(s):t.showPopup(s,r===!0)))},".itsa-markerballoon")),o.push(e.on("keydown",function(e){var n=e.keyCode,r=n===37||n===40,i=n===38||n===39,s=n===27;s&&t.getCurrentPopupMarkers().length>0&&t.hidePopup(),t.get(S)&&((r||i)&&e.preventDefault(),r&&t.showPreviousPopup(),i&&t.showNextPopup())})),t._mobile&&(o.push(i.delegate("tap",function(e){var n;t.get(S)&&(n=e.currentTarget.hasClass("itsa-walknext"),n?t.showNextPopup():t.showPreviousPopup())},".itsa-walkthrough-nav")),o.push(t.after(S+a,function(e){i.toggleClass(k,!e.newVal)})))},Y.prototype.centerView=function(t){var r=this;r.readyPromise(
).then(function(){var s=r.host,o=t&&t.markers,a=t&&t.zoomin,f=t&&t.zoomout,l=t&&t.continuous,c=r.get(u),h=r.get(U),p,d,v,m,g,y,w,E,S,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,W;E=function(e){var t,n;e&&(w||!e.get(z))&&(t=w?e[x]:e.get(x),n=w?e[T]:e.get(T),(!v||t<v)&&(v=t),(!m||t>m)&&(m=t),(!g||n<g)&&(g=n),(!y||n>y)&&(y=n))},o||(o=c),o instanceof e.ITSAMarkerModel?(p=o.get(x),d=o.get(T)):n.isArray(o)?(w=c instanceof e.LazyModelList,o.length===0?(o=c,o.each(E)):i.each(o,E)):o instanceof e.ModelList?(w=c instanceof e.LazyModelList,o.each(E)):typeof o=="object"&&(p=o[x],d=o[T]),v&&(p=(v+m)/2,d=(g+y)/2);if(p){s.gotoPos(p,d);if(a||f){g||(g=y=d,v=m=p),D=S=s.getZoomLevel(),P=s.getMaxZoomLevel(),N=s.get(b),C=N.get(q),k=N.get(R),L=C-2*h,A=k-2*h,H=s._getX(g,S),B=s._getX(y,S),j=s._getY(v,S),F=s._getY(m,S),O=Math.abs(B-H),M=Math.abs(F-j),I=O/L,W=M/A,_=Math.max(I,W);if(a){typeof a=="number"&&a<P&&(P=a);while(_<.5&&D<P)_=2*_,D++}else if(f)while(_>1&&D>0)_/=2,D--;D!==S&&s.zoom(D),e.later(300,r,r._shiftPopup)}}t.fromInternal||(l?r._centerview={markers:o,zoomin:a,zoomout:f,fromInternal:!0}:r.stopContCenterView())})},Y.prototype.getCurrentPopupMarkers=function(){return this._currentPopup},Y.prototype.getMarkerNode=function(t){var n=this,r=t instanceof e.ITSAMarkerModel?t.get(y):t[y];return n._markerlayer&&n._markerlayer.one('[data-id="'+n.host.mapid+"_"+r+'"]')},Y.prototype.hidePopup=function(t){var r=this;t||(t=r.get(u).toArray()),n.isArray(t)?i.each(t,e.bind(r._hidePopup,r)):(t instanceof e.ITSAMarkerModel||typeof t=="object")&&r._hidePopup(t)},Y.prototype.markerOnTop=function(e){var t=this,n=t._getHighestZ()+1,r=t.getMarkerNode(e);e._zIndex=n,r&&r.setStyle("zIndex",n)},Y.prototype.markerRestoreZ=function(e){var t=this,n=t.getMarkerNode(e);e._zIndex=null,n&&n.setStyle("zIndex",e._originalZindex)},Y.prototype.markersInView=function(t){var r=this;r.readyPromise().then(function(){var s=r.host,o=t&&t.markers,a=t&&t.zoomin,f=t&&t.continuous,l=r.get(u),c=r.get(U),h,p,d,v,m,g,y,w,E,S,N,C,k,L,A,O,M,_,D,P,H,B;g=function(e){var t,n;e&&(m||!e.get(z))&&(t=m?e[x]:e.get(x),n=m?e[T]:e.get(T),(!h||t<h)&&(h=t),(!p||t>p)&&(p=t),(!d||n<d)&&(d=n),(!v||n>v)&&(v=n))},P=function(e){var t,n,r,i,o,u;return t=s._getX(_,e),n=s._getY(D,e),r=t-E+c,o=t+E-c,i=n-S+c,u=n+S-c,L=s._getX(d,e),A=s._getX(v,e),O=s._getY(h,e),M=s._getY(p,e),L>r&&L<o&&A>r&&A<o&&O>i&&O<u&&M>i&&M<u},o||(o=l),o instanceof e.ITSAMarkerModel?(h=p=o.get(x),d=v=o.get(T)):n.isArray(o)?(m=l instanceof e.LazyModelList,o.length===0?(o=l,o.each(g)):i.each(o,g)):o instanceof e.ModelList?(m=l instanceof e.LazyModelList,o.each(g)):typeof o=="object"&&(h=p=o[x],d=v=o[T]);if(h){C=y=s.getZoomLevel(),k=s.getMaxZoomLevel(),w=s.get(b),H=w.get(q),B=w.get(R),E=Math.round(H/2),S=Math.round(B/2),_=s.getLon(),D=s.getLat();while(!P(C)&&C>0)N=!0,C--;if(a&&!N){typeof a=="number"&&a<k&&(k=a);while(P(C+1)&&C+1<k)C++}C!==y&&s.zoom(C),e.later(300,r,r._shiftPopup)}t.fromInternal||(f?r._markersinview={markers:o,zoomin:a,fromInternal:!0}:r.stopContMarkersInView())})},Y.promiseBeforeReady=function(){return this._renderedPromise},Y.prototype.showNextPopup=function(){var e=this,t=e._currentPopup[0],n=0,r,i,s,o;r=e.get(u),i=r._isYUIModelList,t&&(n=r.indexOf(t),o=i?r.size():r.length,n===-1||n===o-1?n=0:n++),s=i?r.item(n):r[n],e.showPopup(s,!0)},Y.prototype.showPopup=function(t,r){var s=this,o=n.isArray(t),a=!o&&(t instanceof e.ITSAMarkerModel||typeof t=="object"),f,l;t&&r&&(f=s.get(u).toArray(),o?i.each(t,function(e){l=i.indexOf(f,e),l===-1||f.splice(l,1)}):a&&(l=i.indexOf(f,t),l===-1||f.splice(l,1)),s.hidePopup(f)),t||(t=s.get(u).toArray()),o?i.each(t,e.bind(s._showPopup,s)):a&&s._showPopup(t),e.later(300,s,s._shiftPopup)},Y.prototype.showPreviousPopup=function(){var e=this,t=e._currentPopup[0],n,r,i,s,o;r=e.get(u),i=r._isYUIModelList,o=i?r.size():r.length,t?(n=r.indexOf(t),n===-1||n===0?n=o-1:n--):n=o-1,s=i?r.item(n):r[n],e.showPopup(s,!0)},Y.prototype.stopContCenterView=function(){this._centerview=null},Y.prototype.stopContMarkersInView=function(){this._markersinview=null},Y.prototype.repositionMarkers=function(){var e=this,t=e.get(u);e._markerlayer&&e._markerlayer.addClass(V),t.each(function(t){e.syncMarker(t,{positiononly:!0})}),e._markerlayer&&e._markerlayer.removeClass(V)},Y.prototype.syncMarker=function(t,n){var r=this,i=r.getMarkerNode(t),s=r.get(W),o,u=n&&n.positiononly;i&&(t instanceof e.ITSAMarkerModel?r._syncMarkerNode(i,t.get(x),t.get(T),u||t.get(y),u||t.get(l+h+f),u||t.get(l+p+f),u||t.get(l+d+f),u||t.get(l+v),u||t.get(l+m),u||t.get(I),u||t.get(l+g)||(s?t.get(X):""),u||t.get(l+A),u||t.get(l+c),u?null:t.toJSON()):(o=t[l+c],r._syncMarkerNode(i,t[x],t[T],u||t[y],u||t[l+h+f],u||t[l+p+f],u||t[l+d+f],u||t[l+v],u||t[l+m],u||t[I],u||t[l+g]||(s?t[X]:""),u||t[l+A],u||typeof o=="boolean"?o:!0,u?null:t)))},Y.prototype.syncUI=function(t){var n=this,r=n.get(u),i=n.get(W),s,o;s=function(e,t){var r=e.get(N)+t+1;e._originalZindex=r,n._renderMarker(e.toJSON(),e.get(y),e.get(l+h+f),e.get(l+p+f),e.get(l+d+f),e.get(l+v),e.get(l+m),e.get(I),e.get(l+g)||(i?e.get(X):""),e.get(l+A),e.get(l+c),r)},o=function(e,t){var r=(e[N]||0)+t+1,s=e[l+c];e._originalZindex=r,n._renderMarker(e,e[y],e[l+h+f],e[l+p+f],e[l+d+f],e[l+v],e[l+m],e[I],e[l+g]||(i?e[X]:""),e[l+A],typeof s=="boolean"?s:!0,r)},t||n._clearMarkers(),n._markerlayer&&n._markerlayer.addClass(V),r.each(r instanceof e.LazyModelList?o:s),n._markerlayer&&n._markerlayer.removeClass(V)},Y.prototype.destructor=function(){var e=this,t=e.get(u);t&&t.removeTarget(e),e._markerlayer&&e._markerlayer.destroy(!0),e._clearEventhandlers()},Y.prototype._addMarker=function(t){var n=this,r=n._getHighestZ(!0)+1,i=n.get(W),s;t instanceof e.ITSAMarkerModel?(t._originalZindex=t.get(N)+r,n._renderMarker(t.toJSON(),t.get(y),t.get(l+h+f),t.get(l+p+f),t.get(l+d+f),t.get(l+v),t.get(l+m),t.get(I),t.get(l+g)||(i?t.get(X):""),t.get(l+A),t.get(l+c),r)):(t._originalZindex=(t[N]||0)+r,s=t[l+c],n._renderMarker(t,t[y],t[l+h+f],t[l+p+f],t[l+d+f],t[l+v],t[l+m],t[I],t[l+g]||(i?t[X]:""),t[l+A],typeof s=="boolean"?s
:!0,r))},Y.prototype._calcPosMarkers=function(){var e=this,t=e.get(u),n=t.revive;e.get(u).each(function(e,t){n?e[X]=t+1:e.set(X,t+1,{silent:!0})})},Y.prototype._clearEventhandlers=function(){i.each(this._eventhandlers,function(e){e.detach()})},Y.prototype._clearMarkers=function(){var e=this._markerlayer;e.get("childNodes").destroy(!0),e.empty()},Y.prototype._getHighestZ=function(t){var n=this,r=n.get(u),i=0;return r.each(function(n){var r=n instanceof e.ITSAMarkerModel,s=t&&(r?n.get(N):n[N])||0,o=t?n._originalZindex-s||1:n._zIndex||n._originalZindex||1;o>i&&(i=o)}),i},Y.prototype._shiftPopup=function(){var e=this,t=e.host.get(b),n=t.getX(),r=n+t.get(q),s=t.getY(),u=s+t.get(R),a=0,f=0,l=0,c=0,h,p;i.each(e._currentPopup,function(t){var i=e.getMarkerNode(t),h,p,d,v,m,g;i&&(p=i.one("."+M),h=i.one("."+_),d=n+h.get(q)+o-p.getX(),v=p.getX()+p.get(q)-r,m=s-p.getY(),g=p.getY()+p.get(R)-u,d>a&&(a=d),v>f&&(f=v),m>l&&(l=m),g>c&&(c=g))}),h=f===0?-a:f,p=c===0?-l:c,e.host._moveMap(h,p)},Y.prototype._hidePopup=function(t){var n=this,r=n.getMarkerNode(t),s,o;r&&(s=r.one("."+M),s.removeClass(D),r.setStyle("zIndex",t._originalZindex),o=i.indexOf(n._currentPopup,t),o!==-1&&n._currentPopup.splice(o,1),e.later(200,null,function(){s.addClass(P)}))},Y.prototype._removeMarker=function(e){var t=this,n=t.getMarkerNode(e),r=i.indexOf(t._currentPopup,e);r!==-1&&t._currentPopup.splice(r,1),n&&n.remove(!0)},Y.prototype._renderMarker=function(e,t,i,s,o,u,a,f,c,h,p,d){var v=this,m=typeof h=="boolean"?h:v.get(l+A),g,y,b;b=r.create(n.sub(K,{mapid:v.host.mapid,clientid:t,classname:u||"",colorclass:a||"",markersize:f||"",markerhtml:c,closebutton:m?n.sub(J,{clientid:t}):"",header:i?n.sub(i,e):"",body:s?n.sub(s,e):"",footer:o?n.sub(o,e):"",left:g,top:y,hidden:p?"":E+'="'+E+'" ',zindex:d})),v._markerlayer&&v._markerlayer.append(b),v._syncMarkerNode(b,e[x],e[T])},Y.prototype._showPopup=function(e,t){var n=this,r=n.getMarkerNode(e),i=n._getHighestZ()+1,s;typeof t=="boolean"&&t&&n.hidePopup(),r&&(s=r.one("."+M),s.removeClass(P),s.addClass(D),r.setStyle("zIndex",i),n._currentPopup.push(e))},Y.prototype._syncMarkerNode=function(e,t,r,i,s,o,u,a,f,c,h,p,d,v){var m=this,g=m.host,y=typeof p=="boolean"?p:m.get(l+A),b,S,x,T,N,C,k;x=g.currentZoomLevel,b=g._getX(r,x),S=g._getY(t,x),b-=Math.round(e.get(q)/2),S-=Math.round(e.get(R)/2)+e.one(".itsa-markerpin").get(R),e.setStyle("left",b+w),e.setStyle("top",S+w),v&&(T=e.one("."+H),N=e.one("."+B),C=e.one("."+j),k=e.one(".itsa-markerballoon"),T.get("childNodes").destroy(!0),N.get("childNodes").destroy(!0),C.get("childNodes").destroy(!0),k.get("childNodes").destroy(!0),T.setHTML((s?n.sub(s,v):"")+(y?n.sub(J,{clientid:i}):"")),N.setHTML(o?n.sub(o,v):""),C.setHTML(u?n.sub(u,v):""),e.setAttribute("class",(c?c+" ":"")+(f||"")+" itsa-mapmarker "+(a||"")),k.setHTML(h),d?e.removeAttribute(E):e.setAttribute(E,E))}},"@VERSION@",{requires:["yui-base","event-tap","oop","model-list","lazy-model-list","plugin","node-core","node-style","node-screen","json-stringify","promise","gallerycss-itsa-base","gallery-itsanodepromise","gallery-itsamarkermodel","gallery-itsapluginpromise","gallery-itsawidgetrenderpromise"],skinnable:!0});
