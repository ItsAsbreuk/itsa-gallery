YUI.add("gallery-itsamapmarker",function(e,t){"use strict";function P(){P.superclass.constructor.apply(this,arguments)}var n=256,r=e.Lang,i=e.Node,s=e.Array,o=e.Object,u="markers",a="Change",f="template",l="marker",c="Visible",h="Header",p="Body",d="Footer",v="Classname",m="ColorClass",g="HTML",y="clientId",b="DATA_",w=b+"header",E=b+"body",S=b+"footer",x="px",T="hidden",N="lat",C="lon",k=l+"ColorClass",L=l+"Size",A="offsetWidth",O="offsetHeight",M="itsa-all-markers-hidden",_='<div data-id="{mapid}_{clientid}" class="{colorclass} itsa-mapmarker {classname}" {hidden}style="z-index:{zindex}"><div class="itsa-markerballoon {markersize}">{markerhtml}</div><div class="itsa-markerpin"></div><div class="itsa-markerdetails"><div class="itsa-markerheaderdetails">{header}</div><div class="itsa-markerbodydetails">{body}</div><div class="itsa-markerfooterdetails">{footer}</div></div></div>',D='<div id="map_markers_{mapid}" class="{markersize} itsa-mapmarker-container {colorclass}"></div>';P.NAME="itsamapmarker",P.NS="itsamapmarker",P.ATTRS={markers:{value:null,validator:function(t){return t===null||t instanceof e.ModelList}},markerColorClass:{value:null,validator:function(e){return e===null||typeof e=="string"}},markerSize:{value:null,validator:function(e){return e===null||e==="small"||e==="large"||e==="extralarge"}}},e.Plugin.ITSAMapMarker=e.extend(P,e.Plugin.Base),P.prototype.initializer=function(){var e=this;e.host=e.get("host"),e._renderer()},P.prototype._renderer=function(){var e=this;e.renderUI(),e.bindUI(),e.syncUI(!0)},P.prototype.renderUI=function(){var t=this,n=t.host.mapid,s=e.one("#map_"+n),o,u,a=t.get(k)||"",f=t.get(L)||"";s&&(o=t._markerlayer=i.create(r.sub(D,{mapid:n,colorclass:a,markersize:f})),u=t.host.currentZoomedMap(),o.setStyle("left",u.getStyle("left")),o.setStyle("top",u.getStyle("top")),s.prepend(o))},P.prototype.bindUI=function(){var t=this,n=t.get(u),r;r=t._eventhandlers=[],n&&n.addTarget(t),r.push(t.after(l+a,function(e){var n=e.prevVal,r=e.newVal;n&&(n.removeTarget(t),r||t._clearMarkers()),r&&(t.syncUI(),r.addTarget(t))})),r.push(t.after([k+a,L+a],function(e){var n=t._markerlayer,r=e.newVal,i=e.prevVal;i&&n.removeClass(i),r&&n.addClass(r)})),r.push(t.after("*:add",function(e){t._addMarker(e.model)})),r.push(t.after("*:change",function(n){var r=n.target,i=n.changed,s;r instanceof e.ITSAMarkerModel&&(o.some(i,function(e,t){return s=t!==N&&t!==C,s}),t.syncMarker(r,{positiononly:!s}))})),r.push(t.after("*:remove",function(e){t._removeMarker(e.model)})),r.push(t.after("*:reset",function(e){t.syncUI()}))},P.prototype.getMarkerNode=function(t){var n=this,r=t instanceof e.ITSAMarkerModel?t.get(y):t[y];return n._markerlayer.one('[data-id="'+n.host.mapid+"_"+r+'"]')},P.prototype.hidePopup=function(e){var t=this,n=t.getMarkerNode(e);n&&n.setStyle("zIndex",e._originalZindex)},P.prototype.markerOnTop=function(e){var t=this,n=t._getHighestZ()+1,r=t.getMarkerNode(e);e._zIndex=n,r&&r.setStyle("zIndex",n)},P.prototype.markerRestoreZ=function(e){var t=this,n=t.getMarkerNode(e);e._zIndex=null,n&&n.setStyle("zIndex",e._originalZindex)},P.prototype.showPopup=function(e){var t=this,n=t.getMarkerNode(e);n&&n.setStyle("zIndex",e._originalZindex)},P.prototype.repositionMarkers=function(){console.log("repositionMarkers");var t=this,n=t.get(u);t._markerlayer.addClass(M),n.each(e.rbind(t.syncMarker,t,{positiononly:!0})),t._markerlayer.removeClass(M)},P.prototype.syncMarker=function(t,n){var r=this,i=r.getMarkerNode(t),s,o=n&&n.positiononly;console.log("syncMarker"),i&&(t instanceof e.ITSAMarkerModel?r._syncMarkerNode(i,t.get(N),t.get(C),o||t.get(l+h+f),o||t.get(l+p+f),o||t.get(l+d+f),o||t.get(l+v),o||t.get(l+m),o||t.get(L),o||t.get(l+g),o||t.get(l+c),o?null:t.toJSON()):(s=t[l+c],r._syncMarkerNode(i,t[N],t[C],o||t[l+h+f],o||t[l+p+f],o||t[l+d+f],o||t[l+v],o||t[l+m],o||t[L],o||t[l+g],o||typeof s=="boolean"?s:!0,o?null:t)))},P.prototype.syncUI=function(t){var n=this,r=n.get(u),i,s;i=function(e,t){var r=t+1;e._originalZindex=r,n._renderMarker(e.toJSON(),e.get(y),e.get(l+h+f),e.get(l+p+f),e.get(l+d+f),e.get(l+v),e.get(l+m),e.get(L),e.get(l+g),e.get(l+c),r)},s=function(e,t){var r=t+1,i=e[l+c];e._originalZindex=r,n._renderMarker(e,e[y],e[l+h+f],e[l+p+f],e[l+d+f],e[l+v],e[l+m],e[L],e[l+g],typeof i=="boolean"?i:!0,r)},t||n._clearMarkers(),n._markerlayer.addClass(M),r.each(r instanceof e.LazyModelList?s:i),n._markerlayer.removeClass(M)},P.prototype.destructor=function(){var e=this,t=e.get(u);t&&t.removeTarget(e),e._markerlayer.destroy(!0),e._clearEventhandlers()},P.prototype._addMarker=function(t){var n=this,r=n._getHighestZ()+1,i;t._originalZindex=r,t instanceof e.ITSAMarkerModel?n._renderMarker(t.toJSON(),t.get(y),t.get(l+h+f),t.get(l+p+f),t.get(l+d+f),t.get(l+v),t.get(l+m),t.get(L),t.get(l+g),t.get(l+c),r):(i=t[l+c],n._renderMarker(t,t[y],t[l+h+f],t[l+p+f],t[l+d+f],t[l+v],t[l+m],t[L],t[l+g],typeof i=="boolean"?i:!0,r))},P.prototype._clearEventhandlers=function(){s.each(this._eventhandlers,function(e){e.detach()})},P.prototype._clearMarkers=function(){var e=this._markerlayer;e.get("childNodes").destroy(!0),e.empty()},P.prototype._getHighestZ=function(){var e=this,t=e.get(u),n=0;return t.each(function(e){var t=e._zIndex||e._originalZindex||1;t>n&&(n=t)}),n},P.prototype._getMarkerX=function(e,t){var r=this,i=r._long2tileNOTROUNDED(e,t);return Math.round((i-1)*n)},P.prototype._getMarkerY=function(e,t){var r=this,i=r._lat2tileNOTROUNDED(e,t);return Math.round((i-1)*n)},P.prototype._long2tileNOTROUNDED=function(e,t){return(e+180)/360*Math.pow(2,t)},P.prototype._lat2tileNOTROUNDED=function(e,t){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t)},P.prototype._removeMarker=function(e){var t=this,n=t.getMarkerNode(e);n&&n.remove(!0)},P.prototype._renderMarker=function(e,t,n,s,o,u,a,f,l,c,h){var p=this,d,v,m;m=i.create(r.sub(_,{mapid:p.host.mapid,clientid:t,classname:u||"",colorclass:a||"",markersize:f||"",markerhtml:l,header:n?r.sub(n,e):"",body:s?r.sub(s,e):"",footer:o?r.sub
(o,e):"",left:d,top:v,hidden:c?"":T+'="'+T+'" ',zindex:h})),p._markerlayer.append(m),p._syncMarkerNode(m,e[N],e[C])},P.prototype._syncMarkerNode=function(e,t,n,i,s,o,u,a,f,l,c,h){var p=this,d,v,m;m=p.host.currentZoomLevel,console.log("_syncMarkerNode zoomlevel "+m),d=p._getMarkerX(n,m),v=p._getMarkerY(t,m),d-=Math.round(e.get(A)/2),v-=Math.round(e.get(O)/2)+e.one(".itsa-markerpin").get(O),e.setStyle("left",d+x),e.setStyle("top",v+x),h&&(e.one(".itsa-markerheaderdetails").setHTML(i?e.setAttribute(w,r.sub(i,h)):""),e.one(".itsa-markerbodydetails").setHTML(s?e.setAttribute(E,r.sub(s,h)):""),e.one(".itsa-markerfooterdetails").setHTML(o?e.setAttribute(S,r.sub(o,h)):""),e.set("class",(f?f+" ":"")+(a||"")+" itsa-mapmarker "+(u||"")),e.one(".itsa-markerballoon").setHTML(l),c?e.removeAttribute(T):e.setAttribute(T,T))}},"@VERSION@",{requires:["yui-base","oop","model-list","lazy-model-list","plugin","node-core","node-style","gallery-itsamarkermodel"],skinnable:!0});
