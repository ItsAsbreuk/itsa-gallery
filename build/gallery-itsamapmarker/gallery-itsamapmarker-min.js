YUI.add("gallery-itsamapmarker",function(e,t){"use strict";function z(){z.superclass.constructor.apply(this,arguments)}var n=e.Lang,r=e.Node,i=e.Array,s=e.Object,o="markers",u="Change",a="Template",f="marker",l="Visible",c="Header",h="Body",p="Footer",d="Classname",v="ColorClass",m="HTML",g="clientId",y="contentBox",b="px",w="hidden",E="lat",S="lon",x="itsa-",T="details",N="DetailsClosable",C=x+"marker"+T,k=T+"-visible",L=x+"markerheader"+T,A=x+"markerbody"+T,O=x+"markerfooter"+T,M=f+"ColorClass",_=f+"Size",D="offsetWidth",P="offsetHeight",H="markerMargin",B="destroyed",j="autoNumber",F="markerNumber",I="itsa-all-markers-hidden",q='<button class="pure-button itsa-closedetails" data-markerid="{clientid}">x</button>',R='<div data-id="{mapid}_{clientid}" class="{colorclass} itsa-mapmarker {classname}" {hidden}style="z-index:{zindex}"><div class="itsa-markerballoon {markersize}">{markerhtml}</div><div class="itsa-markerpin"></div><div class="'+T+"-fade "+T+"-outofrange "+C+'">'+'<div class="'+L+'">{header}{closebutton}</div>'+'<div class="'+A+'">{body}</div>'+'<div class="'+O+'">{footer}</div>'+'<div class="'+x+T+'-pin">'+"</div>"+"</div>"+"</div>",U='<div id="map_markers_{mapid}" class="{markersize} itsa-mapmarker-container {colorclass}"></div>';z.NAME="itsamapmarker",z.NS="itsamapmarker",z.ATTRS={autoNumber:{value:!1,validator:function(e){return typeof e=="boolean"}},markerDetailsClosable:{value:!0,validator:function(e){return typeof e=="boolean"}},markers:{value:null,validator:function(t){return t===null||t instanceof e.ModelList}},markerColorClass:{value:null,validator:function(e){return e===null||typeof e=="string"}},markerMargin:{value:80,validator:function(e){return typeof e=="number"}},markerSize:{value:null,validator:function(e){return e===null||e==="small"||e==="large"||e==="extralarge"}}},e.Plugin.ITSAMapMarker=e.extend(z,e.Plugin.Base),z.prototype.initializer=function(){var t=this,n;t._renderedPromise=new e.Promise(function(e){t._resolveHandler=e}),n=t.host=t.get("host"),n.renderPromise().then(e.bind(t._renderer,t))},z.prototype._renderer=function(){var e=this;e.renderUI(),e.bindUI(),e.get(j)&&e._calcPosMarkers(),e.syncUI(!0),e._resolveHandler()},z.prototype.renderUI=function(){var t=this,i=t.host.mapid,s=e.one("#map_"+i),o,u,a=t.get(M)||"",f=t.get(_)||"";s&&(o=t._markerlayer=r.create(n.sub(U,{mapid:i,colorclass:a,markersize:f})),u=t.host.currentZoomedMap(),o.setStyle("left",u.getStyle("left")),o.setStyle("top",u.getStyle("top")),s.prepend(o))},z.prototype.bindUI=function(){var t=this,n=t.get(o),r=t._markerlayer,i;i=t._eventhandlers=[],n&&n.addTarget(t),i.push(t.after(o+u,function(e){var n=e.prevVal,r=e.newVal,i=t._centerview,s=t._markersinview;n&&(n.removeTarget(t),r||t._clearMarkers()),r&&(t.get(j)&&t._calcPosMarkers(),t.syncUI(),r.addTarget(t),i&&t.centerView(i),s&&!i&&t.markersInView(s))})),i.push(t.after([M+u,_+u],function(e){var n=t._markerlayer,r=e.newVal,i=e.prevVal;i&&n.removeClass(i),r&&n.addClass(r)})),i.push(t.after("*:add",function(e){var n=t._centerview,r=t._markersinview;t.get(j)&&t._calcPosMarkers(),t._addMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r)})),i.push(t.after("*:change",function(n){var r=n.target,i=n.changed,o=t._centerview,u=t._markersinview,a,f;r instanceof e.ITSAMarkerModel&&(s.some(i,function(t,n){var r=n===E||n===S,i=e.JSON.stringify(t.newVal)!==e.JSON.stringify(t.prevVal);return i&&(a=i,!r&&(f=!0)),i&&f}),a&&(t.get(j)&&t._calcPosMarkers(),t.syncMarker(r,{positiononly:!f}),o&&t.centerView(o),u&&!o&&t.markersInView(u)))})),i.push(t.after("*:remove",function(e){var n=t._centerview,r=t._markersinview;t._removeMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r),t.get(j)&&(t._calcPosMarkers(),t.syncUI())})),i.push(t.after("*:reset",function(e){var n=t._centerview,r=t._markersinview;e.src==="reset"&&(t.get(j)&&t._calcPosMarkers(),t.syncUI(),n&&t.centerView(n),r&&!n&&t.markersInView(r))})),r&&i.push(r.delegate("click",function(e){var n=e.currentTarget,r=n.getAttribute("data-markerid"),i=r&&t.get(o).getByClientId(r);i&&t.hidePopup(i)},".itsa-closedetails"))},z.prototype.centerView=function(t){var r=this;r.readyPromise().then(function(){var s=r.host,u=t&&t.markers,a=t&&t.zoomin,f=t&&t.zoomout,l=t&&t.continuous,c=r.get(o),h=r.get(H),p,d,v,m,g,b,w,x,T,N,C,k,L,A,O,M,_,j,F,I,q,R,U;x=function(e){var t,n;e&&(w||!e.get(B))&&(t=w?e[E]:e.get(E),n=w?e[S]:e.get(S),(!v||t<v)&&(v=t),(!m||t>m)&&(m=t),(!g||t<g)&&(g=n),(!b||t>b)&&(b=n))},u||(u=c),u instanceof e.ITSAMarkerModel?(p=u.get(E),d=u.get(S)):n.isArray(u)?(w=c instanceof e.LazyModelList,u.length===0?(u=c,u.each(x)):i.each(u,x)):u instanceof e.ModelList?(w=c instanceof e.LazyModelList,u.each(x)):typeof u=="object"&&(p=u[E],d=u[S]),v&&(p=(v+m)/2,d=(g+b)/2);if(p){s.gotoPos(p,d);if(a||f){g||(g=b=d,v=m=p),M=T=s.getZoomLevel(),_=s.getMaxZoomLevel(),N=s.get(y),C=N.get(D)-2*h,k=N.get(P)-2*h,j=s._getX(g,T),F=s._getX(b,T),I=s._getY(v,T),q=s._getY(m,T),L=Math.abs(F-j),A=Math.abs(q-I),R=L/C,U=A/k,O=Math.max(R,U);if(a){typeof a=="number"&&a<_&&(_=a);while(O<.5&&M<_)O=2*O,M++}else if(f)while(O>1&&M>0)O/=2,M--;M!==T&&s.zoom(M)}}t.fromInternal||(l?r._centerview={markers:u,zoomin:a,zoomout:f,fromInternal:!0}:r.stopContCenterView())})},z.prototype.getMarkerNode=function(t){var n=this,r=t instanceof e.ITSAMarkerModel?t.get(g):t[g];return n._markerlayer.one('[data-id="'+n.host.mapid+"_"+r+'"]')},z.prototype.hidePopup=function(t){var r=this;t||(t=r.get(o).toArray()),n.isArray(t)?i.each(t,e.bind(r._hidePopup,r)):(t instanceof e.ITSAMarkerModel||typeof t=="object")&&r._hidePopup(t)},z.prototype.markerOnTop=function(e){var t=this,n=t._getHighestZ()+1,r=t.getMarkerNode(e);e._zIndex=n,r&&r.setStyle("zIndex",n)},z.prototype.markerRestoreZ=function(e){var t=this,n=t.getMarkerNode(e);e._zIndex=null,n&&n.setStyle("zIndex",e._originalZindex)},z.prototype.markersInView=function(t){var r=this;r.readyPromise().then(function(){var s=r.host,u=t&&t.markers,a=t&&t.zoomin,f=t&&t.continuous,l=r.get(o),c=r.get(H),h,p,d,v,m,g,b,w,x,T,N
,C,k,L,A,O,M,_,j,F;g=function(e){var t,n;e&&(m||!e.get(B))&&(t=m?e[E]:e.get(E),n=m?e[S]:e.get(S),(!h||t<h)&&(h=t),(!p||t>p)&&(p=t),(!d||t<d)&&(d=n),(!v||t>v)&&(v=n))},F=function(e){var t,n,r,i,o,u;return t=s._getX(_,e),n=s._getY(j,e),r=t-x+c,o=t+x-c,i=n-T+c,u=n+T-c,L=s._getX(d,e),A=s._getX(v,e),O=s._getY(h,e),M=s._getY(p,e),L>r&&L<o&&A>r&&A<o&&O>i&&O<u&&M>i&&M<u},u||(u=l),u instanceof e.ITSAMarkerModel?(h=p=u.get(E),d=v=u.get(S)):n.isArray(u)?(m=l instanceof e.LazyModelList,u.length===0?(u=l,u.each(g)):i.each(u,g)):u instanceof e.ModelList?(m=l instanceof e.LazyModelList,u.each(g)):typeof u=="object"&&(h=p=u[E],d=v=u[S]);if(h){C=b=s.getZoomLevel(),k=s.getMaxZoomLevel(),w=s.get(y),x=Math.round(w.get(D)/2),T=Math.round(w.get(P)/2),_=s.getLon(),j=s.getLat();while(!F(C)&&C>0)N=!0,C--;if(a&&!N){typeof a=="number"&&a<k&&(k=a);while(F(C+1)&&C+1<k)C++}C!==b&&s.zoom(C)}t.fromInternal||(f?r._markersinview={markers:u,zoomin:a,fromInternal:!0}:r.stopContMarkersInView())})},z.promiseBeforeReady=function(){return this._renderedPromise},z.prototype.showPopup=function(t,r){var s=this;r&&s.hidePopup(),t||(t=s.get(o).toArray()),n.isArray(t)?i.each(t,e.bind(s._showPopup,s)):(t instanceof e.ITSAMarkerModel||typeof t=="object")&&s._showPopup(t)},z.prototype.stopContCenterView=function(){this._centerview=null},z.prototype.stopContMarkersInView=function(){this._markersinview=null},z.prototype.repositionMarkers=function(){var e=this,t=e.get(o);e._markerlayer.addClass(I),t.each(function(t){e.syncMarker(t,{positiononly:!0})}),e._markerlayer.removeClass(I)},z.prototype.syncMarker=function(t,n){var r=this,i=r.getMarkerNode(t),s=r.get(j),o,u=n&&n.positiononly;i&&(t instanceof e.ITSAMarkerModel?r._syncMarkerNode(i,t.get(E),t.get(S),u||t.get(g),u||t.get(f+c+a),u||t.get(f+h+a),u||t.get(f+p+a),u||t.get(f+d),u||t.get(f+v),u||t.get(_),u||t.get(f+m)||(s?t.get(F):""),u||t.get(f+N),u||t.get(f+l),u?null:t.toJSON()):(o=t[f+l],r._syncMarkerNode(i,t[E],t[S],u||t[g],u||t[f+c+a],u||t[f+h+a],u||t[f+p+a],u||t[f+d],u||t[f+v],u||t[_],u||t[f+m]||(s?t[F]:""),u||t[f+N],u||typeof o=="boolean"?o:!0,u?null:t)))},z.prototype.syncUI=function(t){var n=this,r=n.get(o),i=n.get(j),s,u;s=function(e,t){var r=t+1;e._originalZindex=r,n._renderMarker(e.toJSON(),e.get(g),e.get(f+c+a),e.get(f+h+a),e.get(f+p+a),e.get(f+d),e.get(f+v),e.get(_),e.get(f+m)||(i?e.get(F):""),e.get(f+N),e.get(f+l),r)},u=function(e,t){var r=t+1,s=e[f+l];e._originalZindex=r,n._renderMarker(e,e[g],e[f+c+a],e[f+h+a],e[f+p+a],e[f+d],e[f+v],e[_],e[f+m]||(i?e[F]:""),e[f+N],typeof s=="boolean"?s:!0,r)},t||n._clearMarkers(),n._markerlayer.addClass(I),r.each(r instanceof e.LazyModelList?u:s),n._markerlayer.removeClass(I)},z.prototype.destructor=function(){var e=this,t=e.get(o);t&&t.removeTarget(e),e._markerlayer.destroy(!0),e._clearEventhandlers()},z.prototype._addMarker=function(t){var n=this,r=n._getHighestZ()+1,i=n.get(j),s;t._originalZindex=r,t instanceof e.ITSAMarkerModel?n._renderMarker(t.toJSON(),t.get(g),t.get(f+c+a),t.get(f+h+a),t.get(f+p+a),t.get(f+d),t.get(f+v),t.get(_),t.get(f+m)||(i?t.get(F):""),t.get(f+N),t.get(f+l),r):(s=t[f+l],n._renderMarker(t,t[g],t[f+c+a],t[f+h+a],t[f+p+a],t[f+d],t[f+v],t[_],t[f+m]||(i?t[F]:""),t[f+N],typeof s=="boolean"?s:!0,r))},z.prototype._calcPosMarkers=function(){var e=this,t=e.get(o),n=t.revive;e.get(o).each(function(e,t){n?e[F]=t+1:e.set(F,t+1,{silent:!0})})},z.prototype._clearEventhandlers=function(){i.each(this._eventhandlers,function(e){e.detach()})},z.prototype._clearMarkers=function(){var e=this._markerlayer;e.get("childNodes").destroy(!0),e.empty()},z.prototype._getHighestZ=function(){var e=this,t=e.get(o),n=0;return t.each(function(e){var t=e._zIndex||e._originalZindex||1;t>n&&(n=t)}),n},z.prototype._hidePopup=function(e){var t=this,n=t.getMarkerNode(e),r;n&&(r=n.one("."+C),r.removeClass(k),n.setStyle("zIndex",e._originalZindex))},z.prototype._removeMarker=function(e){var t=this,n=t.getMarkerNode(e);n&&n.remove(!0)},z.prototype._renderMarker=function(e,t,i,s,o,u,a,l,c,h,p,d){var v=this,m=typeof h=="boolean"?h:v.get(f+N),g,y,b;b=r.create(n.sub(R,{mapid:v.host.mapid,clientid:t,classname:u||"",colorclass:a||"",markersize:l||"",markerhtml:c,closebutton:m?n.sub(q,{clientid:t}):"",header:i?n.sub(i,e):"",body:s?n.sub(s,e):"",footer:o?n.sub(o,e):"",left:g,top:y,hidden:p?"":w+'="'+w+'" ',zindex:d})),v._markerlayer.append(b),v._syncMarkerNode(b,e[E],e[S])},z.prototype._showPopup=function(e,t){var n=this,r=n.getMarkerNode(e),i=n._getHighestZ()+1,s;typeof t=="boolean"&&t&&n.hidePopup(),r&&(s=r.one("."+C),s.addClass(k),r.setStyle("zIndex",i))},z.prototype._syncMarkerNode=function(e,t,r,i,s,o,u,a,l,c,h,p,d,v){var m=this,g=m.host,y=typeof p=="boolean"?p:m.get(f+N),E,S,x,T,C,k,M;x=g.currentZoomLevel,E=g._getX(r,x),S=g._getY(t,x),E-=Math.round(e.get(D)/2),S-=Math.round(e.get(P)/2)+e.one(".itsa-markerpin").get(P),e.setStyle("left",E+b),e.setStyle("top",S+b),v&&(T=e.one("."+L),C=e.one("."+A),k=e.one("."+O),M=e.one(".itsa-markerballoon"),T.get("childNodes").destroy(!0),C.get("childNodes").destroy(!0),k.get("childNodes").destroy(!0),M.get("childNodes").destroy(!0),T.setHTML((s?n.sub(s,v):"")+(y?n.sub(q,{clientid:i}):"")),C.setHTML(o?n.sub(o,v):""),k.setHTML(u?n.sub(u,v):""),e.set("class",(c?c+" ":"")+(l||"")+" itsa-mapmarker "+(a||"")),M.setHTML(h),d?e.removeAttribute(w):e.setAttribute(w,w))}},"@VERSION@",{requires:["yui-base","oop","model-list","lazy-model-list","plugin","node-core","node-style","json-stringify","promise","gallery-itsamarkermodel","gallery-itsapluginpromise","gallery-itsawidgetrenderpromise"],skinnable:!0});
