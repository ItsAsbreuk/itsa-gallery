YUI.add("gallery-itsamapmarker",function(e,t){"use strict";function U(){U.superclass.constructor.apply(this,arguments)}var n=e.Lang,r=e.Node,i=e.Array,s=e.Object,o="markers",u="Change",a="Template",f="marker",l="Visible",c="Header",h="Body",p="Footer",d="Classname",v="ColorClass",m="HTML",g="clientId",y="contentBox",b="px",w="hidden",E="lat",S="lon",x="itsa-",T="details",N="DetailsClosable",C=x+"marker"+T,k=T+"-visible",L=T+"-outofrange",A=x+"markerheader"+T,O=x+"markerbody"+T,M=x+"markerfooter"+T,_=f+"ColorClass",D=f+"Size",P="offsetWidth",H="offsetHeight",B="markerMargin",j="destroyed",F="itsa-all-markers-hidden",I='<button class="pure-button itsa-closedetails" data-markerid="{clientid}">x</button>',q='<div data-id="{mapid}_{clientid}" class="{colorclass} itsa-mapmarker {classname}" {hidden}style="z-index:{zindex}"><div class="itsa-markerballoon {markersize}">{markerhtml}</div><div class="itsa-markerpin"></div><div class="'+T+"-fade "+T+"-outofrange "+C+'">'+'<div class="'+A+'">{header}{closebutton}</div>'+'<div class="'+O+'">{body}</div>'+'<div class="'+M+'">{footer}</div>'+'<div class="'+x+T+'-pin">'+"</div>"+"</div>"+"</div>",R='<div id="map_markers_{mapid}" class="{markersize} itsa-mapmarker-container {colorclass}"></div>';U.NAME="itsamapmarker",U.NS="itsamapmarker",U.ATTRS={markerDetailsClosable:{value:!0,validator:function(e){return typeof e=="boolean"}},markers:{value:null,validator:function(t){return t===null||t instanceof e.ModelList}},markerColorClass:{value:null,validator:function(e){return e===null||typeof e=="string"}},markerMargin:{value:80,validator:function(e){return typeof e=="number"}},markerSize:{value:null,validator:function(e){return e===null||e==="small"||e==="large"||e==="extralarge"}}},e.Plugin.ITSAMapMarker=e.extend(U,e.Plugin.Base),U.prototype.initializer=function(){var t=this,n;n=t.host=t.get("host"),n.renderPromise().then(e.bind(t._renderer,t))},U.prototype._renderer=function(){var e=this;e.renderUI(),e.bindUI(),e.syncUI(!0)},U.prototype.renderUI=function(){var t=this,i=t.host.mapid,s=e.one("#map_"+i),o,u,a=t.get(_)||"",f=t.get(D)||"";s&&(o=t._markerlayer=r.create(n.sub(R,{mapid:i,colorclass:a,markersize:f})),u=t.host.currentZoomedMap(),o.setStyle("left",u.getStyle("left")),o.setStyle("top",u.getStyle("top")),s.prepend(o))},U.prototype.bindUI=function(){var t=this,n=t.get(o),r=t._markerlayer,i;i=t._eventhandlers=[],n&&n.addTarget(t),i.push(t.after(f+u,function(e){var n=e.prevVal,r=e.newVal,i=t._centerview,s=t._markersinview;n&&(n.removeTarget(t),r||t._clearMarkers()),r&&(t.syncUI(),r.addTarget(t),i&&t.centerView(i),s&&!i&&t.markersInView(s))})),i.push(t.after([_+u,D+u],function(e){var n=t._markerlayer,r=e.newVal,i=e.prevVal;i&&n.removeClass(i),r&&n.addClass(r)})),i.push(t.after("*:add",function(e){var n=t._centerview,r=t._markersinview;t._addMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r)})),i.push(t.after("*:change",function(n){var r=n.target,i=n.changed,o=t._centerview,u=t._markersinview,a,f;r instanceof e.ITSAMarkerModel&&(s.some(i,function(e,t){var n=t===E||t===S;return n?a=!0:f=!0,typeof a=="boolean"&&typeof f=="boolean"}),t.syncMarker(r,{positiononly:!f}),o&&t.centerView(o),u&&!o&&t.markersInView(u))})),i.push(t.after("*:remove",function(e){var n=t._centerview,r=t._markersinview;t._removeMarker(e.model),n&&t.centerView(n),r&&!n&&t.markersInView(r)})),i.push(t.after("*:reset",function(e){var n=t._centerview,r=t._markersinview;t.syncUI(),n&&t.centerView(n),r&&!n&&t.markersInView(r)})),r&&i.push(r.delegate("click",function(e){var n=e.currentTarget,r=n.getAttribute("data-markerid"),i=r&&t.get(o).getByClientId(r);i&&t.hidePopup(i)},".itsa-closedetails"))},U.prototype.centerView=function(t){var r=this,s=r.host,u=t&&t.markers,a=t&&t.zoomin,f=t&&t.zoomout,l=t&&t.continuous,c=r.get(o),h=r.get(B),p,d,v,m,g,b,w,x,T,N,C,k,L,A,O,M,_,D,F,I,q,R,U;x=function(e){var t,n;e&&(w||!e.get(j))&&(t=w?e[E]:e.get(E),n=w?e[S]:e.get(S),(!v||t<v)&&(v=t),(!m||t>m)&&(m=t),(!g||t<g)&&(g=n),(!b||t>b)&&(b=n))},u||(u=c),u instanceof e.ITSAMarkerModel?(p=u.get(E),d=u.get(S)):n.isArray(u)?(w=c instanceof e.LazyModelList,i.each(u,x)):u instanceof e.ModelList?(w=c instanceof e.LazyModelList,u.each(x)):typeof u=="object"&&(p=u[E],d=u[S]),v&&(p=(v+m)/2,d=(g+b)/2);if(p){s.gotoPos(p,d);if(a||f){g||(g=b=d,v=m=p),M=T=s.getZoomLevel(),_=s.getMaxZoomLevel(),N=s.get(y),C=N.get(P)-2*h,k=N.get(H)-2*h,D=s._getX(g,T),F=s._getX(b,T),I=s._getY(v,T),q=s._getY(m,T),L=Math.abs(F-D),A=Math.abs(q-I),R=L/C,U=A/k,O=Math.max(R,U);if(a){typeof a=="number"&&a<_&&(_=a);while(O<.5&&M<_)O=2*O,M++}else if(f)while(O>1&&M>0)O/=2,M--;M!==T&&s.zoom(M)}}t.fromInternal||(l?r._centerview={markers:u,zoomin:a,zoomout:f,fromInternal:!0}:r._centerview=null)},U.prototype.getMarkerNode=function(t){var n=this,r=t instanceof e.ITSAMarkerModel?t.get(g):t[g];return n._markerlayer.one('[data-id="'+n.host.mapid+"_"+r+'"]')},U.prototype.hidePopup=function(t){var n=this,r=n.getMarkerNode(t),i;r&&(i=r.one("."+C),i.removeClass(k),r.setStyle("zIndex",t._originalZindex),e.later(300,null,function(){try{i.addClass(L)}catch(e){}}))},U.prototype.markerOnTop=function(e){var t=this,n=t._getHighestZ()+1,r=t.getMarkerNode(e);e._zIndex=n,r&&r.setStyle("zIndex",n)},U.prototype.markerRestoreZ=function(e){var t=this,n=t.getMarkerNode(e);e._zIndex=null,n&&n.setStyle("zIndex",e._originalZindex)},U.prototype.markersInView=function(t){var r=this,s=r.host,u=t&&t.markers,a=t&&t.zoomin,f=t&&t.continuous,l=r.get(o),c=r.get(B),h,p,d,v,m,g,b,w,x,T,N,C,k,L,A,O,M,_,D,F;g=function(e){var t,n;e&&(m||!e.get(j))&&(t=m?e[E]:e.get(E),n=m?e[S]:e.get(S),(!h||t<h)&&(h=t),(!p||t>p)&&(p=t),(!d||t<d)&&(d=n),(!v||t>v)&&(v=n))},F=function(e){var t,n,r,i,o,u;return t=s._getX(_,e),n=s._getY(D,e),r=t-x+c,o=t+x-c,i=n-T+c,u=n+T-c,L=s._getX(d,e),A=s._getX(v,e),O=s._getY(h,e),M=s._getY(p,e),L>r&&L<o&&A>r&&A<o&&O>i&&O<u&&M>i&&M<u},u||(u=l),u instanceof e.ITSAMarkerModel?(h=p=u.get(E),d=v=u.get(S)):n.isArray(u)?(m=l instanceof e.LazyModelList,i.each(u,g)):u instanceof e.ModelList?
(m=l instanceof e.LazyModelList,u.each(g)):typeof u=="object"&&(h=p=u[E],d=v=u[S]);if(h){C=b=s.getZoomLevel(),k=s.getMaxZoomLevel(),w=s.get(y),x=Math.round(w.get(P)/2),T=Math.round(w.get(H)/2),_=s.getLon(),D=s.getLat();while(!F(C)&&C>0)N=!0,C--;if(a&&!N){typeof a=="number"&&a<k&&(k=a);while(F(C+1)&&C+1<k)C++}C!==b&&s.zoom(C)}t.fromInternal||(f?r._markersinview={markers:u,zoomin:a,fromInternal:!0}:r._markersinview=null)},U.prototype.showPopup=function(e){var t=this,n=t.getMarkerNode(e),r=t._getHighestZ()+1,i;n&&(i=n.one("."+C),i.removeClass(L).addClass(k),n.setStyle("zIndex",r))},U.prototype.repositionMarkers=function(){var e=this,t=e.get(o);e._markerlayer.addClass(F),t.each(function(t){e.syncMarker(t,{positiononly:!0})}),e._markerlayer.removeClass(F)},U.prototype.syncMarker=function(t,n){var r=this,i=r.getMarkerNode(t),s,o=n&&n.positiononly;i&&(t instanceof e.ITSAMarkerModel?r._syncMarkerNode(i,t.get(E),t.get(S),o||t.get(g),o||t.get(f+c+a),o||t.get(f+h+a),o||t.get(f+p+a),o||t.get(f+d),o||t.get(f+v),o||t.get(D),o||t.get(f+m),o||t.get(f+N),o||t.get(f+l),o?null:t.toJSON()):(s=t[f+l],r._syncMarkerNode(i,t[E],t[S],o||t[g],o||t[f+c+a],o||t[f+h+a],o||t[f+p+a],o||t[f+d],o||t[f+v],o||t[D],o||t[f+m],o||t[f+N],o||typeof s=="boolean"?s:!0,o?null:t)))},U.prototype.syncUI=function(t){var n=this,r=n.get(o),i,s;i=function(e,t){var r=t+1;e._originalZindex=r,n._renderMarker(e.toJSON(),e.get(g),e.get(f+c+a),e.get(f+h+a),e.get(f+p+a),e.get(f+d),e.get(f+v),e.get(D),e.get(f+m),e.get(f+N),e.get(f+l),r)},s=function(e,t){var r=t+1,i=e[f+l];e._originalZindex=r,n._renderMarker(e,e[g],e[f+c+a],e[f+h+a],e[f+p+a],e[f+d],e[f+v],e[D],e[f+m],e[f+N],typeof i=="boolean"?i:!0,r)},t||n._clearMarkers(),n._markerlayer.addClass(F),r.each(r instanceof e.LazyModelList?s:i),n._markerlayer.removeClass(F)},U.prototype.destructor=function(){var e=this,t=e.get(o);t&&t.removeTarget(e),e._markerlayer.destroy(!0),e._clearEventhandlers()},U.prototype._addMarker=function(t){var n=this,r=n._getHighestZ()+1,i;t._originalZindex=r,t instanceof e.ITSAMarkerModel?n._renderMarker(t.toJSON(),t.get(g),t.get(f+c+a),t.get(f+h+a),t.get(f+p+a),t.get(f+d),t.get(f+v),t.get(D),t.get(f+m),t.get(f+N),t.get(f+l),r):(i=t[f+l],n._renderMarker(t,t[g],t[f+c+a],t[f+h+a],t[f+p+a],t[f+d],t[f+v],t[D],t[f+m],t[f+N],typeof i=="boolean"?i:!0,r))},U.prototype._clearEventhandlers=function(){i.each(this._eventhandlers,function(e){e.detach()})},U.prototype._clearMarkers=function(){var e=this._markerlayer;e.get("childNodes").destroy(!0),e.empty()},U.prototype._getHighestZ=function(){var e=this,t=e.get(o),n=0;return t.each(function(e){var t=e._zIndex||e._originalZindex||1;t>n&&(n=t)}),n},U.prototype._removeMarker=function(e){var t=this,n=t.getMarkerNode(e);n&&n.remove(!0)},U.prototype._renderMarker=function(e,t,i,s,o,u,a,l,c,h,p,d){var v=this,m=typeof h=="boolean"?h:v.get(f+N),g,y,b;b=r.create(n.sub(q,{mapid:v.host.mapid,clientid:t,classname:u||"",colorclass:a||"",markersize:l||"",markerhtml:c,closebutton:m?n.sub(I,{clientid:t}):"",header:i?n.sub(i,e):"",body:s?n.sub(s,e):"",footer:o?n.sub(o,e):"",left:g,top:y,hidden:p?"":w+'="'+w+'" ',zindex:d})),v._markerlayer.append(b),v._syncMarkerNode(b,e[E],e[S])},U.prototype._syncMarkerNode=function(e,t,r,i,s,o,u,a,l,c,h,p,d,v){var m=this,g=m.host,y=typeof p=="boolean"?p:m.get(f+N),E,S,x,T,C,k,L;x=g.currentZoomLevel,E=g._getX(r,x),S=g._getY(t,x),E-=Math.round(e.get(P)/2),S-=Math.round(e.get(H)/2)+e.one(".itsa-markerpin").get(H),e.setStyle("left",E+b),e.setStyle("top",S+b),v&&(T=e.one("."+A),C=e.one("."+O),k=e.one("."+M),L=e.one(".itsa-markerballoon"),T.get("childNodes").destroy(!0),C.get("childNodes").destroy(!0),k.get("childNodes").destroy(!0),L.get("childNodes").destroy(!0),T.setHTML((s?n.sub(s,v):"")+(y?n.sub(I,{clientid:i}):"")),C.setHTML(o?n.sub(o,v):""),k.setHTML(u?n.sub(u,v):""),e.set("class",(c?c+" ":"")+(l||"")+" itsa-mapmarker "+(a||"")),L.setHTML(h),d?e.removeAttribute(w):e.setAttribute(w,w))}},"@VERSION@",{requires:["yui-base","oop","model-list","lazy-model-list","plugin","node-core","node-style","gallery-itsamarkermodel","gallery-itsawidgetrenderpromise"],skinnable:!0});
