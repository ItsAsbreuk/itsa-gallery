YUI.add("gallery-itsaformmodel",function(e,t){"use strict";var n=e.Array,r=e.Object,i=e.Node,s=e.Lang,o=e.ITSAFormElement,u="Notification:",a="Data has been changed outside the form.<br />Load it into the form? (if not, then the data will be reset to the current form-values)",f="Data has been changed outside the form.<br />Load it into the form?",l="UNDEFINED FORM-ELEMENT",c="itsa-invisible",h='<span style="background-color:F00; color:#FFF">DUPLICATED FORMELEMENT is not allowed</span>',p=1e4,d=1728e5,v=864e5,m="gallery-itsa",g="click",y="save",b="destroy",w="remove",E="cancel",S="submit",x="date",T="time",N=x+T,C="number",k="string",L="boolean",A="picker",O="data",M="value",_="button",D="type",P=O+"-"+_+"sub"+D,H=O+"-"+_+D,B=O+"-modelattribute",j="id",F=O+"-content",I="reset",q="focusnext",R="validationerror",U="uichanged",z=_+g,W=b+g,X=w+g,V=S+g,$=E+g,J=I+g,K=y+g,Q=x+A+g,G=T+A+g,Y=x+T+A+g,Z=e.ITSAFormModel=e.Base.create("itsaformmodel",e.Model,[],{},{_ATTR_CFG:["formtype","formconfig","validationerror"]});Z.prototype._widgetValueFields={},Z.prototype._allowedFormTypes={text:!0,number:!0,password:!0,textarea:!0,checkbox:!0,date:!0,time:!0,datetime:!0,email:!0,url:!0,plain:!0},Z.prototype.initializer=function(){var t=this;t._eventhandlers=[],t._FORM_elements={},t._ATTRS_nodes={},t._knownNodeIds={},t._lifeUpdate=!1,t._focusNextElements={text:!0,number:!0,password:!0,textarea:!0,email:!0,url:!0},t._renderBtnFns={button:t.renderBtn,cancel:t.renderCancelBtn,destroy:t.renderDestroyBtn,remove:t.renderRemoveBtn,reset:t.renderResetBtn,save:t.renderSaveBtn,submit:t.renderSubmitBtn},t.publish(q,{defaultFn:e.bind(t.defFnFocusNext,t),emitFacade:!0}),t.publish(U,{defaultFn:e.bind(t._defFnUIChanged,t),emitFacade:!0}),t.publish(W,{defaultFn:e.bind(t._defFnDestroy,t),emitFacade:!0}),t.publish(X,{defaultFn:e.bind(t._defFnRemove,t),emitFacade:!0}),t.publish(V,{defaultFn:e.bind(t._defFnSubmit,t),emitFacade:!0}),t.publish($,{defaultFn:e.bind(t._defFnCancel,t),emitFacade:!0}),t.publish(J,{defaultFn:e.bind(t._defFnReset,t),emitFacade:!0}),t.publish(K,{defaultFn:e.bind(t._defFnSave,t),emitFacade:!0}),t.publish(Q,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(G,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(Y,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t._bindUI(),t._gcTimer=e.later(v,t,t._garbageCollect,null,!0)},Z.prototype.crossValidation=function(){},Z.prototype.defFnFocusNext=function(){console.log("focus next")},Z.prototype.getCurrentFormElement=function(e){return this.getCurrentFormElements(e)[0]||null},Z.prototype.getCurrentFormElements=function(t){var i=this,s=i._ATTRS_nodes[t],o=[],u;return s?n.each(s,function(t){var n=e.one("#"+t);n&&(u=i._FORM_elements[t],u.node=n,o.push(u))}):r.each(i._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&r.getAttribute("name")===t&&(n.node=r,o.push(n))}),o},Z.prototype.getUI=function(t){var n=this,r,i,o,u,a,f,l,c;return u=n._ATTRS_nodes[t],o=u&&u.length>0&&u[0],i=n._FORM_elements,r=o&&i[o],r&&(a=e.one("#"+o))&&a.getAttribute(B)&&(l=r.widget,c=r.type,f=l?n._getWidgetValue(l,c):a.get(M),s.isValue(f)&&((c===x||c===T||c===x)&&(f=new Date(parseInt(f,10))),c===C&&(f=r.config.digits?parseFloat(f):parseInt(f,10)))),f},Z.prototype.getUnvalidatedUI=function(){var t=this,i,o,u,a=[];return r.each(this._FORM_elements,function(n){n.widget||(i=e.one("#"+n.nodeid),i&&(o=t._validValue(i,n,n.name,i.get(M)),t._setNodeValidation(i,o),o||a.push(i)))}),u=t.crossValidation(),s.isArray(u)&&u.length>0&&n.each(u,function(r){var i=r.attribute,s=i&&t._ATTRS_nodes[i];s&&n.each(s,function(n){var i=e.one("#"+n),s=r.validationerror,o;i&&(o=typeof s===k?s:null,t._setNodeValidation(i,!1,o),a.push(i))})}),new e.NodeList(a)},Z.prototype.renderBtn=function(e,t){return this._renderBtn(e,t,_)},Z.prototype.renderCancelBtn=function(e,t){return this._renderBtn(e,t,E)},Z.prototype.renderDestroyBtn=function(e,t){return this._renderBtn(e,t,b)},Z.prototype.renderRemoveBtn=function(e,t){return this._renderBtn(e,t,w)},Z.prototype.renderResetBtn=function(e,t){return this._renderBtn(e,t,I)},Z.prototype.renderSaveBtn=function(e,t){return this._renderBtn(e,t,y)},Z.prototype.renderSubmitBtn=function(e,t){return this._renderBtn(e,t,S)},Z.prototype.renderFormElement=function(t){var r=this,s=r._knownNodeIds,u,a,f,d,v,g,y,b,w,E,S,C,L,A;return u=r._FORM_elements,a=r._ATTRS_nodes,f=r.get(t),d=r._getAttrCfg(t),y=d.formtype||"text",C=typeof y=="function"&&y.NAME,C||r._allowedFormTypes[y]?(b=d.formconfig||{},b.value=f,C&&(w=r._getWidgetValueField(y),b.widgetconfig||(b.widgetconfig={}),L=typeof w!==k,L?n.each(w,function(e){b.widgetconfig[e]=f}):b.widgetconfig[w]=f),b.modelattribute=!0,b.name=t,b.tooltipinvalid=d.validationerror,b.removerequired=!0,delete b.pattern,b.removepattern=!0,b.hideatstartup=!0,v=o.getElement(y,b),E=v.nodeid,u[E]=v,a[t]||(a[t]=[]),a[t].push(E),S=v.widget,S?(A=y.NAME==="editorBase",e.use(A?m+"editorrenderpromise":m+"widgetrenderpromise",function(){S.renderPromise().then(function(){var t=e.one("#"+E);s[E]?t.insert(h,"replace"):(s[E]=!0,A&&t.removeClass(c),r._modelToUI(E),!A&&t.removeClass(c))})}),L?n.each(w,function(t){r._eventhandlers.push(S.after(t+"Change",function(t){var n=U,i={target:r,value:t.newVal,formElement:v,node:e.one("#"+E),nodeid:E,type:n};r.fire(n,i)}))}):r._eventhandlers.push(S.after(w+"Change",function(t){var n=U,i={target:r,value:t.newVal,formElement:v,node:e.one("#"+E),nodeid:E,type:n};r.fire(n,i)}))):i.availablePromise("#"+E,p).then(function(t){if(s[E])t.insert(h,"replace");else{s[E]=!0,r._modelToUI(E),t.removeClass(c);if(y===x||y===T||y===N)t=e.one('span.formatvalue[data-for="'+E+'"]'),t&&t.removeClass(c)}},function(e){}),g=v.html,v.widget&&v.widget.addTarget(r)):g=l,g},Z.prototype.reset=function(){var e=this,t;e.constructor.superclass.constructor.superclass.reset.apply(e,arguments),e._modelToUI(),e._removeValidation(),t={type:I,target:e},e.fire(I,t)},Z.prototype.setLifeUpdate=function(e){var t=this;return typeof e===L&&(t._lifeUpdate=
e),t},Z.prototype.setResetAttrs=function(){var e=this,t=e.getAttrs();delete t.clientId,delete t.destroyed,delete t.initialized,e.idAttribute!==j&&delete t.id,r.each(t,function(t,n){t&&e._state.add(n,"initValue",t)})},Z.prototype.setWidgetValueField=function(e,t){this._widgetValueFields[e]=t},Z.prototype.toJSONUI=function(t){var i=this,o={},u=i.getAttrs(),a=i._renderBtnFns,f,l,c,h;return delete u.clientId,delete u.destroyed,delete u.initialized,i.idAttribute!==j&&delete u.id,r.each(u,function(e,t){o[t]=i.renderFormElement(t)}),s.isObject(t)?(f=t.propertykey,l=t.type,c=t.labelHTML,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())):s.isArray(t)&&n.each(t,function(t){f=t.propertykey,l=t.type,c=t.labelHTML,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())}),o},Z.prototype.UIToModel=function(t){var n=this,i,o,u,a,f,l,c,h;o=n._FORM_elements,i=t&&o[t],i&&(a=e.one("#"+t))&&a.getAttribute(B)?(c=i.widget,h=i.type,f=c?n._getWidgetValue(c,h):a.get(M),l=i.name,s.isValue(f)&&(u={formelement:!0},(h===x||h===T||h===x)&&(f=new Date(parseInt(f,10))),h===C&&(f=i.config.digits?parseFloat(f):parseInt(f,10)),n.set(l,f,u))):t||r.each(n._FORM_elements,function(e,t){n.UIToModel(t)})},Z.prototype.destructor=function(){var e=this;e._clearEventhandlers(),e._removeTargets(),e._FORM_elements={},e._ATTRS_nodes={},e._focusNextElements={},e._widgetValueFields={},e._knownNodeIds={},e._gcTimer.cancel()},Z.prototype._bindUI=function(){var t=this,n=t._eventhandlers,r=e.one("body");n.push(r.delegate([Q,G,Y,z,K,W,X,$,V,J],function(e){var n=e.type,r=e.target,i,s,o;if(t._FORM_elements[r.get(j)]){e.preventDefault(),s=r.getAttribute(M);if(n===Q||n===G||n===Y)o=new Date,o.setTime(parseInt(s,10)),s=o;i={target:t,value:s,formElement:t._FORM_elements[r.get(j)],buttonNode:r,type:n},t.fire(n,i)}})),n.push(r.delegate("click",function(e){e.preventDefault()},".itsa-widget-parent")),n.push(r.delegate("valuechange",function(e){var n=e.target,r=U,i={target:t,value:n.get(M),formElement:t._FORM_elements[n.get(j)],node:n,nodeid:n.get(j),type:r};t.fire(r,i)},function(e,n){return t._FORM_elements[n.target.get(j)]})),n.push(t.after("*:change",function(n){n.formelement||e.use(m+"dialog",function(){t._lifeUpdate?e.confirm(u,a).then(e.bind(t._modelToUI,t,null),e.bind(t.UIToModel,t,null)):e.confirm(u,f).then(e.bind(t._modelToUI,t,null))})})),n.push(r.delegate("keypress",function(e){e.preventDefault();var n=q,r={target:e.target,type:n};t.fire(n,r)},function(e,n){var r=t._FORM_elements[n.target.get(j)];return r&&n.keyCode===13&&t._focusNextElements[r.type]}))},Z.prototype._clearEventhandlers=function(){n.each(this._eventhandlers,function(e){e.detach()})},Z.prototype._defFnCancel=function(){this.reset()},Z.prototype._defFnDestroy=function(){this.destroyPromise()},Z.prototype._defFnChangeDate=function(t){e.use(m+"datetimepicker",function(){var n=t.target,r=t.type,i=t.buttonNode,o=e.ItsaDateTimePicker,u=t.formElement,a=s.isDate(t.value)?t.value:new Date,f,l,c;r===Q?f=e.bind(o.getDate,o):r===G?f=e.bind(o.getTime,o):r===Y&&(f=e.bind(o.getDateTime,o)),f(new Date(a),{alignToNode:i,modal:!0,forceSelectdate:!1}).then(function(e){l=u.config.format,n._updateDateTimeUI(u.name,e,r,l),n._lifeUpdate&&n.UIToModel(i.get(j))},function(){return!0}).then(function(){var e=q,t={target:i,type:e};i&&(i.removeAttribute(F),i.focus(),c=i.getAttribute(O+"-contentvalid"),c&&i.setAttribute(F,c)),n.fire(e,t)})})},Z.prototype._defFnRemove=function(){this.destroyPromise({remove:!0})},Z.prototype._defFnReset=function(){var e=this;e.reset()},Z.prototype._defFnSubmit=function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.submitPromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(R,{nodelist:n})},Z.prototype._defFnSave=function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.savePromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(R,{nodelist:n})},Z.prototype._defFnUIChanged=function(e){var t=this,r=e.formElement,i=r.name,s=r.type,o=e.value,u,a,f;r.widget?(f=this._getWidgetValueField(s),typeof f===k?t._updateSimularWidgetUI(e.nodeid,i,f,o):n.each(f,function(n){t._updateSimularWidgetUI(e.nodeid,i,n,o,!0)})):(u=e.node,a=t._validValue(u,r,i,o),t._updateSimularUI(u,i,o,a),t._lifeUpdate&&a&&t.UIToModel(u.get(j)))},Z.prototype._garbageCollect=function(){var t=this,i=(new Date).getTime(),s=t._ATTRS_nodes,o=t._FORM_elements,u=t._knownNodeIds,a=[],f,l,c,h;i-=d,r.each(u,function(t,r,u){typeof t===L?e.one("#"+r)||(u[r]=(new Date).getTime()):t<i&&(c=o[r],h=c.name,f=s[h],l=f&&n.indexOf(f,r),delete o[r],l>0&&f.splice(l,1),a.push(r))}),n.each(a,function(e){delete u[e]})},Z.prototype._getWidgetValue=function(e,t){var n=this._getWidgetValueField(t);return e&&e.get(typeof n===k?n:n[0])},Z.prototype._getWidgetValueField=function(e){var t=typeof e=="function"&&e.NAME;return t&&this._widgetValueFields[e.NAME]||M},Z.prototype._modelToUI=function(t){var n=this,i,s,o,u,a,f,l,c,h,p;s=n._FORM_elements,i=t&&s[t],i&&(o=e.one("#"+t))&&o.getAttribute(B)?(f=i.widget,a=i.name,u=n.get(a,u)||"",f?(p=this._getWidgetValueField(i.type),f.set(typeof p===k?p:p[0],u)):(c=i.type,l=c===x||c===T||c===N,l?(h=i.config.format,n._updateDateTimeUI(i.name,u,c,h)):o.set(M,u))):t||r.each(n._FORM_elements,function(e,t){n._modelToUI(t)})},Z.prototype._removeTargets=function(){var e=this;r.each(e._FORM_elements,function(t){var n=t.widget;n&&n.removeTarget(e)})},Z.prototype._removeValidation=function(){var t=this;r.each(t._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&t._setNodeValidation(r,!0)})},Z.prototype._renderBtn=function(e,t,n){var r=this,s=r._FORM_elements,u=r._knownNodeIds,a,f;return t||(t={}),n||(n=_),e||(e=n),t[O]||(t[O]=""),t[O]+=" "+P+'="'+n+'"',t.buttontype=_,t.labelHTML=e,a=o.getElement(_,t),f=a.nodeid,s[f]=a,i.availablePromise("#"+f).then(function(e){u[f]?e.insert(h,"replace"):u[f]=!0}),a.html},Z.prototype._updateDateTimeUI=function(t,r,i,o){var u=this,a=u._ATTRS_nodes[t];a&&(o||(i===x?o="%x":i===T?o="%X":o="%x %X"
),n.each(a,function(t){var n=e.one("#"+t),i=e.one('span[data-for="'+t+'"]'),u=s.isDate(r);u&&n&&n.set(M,r.getTime()),i&&i.set("text",u?e.Date.format(r,{format:o}):"invalid Date: "+r)}))},Z.prototype._updateSimularUI=function(t,r,i,s){var o=this,u=o._ATTRS_nodes[r];u&&n.each(u,function(n){var r=e.one("#"+n);r&&(r!==t&&r.set(M,i),o._setNodeValidation(r,s))}),o._lifeUpdate&&o.UIToModel(t.get(j))},Z.prototype._setNodeValidation=function(e,t,n){var r;e.setAttribute(O+"-valid",t),r=n||e.getAttribute(F+(t?"valid":"invalid")),r?e.setAttribute(F,r):e.removeAttribute(F)},Z.prototype._updateSimularWidgetUI=function(t,r,i,s,o){var u=this,a=u._ATTRS_nodes[r],f,l;a&&n.each(a,function(n){f=u._FORM_elements[n],l=f&&f.widget,(n!==t||o)&&l&&l.set(i,s);if(l&&l.getClassName()==="yui3-slider"){var r=e.one('span[data-for="'+n+'"]');r&&r.set("text",s)}}),u._lifeUpdate&&u.UIToModel(t)},Z.prototype._validValue=function(e,t,n,r){var i=this,s=t.type,o=s===x||s===T||s===N||s==="checkbox",u,a,f,l,c,h,p,d,v;return o||(u=i._getAttrCfg(n),d=u.formconfig,p=d&&d.required,h=typeof p===L&&p||s==="password",v=r===""&&!h,v||(a=u.validator,f=e.getAttribute(O+"-pattern"),l=!a||a(s===C?t.config.digits?parseFloat(r):parseInt(r,10):r),c=!f||(new RegExp(f,"i")).test(r))),o||v||l&&c},Z.prototype._widgetValueFields.itsacheckbox="checked",Z.prototype._widgetValueFields.itsaselectlist="index",Z.prototype._widgetValueFields.toggleButton=["checked","pressed"],Z.prototype._widgetValueFields.editorBase="content",n.each([_,y,b,w,E],function(t){var n={on:function(e,n,r){n._handle=e.on(g,function(e){var n=e.target;n.get("tagName")!=="BUTTON"&&(n=n.get("parentNode"),e.target=n),n.getAttribute(H)===_&&n.getAttribute(P)===t&&r.fire(e)})},detach:function(e,t){t._handle.detach()}};n.delegate=n.on,n.detachDelegate=n.detach,e.Event.define(t+g,n)})},"@VERSION@",{requires:["yui-base","base-base","attribute-base","base-build","model","datatype-date-format","node-base","node-core","oop","node-event-delegate","event-synthetic","event-valuechange","event-base","event-custom","gallery-itsanodepromise","gallery-itsamodelsyncpromise","gallery-itsaformelement"]});
