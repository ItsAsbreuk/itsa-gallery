YUI.add("gallery-itsaformmodel",function(e,t){"use strict";var n=e.Array,r=e.Object,i=e.Node,s=e.Lang,o=e.Intl,u=e.ITSAFormElement,a="notification",f="datachanged",l="wantreload",c="noreloadmsg",h="UNDEFINED FORM-ELEMENT",p="itsa-invisible",d='<span style="background-color:F00; color:#FFF">DUPLICATED FORMELEMENT is not allowed</span>',v=1e4,m=1728e5,g=864e5,y="true",b='i[class^="itsaicon-"], i[class*=" itsaicon-"]',w="itsa-busy",E="itsaicon-form-loading",S="data-spinbusy",x="disabled",T="was-"+x,N="button",C="pure-"+N+"-"+x,k="-before",L='span[data-for="',A="yui3-slider",O="itsabutton-asktoclick",M={button:!0,destroy:!0,remove:!0,reset:!0,save:!0,submit:!0,load:!0},_="gallery-itsa",D=_+"formmodel",P="function",H="renderpromise",B="click",j="save",F="load",I="destroy",q="remove",R="submit",U="date",z="time",W=U+z,X="number",V="string",$="boolean",J="picker",K="data",Q="value",G="type",Y=K+"-"+N+"sub"+G,Z=K+"-"+N+G,et=K+"-modelattribute",tt="id",nt=K+"-content",rt={text:!0,number:!0,password:!0,textarea:!0,email:!0,url:!0},it="reset",st="focusnext",ot="validationerror",ut="uichanged",at=N+":"+B,ft=I+":"+B,lt=q+":"+B,ct=R+":"+B,ht=it+":"+B,pt=j+":"+B,dt=F+":"+B,vt=U+J+B,mt=z+J+B,gt=U+z+J+B,yt=e.ITSAFormModel=e.Base.create("itsaformmodel",e.Model,[],{},{_ATTR_CFG:["formtype","formconfig","validationerror"]});yt.prototype._widgetValueFields={},yt.prototype._allowedFormTypes={text:!0,number:!0,password:!0,textarea:!0,checkbox:!0,date:!0,time:!0,datetime:!0,email:!0,url:!0,plain:!0},yt.prototype._dateTimeTypes={date:!0,time:!0,datetime:!0},yt.prototype._datePickerClicks={datepickerclick:!0,timepickerclick:!0,datetimepickerclick:!0},yt.prototype.initializer=function(){var t=this;t._eventhandlers=[],t._FORM_elements={},t._ATTRS_nodes={},t._knownNodeIds={},t._lifeUpdate=!1,t._intl=o.get(D),t._renderBtnFns={button:t.renderBtn,destroy:t.renderDestroyBtn,remove:t.renderRemoveBtn,reset:t.renderResetBtn,save:t.renderSaveBtn,load:t.renderLoadBtn,submit:t.renderSubmitBtn},t.publish(ut,{defaultFn:e.bind(t._defFn_uichanged,t),emitFacade:!0}),t.publish(ft,{defaultFn:e.bind(t._defFn_destroy,t),emitFacade:!0}),t.publish(lt,{defaultFn:e.bind(t._defFn_remove,t),emitFacade:!0}),t.publish(ct,{defaultFn:e.bind(t._defFn_submit,t),emitFacade:!0}),t.publish(ht,{defaultFn:e.bind(t._defFn_reset,t),emitFacade:!0}),t.publish(pt,{defaultFn:e.bind(t._defFn_save,t),emitFacade:!0}),t.publish(dt,{defaultFn:e.bind(t._defFn_load,t),emitFacade:!0}),t.publish(vt,{defaultFn:e.bind(t._defFn_changedate,t),emitFacade:!0}),t.publish(mt,{defaultFn:e.bind(t._defFn_changedate,t),emitFacade:!0}),t.publish(gt,{defaultFn:e.bind(t._defFn_changedate,t),emitFacade:!0}),t._bindUI(),t._gcTimer=e.later(g,t,t._garbageCollect,null,!0)},yt.prototype.crossValidation=function(){},yt.prototype.disableUI=function(){var t=this,n=t._FORM_elements;r.each(n,function(t,n){var r=e.one("#"+n),i=t.widget,s,o,u,a;r&&(i?(o=i.get(x),o||(i.disable(),i.getClassName()===A&&(u=e.one(L+n+'"]'),u&&u.setAttribute(x,x)))):(s=r.get("tagName")==="BUTTON"&&r.getAttribute(G)===N,a=r.getAttribute("data-datetimepicker")===y,o=r.get(x),s&&(o=o||r.hasClass(C),o||r.addClass(C)),o||r.setAttribute(x,x),r.setData(T,o),a&&(u=e.one(L+n+'"]'),u&&u.setAttribute(x,x))),o&&r.setData(k,!0))})},yt.prototype.enableUI=function(){var t=this,n=t._FORM_elements;r.each(n,function(t,n){var r=e.one("#"+n),i=t.widget,s,o,u,a;r&&(o=r.getData(k),o?r.clearData(k):i?(i.enable(),i.getClassName()===A&&(u=e.one(L+n+'"]'),u&&u.removeAttribute(x))):(s=r.get("tagName")==="BUTTON"&&r.getAttribute(G)===N,a=r.getAttribute("data-datetimepicker")===y,r.getData(T)||(r.removeAttribute(x),s&&r.removeClass(C)),r.clearData(T),a&&(u=e.one(L+n+'"]'),u&&u.removeAttribute(x))))})},yt.prototype.getCurrentFormElement=function(e){return this.getCurrentFormElements(e)[0]||null},yt.prototype.getCurrentFormElements=function(t){var i=this,s=i._ATTRS_nodes[t],o=[],u;return s?n.each(s,function(t){var n=e.one("#"+t);n&&(u=i._FORM_elements[t],u.node=n,o.push(u))}):r.each(i._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&r.getAttribute("name")===t&&(n.node=r,o.push(n))}),o},yt.prototype.getUI=function(t){var n=this,r,i,o,u,a,f,l,c;return u=n._ATTRS_nodes[t],o=u&&u.length>0&&u[0],i=n._FORM_elements,r=o&&i[o],r&&(a=e.one("#"+o))&&a.getAttribute(et)&&(l=r.widget,c=r.type,f=l?n._getWidgetValue(l,c):a.get(Q),s.isValue(f)&&(n._dateTimeTypes[c]&&(f=new Date(parseInt(f,10))),c===X&&(f=r.config.digits?parseFloat(f):parseInt(f,10)))),f},yt.prototype.getUnvalidatedUI=function(){var t=this,i,o,u,a=[];return r.each(this._FORM_elements,function(n){n.widget||(i=e.one("#"+n.nodeid),i&&(o=t._validValue(i,n,n.name,i.get(Q)),t._setNodeValidation(i,o),o||a.push(i)))}),u=t.crossValidation(),s.isArray(u)&&u.length>0&&n.each(u,function(r){var i=r.attribute,s=i&&t._ATTRS_nodes[i];s&&n.each(s,function(n){var i=e.one("#"+n),s=r.validationerror,o;i&&(o=typeof s===V?s:null,t._setNodeValidation(i,!1,o),a.push(i))})}),new e.NodeList(a)},yt.prototype[q]=function(){this.fire(q)},yt.prototype.renderBtn=function(e,t){return this._renderBtn(e,t,N)},yt.prototype.renderDestroyBtn=function(e,t){return this._renderBtn(e,t,I)},yt.prototype.renderLoadBtn=function(e,t){return this._renderBtn(e,t,F)},yt.prototype.renderRemoveBtn=function(e,t){return this._renderBtn(e,t,q)},yt.prototype.renderResetBtn=function(e,t){return this._renderBtn(e,t,it)},yt.prototype.renderSaveBtn=function(e,t){return this._renderBtn(e,t,j)},yt.prototype.renderSubmitBtn=function(e,t){return this._renderBtn(e,t,R)},yt.prototype.renderFormElement=function(t){var r=this,s=r._knownNodeIds,o,a,f,l,c,m,g,y,b,w,E,S,x,T;return o=r._FORM_elements,a=r._ATTRS_nodes,f=r.get(t),l=r._getAttrCfg(t),g=l.formtype||"text",S=typeof g===P&&g.NAME,S||r._allowedFormTypes[g]?(y=l.formconfig||{},y.value=f,S&&(b=r._getWidgetValueField(g),y.widgetconfig||(y.widgetconfig={}),x=typeof b!==V,x?n.each(b,function(e){y.widgetconfig[e]=f}):y.widgetconfig[b]=f),y.modelattribute=!0,y.name=t,y.tooltipinvalid=l.validationerror,y.removerequired=!0
,delete y.pattern,y.removepattern=!0,y.hideatstartup=!0,c=u.getElement(g,y),w=c.nodeid,o[w]=c,a[t]||(a[t]=[]),a[t].push(w),E=c.widget,E?(T=g.NAME==="editorBase",e.use(T?_+"editor"+H:_+"widget"+H,function(){E.renderPromise().then(function(){var t=e.one("#"+w);s[w]?t.insert(d,"replace"):(s[w]=!0,T&&t.removeClass(p),r._modelToUI(w),!T&&t.removeClass(p))})}),x?n.each(b,function(t){r._eventhandlers.push(E.after(t+"Change",function(t){var n=ut,i={target:r,value:t.newVal,formElement:c,node:e.one("#"+w),nodeid:w,type:n};r.fire(n,i)}))}):r._eventhandlers.push(E.after(b+"Change",function(t){var n=ut,i={target:r,value:t.newVal,formElement:c,node:e.one("#"+w),nodeid:w,type:n};r.fire(n,i)}))):i.availablePromise("#"+w,v).then(function(t){s[w]?t.insert(d,"replace"):(s[w]=!0,r._modelToUI(w),t.removeClass(p),r._dateTimeTypes[g]&&(t=e.one('span.formatvalue[data-for="'+w+'"]'),t&&t.removeClass(p)))},function(e){}),m=c.html,c.widget&&c.widget.addTarget(r)):m=h,m},yt.prototype.reset=function(){var e=this,t;e._internalChange=!0,e.constructor.superclass.constructor.superclass.reset.apply(e,arguments),arguments.length===0&&(e._internalChange=null,e._modelToUI(),e._removeValidation(),t={type:it,target:e},e.fire(it,t))},yt.prototype.setLifeUpdate=function(e){var t=this;return typeof e===$&&(t._lifeUpdate=e),t},yt.prototype.setResetAttrs=function(){var e=this,t=e.getAttrs();delete t.clientId,delete t.destroyed,delete t.initialized,e.idAttribute!==tt&&delete t.id,r.each(t,function(t,n){t&&e._state.add(n,"initValue",t)})},yt.prototype.setWidgetValueField=function(e,t){this._widgetValueFields[e]=t},yt.prototype[R]=function(){this.fire(R)},yt.prototype.toJSONUI=function(t){var i=this,o={},u=i.getAttrs(),a=i._renderBtnFns,f,l,c,h;return delete u.clientId,delete u.destroyed,delete u.initialized,i.idAttribute!==tt&&delete u.id,r.each(u,function(e,t){o[t]=i.renderFormElement(t)}),s.isObject(t)?(f=t.propertykey,l=t.type,c=t.labelHTML,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())):s.isArray(t)&&n.each(t,function(t){f=t.propertykey,l=t.type,c=t.labelHTML,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())}),o},yt.prototype.UIToModel=function(t){var n=this,i,o,u,a,f,l,c,h;o=n._FORM_elements,i=t&&o[t],i&&(a=e.one("#"+t))&&a.getAttribute(et)?(c=i.widget,h=i.type,f=c?n._getWidgetValue(c,h):a.get(Q),l=i.name,s.isValue(f)&&(u={formelement:!0},n._dateTimeTypes[h]&&(f=new Date(parseInt(f,10))),h===X&&(f=i.config.digits?parseFloat(f):parseInt(f,10)),n.set(l,f,u))):t||r.each(n._FORM_elements,function(e,t){n.UIToModel(t)})},yt.prototype.destructor=function(){var e=this;e._clearEventhandlers(),e._removeTargets(),e._FORM_elements={},e._ATTRS_nodes={},e._widgetValueFields={},e._knownNodeIds={},e._gcTimer.cancel()},yt.prototype._bindUI=function(){var t=this,n=t._eventhandlers,r=e.one("body");n.push(r.delegate([vt,mt,gt,at,dt,pt,ft,lt,ct,ht],function(e){var n=e.type,r=e.target,i,s,o;t._FORM_elements[r.get(tt)]&&(e.preventDefault(),s=r.getAttribute(Q),t._datePickerClicks[n]&&(o=new Date,o.setTime(parseInt(s,10)),s=o),i={target:t,value:s,formElement:t._FORM_elements[r.get(tt)],buttonNode:r,type:n},t.fire(n,i))})),n.push(r.delegate("click",function(e){e.preventDefault()},".itsa-widget-parent")),n.push(r.delegate("valuechange",function(e){var n=e.target,r=ut,i={target:t,value:n.get(Q),formElement:t._FORM_elements[n.get(tt)],node:n,nodeid:n.get(tt),type:r};t.fire(r,i)},function(e,n){return n&&n.target&&t._FORM_elements[n.target.get(tt)]})),n.push(t.after("*:change",function(n){!t._internalChange&&!n.formelement&&!n.fromInternal?e.use(_+"dialog",function(){var n=t._intl;t._lifeUpdate?e.confirm(n[a],n[f]+"<br />"+n[l]+"? ("+n[c]+").").then(e.bind(t._modelToUI,t,null),e.bind(t.UIToModel,t,null)):e.confirm(n[a],n[f]+"<br />"+n[l]+"?").then(e.bind(t._modelToUI,t,null))}):n.fromInternal&&t._modelToUI()})),n.push(r.delegate("keypress",function(e){var n=st,r={target:e.target,type:n};t.fire(n,r)},function(e,n){var r=t._FORM_elements[n.target.get(tt)];return r&&n.keyCode===13&&rt[r.type]})),n.push(e.Intl.after("intl:langChange",function(){t._intl=e.Intl.get(D)})),n.push(e.on(O,function(e){var n=e.buttonNode,r;t._FORM_elements[n.get("id")]&&(r=n.get("value"),t.fire((M[r]?r:N)+":click",{buttonNode:n,value:r}))}))},yt.prototype._clearEventhandlers=function(){n.each(this._eventhandlers,function(e){e.detach()})},yt.prototype._defFn_destroy=function(){this.destroyPromise()},yt.prototype._defFn_changedate=function(t){e.use(_+"datetimepicker",function(){var n=t.target,r=t.type,i=t.buttonNode,o=e.ItsaDateTimePicker,u=t.formElement,a=s.isDate(t.value)?t.value:new Date,f,l,c;r===vt?f=e.bind(o.getDate,o):r===mt?f=e.bind(o.getTime,o):r===gt&&(f=e.bind(o.getDateTime,o)),f(new Date(a),{alignToNode:i,modal:!0,forceSelectdate:!1}).then(function(e){l=u.config.format,n._updateDateTimeUI(u.name,e,r,l),n._lifeUpdate&&n.UIToModel(i.get(tt))},function(){return!0}).then(function(){var e=st,t={target:i,type:e};i&&(i.removeAttribute(nt),i.focus(),c=i.getAttribute(K+"-contentvalid"),c&&i.setAttribute(nt,c)),n.fire(e,t)})})},yt.prototype._defFn_load=function(t){var n=this,r=t.buttonNode,i=r.one(b),s=i&&t.buttonNode.getAttribute(S)===y;n.disableUI(),s&&i.addClass(w).addClass(E),n.loadPromise({fromInternal:!0}).then(function(){n.setResetAttrs(),r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())},function(){r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())})},yt.prototype._defFn_remove=function(t){var n=this,r=t.buttonNode,i=r.one(b),s=i&&t.buttonNode.getAttribute(S)===y;n.disableUI(),s&&i.addClass(w).addClass(E),n.destroyPromise({remove:!0}).then(function(){r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())},function(){r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())})},yt.prototype._defFn_reset=function(){var e=this;e.reset()},yt.prototype._defFn_save=function(t){var n=this,r=t.buttonNode,i=r.one(b),s=i&&t.buttonNode.getAttribute(S)===y,o,u;u=n.getUnvalidatedUI(),u.isEmpty
()?(n.disableUI(),s&&i.addClass(w).addClass(E),o=n.getAttrs(),n.UIToModel(),n.savePromise().then(function(){n.setResetAttrs(),r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())},function(){n.setAttrs(o),r=e.one("#"+r.get("id")),r&&(n._modelToUI(),s&&i.removeClass(w).removeClass(E),n.enableUI())})):n.fire(ot,{nodelist:u})},yt.prototype._defFn_submit=function(t){var n=this,r=t.buttonNode,i=r.one(b),s=i&&t.buttonNode.getAttribute(S)===y,o,u;u=n.getUnvalidatedUI(),u.isEmpty()?(n.disableUI(),s&&i.addClass(w).addClass(E),o=n.getAttrs(),n.UIToModel(),n.submitPromise().then(function(){r=e.one("#"+r.get("id")),r&&(s&&i.removeClass(w).removeClass(E),n.enableUI())},function(){n.setAttrs(o),r=e.one("#"+r.get("id")),r&&(n._modelToUI(),s&&i.removeClass(w).removeClass(E),n.enableUI())})):n.fire(ot,{nodelist:u})},yt.prototype._defFn_uichanged=function(e){var t=this,r=e.formElement,i=r.name,s=r.type,o=e.value,u,a,f;r.widget?(f=this._getWidgetValueField(s),typeof f===V?t._updateSimularWidgetUI(e.nodeid,i,f,o):n.each(f,function(n){t._updateSimularWidgetUI(e.nodeid,i,n,o,!0)})):(u=e.node,a=t._validValue(u,r,i,o),t._updateSimularUI(u,i,o,a),t._lifeUpdate&&a&&t.UIToModel(u.get(tt)))},yt.prototype._garbageCollect=function(){var t=this,i=(new Date).getTime(),s=t._ATTRS_nodes,o=t._FORM_elements,u=t._knownNodeIds,a=[],f,l,c,h;i-=m,r.each(u,function(t,r,u){typeof t===$?e.one("#"+r)||(u[r]=(new Date).getTime()):t<i&&(c=o[r],h=c.name,f=s[h],l=f&&n.indexOf(f,r),delete o[r],l>0&&f.splice(l,1),a.push(r))}),n.each(a,function(e){delete u[e]})},yt.prototype._getWidgetValue=function(e,t){var n=this._getWidgetValueField(t);return e&&e.get(typeof n===V?n:n[0])},yt.prototype._getWidgetValueField=function(e){var t=typeof e===P&&e.NAME;return t&&this._widgetValueFields[e.NAME]||Q},yt.prototype._modelToUI=function(t){var n=this,i,s,o,u,a,f,l,c,h;s=n._FORM_elements,i=t&&s[t],i&&(o=e.one("#"+t))&&o.getAttribute(et)?(f=i.widget,a=i.name,u=n.get(a,u)||"",f?(h=this._getWidgetValueField(i.type),f.set(typeof h===V?h:h[0],u)):(l=i.type,n._dateTimeTypes[l]?(c=i.config.format,n._updateDateTimeUI(i.name,u,l,c)):o.set(Q,u))):t||r.each(n._FORM_elements,function(e,t){n._modelToUI(t)})},yt.prototype._removeTargets=function(){var e=this;r.each(e._FORM_elements,function(t){var n=t.widget;n&&n.removeTarget(e)})},yt.prototype._removeValidation=function(){var t=this;r.each(t._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&t._setNodeValidation(r,!0)})},yt.prototype._renderBtn=function(e,t,n){var r=this,s=r._FORM_elements,o=r._knownNodeIds,a,f;return t||(t={}),n||(n=N),e||(e=n),t[K]||(t[K]=""),t[Q]||(t[Q]=n),t[K]+=" "+Y+'="'+n+'"',t.buttontype=N,t.labelHTML=e,a=u.getElement(N,t),f=a.nodeid,s[f]=a,i.availablePromise("#"+f).then(function(e){o[f]?e.insert(d,"replace"):o[f]=!0}),a.html},yt.prototype._updateDateTimeUI=function(t,r,i,o){var u=this,a=u._ATTRS_nodes[t];a&&(o||(i===U?o="%x":i===z?o="%X":o="%x %X"),n.each(a,function(t){var n=e.one("#"+t),i=e.one('span[data-for="'+t+'"]'),u=s.isDate(r);u&&n&&n.set(Q,r.getTime()),i&&i.set("text",u?e.Date.format(r,{format:o}):"invalid Date: "+r)}))},yt.prototype._updateSimularUI=function(t,r,i,s){var o=this,u=o._ATTRS_nodes[r];u&&n.each(u,function(n){var r=e.one("#"+n);r&&(r!==t&&r.set(Q,i),o._setNodeValidation(r,s))})},yt.prototype._setNodeValidation=function(e,t,n){var r;e.setAttribute(K+"-valid",t),r=n||e.getAttribute(nt+(t?"valid":"invalid")),r?e.setAttribute(nt,r):e.removeAttribute(nt)},yt.prototype._updateSimularWidgetUI=function(t,r,i,s,o){var u=this,a=u._ATTRS_nodes[r],f,l;a&&n.each(a,function(n){f=u._FORM_elements[n],l=f&&f.widget,(n!==t||o)&&l&&l.set(i,s);if(l&&l.getClassName()===A){var r=e.one('span[data-for="'+n+'"]');r&&r.set("text",s)}}),u._lifeUpdate&&u.UIToModel(t)},yt.prototype._validValue=function(e,t,n,r){var i=this,s=t.type,o=s===U||s===z||s===W||s==="checkbox",u,a,f,l,c,h,p,d,v,m;return o||(u=i._getAttrCfg(n),d=u.formconfig,p=d&&d.required,h=typeof p===$&&p||s==="password",v=r===""&&!h,v||(a=u.validator,f=e.getAttribute(K+"-pattern"),l=!a||a(s===X?t.config.digits?parseFloat(r):parseInt(r,10):r),c=!f||(new RegExp(f,"i")).test(r),m=r!==""||!h)),o||v||l&&c&&m},yt.prototype._widgetValueFields.itsacheckbox="checked",yt.prototype._widgetValueFields.itsaselectlist="index",yt.prototype._widgetValueFields.toggleButton=["checked","pressed"],yt.prototype._widgetValueFields.editorBase="content",n.each([N,j,I,q,F],function(t){var n={on:function(e,n,r){n._handle=e.on(B,function(e){var n=e.target;n&&n.get("tagName")!=="BUTTON"&&(n=n.get("parentNode"),e.target=n),n&&n.getAttribute(Z)===N&&n.getAttribute(Y)===t&&r.fire(e)})},detach:function(e,t){t._handle.detach()}};n.delegate=n.on,n.detachDelegate=n.detach,e.Event.define(t+":"+B,n)})},"@VERSION@",{requires:["yui-base","intl","base-base","attribute-base","base-build","selector-css2","model","datatype-date-format","node-base","node-style","node-core","oop","yui-later","node-event-delegate","event-valuechange","event-synthetic","event-base","event-custom","gallery-itsanodepromise","gallery-itsamodelsyncpromise","gallery-itsaformelement"],lang:["ar","de","en","es","fr","hu","it","ja","nb","nl","pt","ru","zh"]});
