YUI.add("gallery-itsaformmodel",function(e,t){"use strict";var n=e.Array,r=e.Object,i=e.Lang,s=e.ITSAFormElement,o="Data has been changed outside the form. Load it into the formelements? (if not, then the data will be reset to the current form-values)",u="Data has been changed outside the form. Load it into the formelements?",a="UNDEFINED FORM-ELEMENT",f="click",l="save",c="destroy",h="remove",p="cancel",d="submit",v="reset",m="date",g="time",y="picker",b="data",w="value",E="button",S="type",x=b+"-"+E+"sub"+S,T=b+"-"+E+S,N="focusnext",C="validationerror",k="uichanged",L=E+f,A=c+f,O=h+f,M=d+f,_=p+f,D=v+f,P=l+f,H=m+y+f,B=g+y+f,j=m+g+y+f;e.ITSAFormModel=e.Base.create("itsaformmodel",e.Model,[],{_widgetValueFields:{},_allowedFormTypes:{text:!0,number:!0,password:!0,textarea:!0,checkbox:!0,date:!0,time:!0,datetime:!0,email:!0,url:!0},initializer:function(){var t=this;t._eventhandlers=[],t._FORM_elements={},t._ATTRS_nodes={},t._bkpAttrs=t.getAttrs(),t._lifeUpdate=!1,t._focusNextElements={text:!0,number:!0,password:!0,textarea:!0,email:!0,url:!0},t.publish(N,{defaultFn:e.bind(t.defFnFocusNext,t),emitFacade:!0}),t.publish(k,{defaultFn:e.bind(t._defFnUIChanged,t),emitFacade:!0}),t.publish(A,{defaultFn:e.bind(t._defFnDestroy,t),emitFacade:!0}),t.publish(O,{defaultFn:e.bind(t._defFnRemove,t),emitFacade:!0}),t.publish(M,{defaultFn:e.bind(t._defFnSubmit,t),emitFacade:!0}),t.publish(_,{defaultFn:e.bind(t._defFnCancel,t),emitFacade:!0}),t.publish(D,{defaultFn:e.bind(t._defFnReset,t),emitFacade:!0}),t.publish(P,{defaultFn:e.bind(t._defFnSave,t),emitFacade:!0}),t.publish(H,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(B,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(j,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t._bindUI()},defFnFocusNext:function(){},getUnvalidatedUI:function(){var t=this,n,i,s=[];return r.each(this._FORM_elements,function(r){r.widget||(n=e.one("#"+r.nodeid),n&&(i=t._validValue(n,r,r.name,n.get("value")),n.setAttribute("data-valid",i),i||s.push(n)))}),new e.NodeList(s)},renderBtn:function(e,t){return this._renderBtn(e,t,E,!0)},renderCancelBtn:function(e,t){return this._renderBtn(e,t,p,!0)},renderDestroyBtn:function(e,t){return this._renderBtn(e,t,c,!0)},renderRemoveBtn:function(e,t){return this._renderBtn(e,t,h,!0)},renderResetBtn:function(e,t){return this._renderBtn(e,t,v)},renderSaveBtn:function(e,t){return this._renderBtn(e,t,l,!0)},renderSubmitBtn:function(e,t){return this._renderBtn(e,t,d)},renderFormElement:function(t){var r=this,i,o,u,f,l,c,h,p,d,v,m,g,y;return i=r._FORM_elements,o=r._ATTRS_nodes,u=r.get(t),f=r._getAttrCfg(t),h=f.formtype||"text",g=typeof h=="function"&&h.prototype.BOUNDING_TEMPLATE,g||r._allowedFormTypes[h]?(p=f.formconfig||{},p.value=u,g&&(d=r._getWidgetValueField(h),p.widgetconfig||(p.widgetconfig={}),y=typeof d!="string",y?n.each(d,function(e){p.widgetconfig[e]=u}):p.widgetconfig[d]=u),p.modelattribute=!0,p.name=t,p.required=!1,p.removepattern=!0,l=s.getElement(h,p),v=l.nodeid,i[v]=l,o[t]||(o[t]=[]),o[t].push(v),m=l.widget,m&&(y?n.each(d,function(t){r._eventhandlers.push(m.after(t+"Change",function(t){var n=k,i={target:r,value:t.newVal,formElement:l,node:e.one("#"+v),nodeid:v,type:n};r.fire(n,i)}))}):r._eventhandlers.push(m.after(d+"Change",function(t){var n=k,i={target:r,value:t.newVal,formElement:l,node:e.one("#"+v),nodeid:v,type:n};r.fire(n,i)}))),c=l.html,l.widget&&l.widget.addTarget(r)):c=a,c},setLifeUpdate:function(e){var t=this;return typeof e=="boolean"&&(t._lifeUpdate=e),t},setResetAttrs:function(){var e=this;e._bkpAttrs=e.getAttrs()},setWidgetValueField:function(e,t){this._widgetValueFields[e]=t},UIToModel:function(t){var n=this,s,o,u,a,f,l,c,h;o=n._FORM_elements,s=t&&o[t],s&&(a=e.one("#"+t))&&a.getData("modelattribute")?(c=s.widget,h=s.type,f=c?n._getWidgetValue(c,h):a.get(w),console.log("to model "+f),l=s.name,i.isValue(f)&&(u={formelement:!0},(h==="date"||h==="time"||h==="date")&&(f=new Date(parseInt(f,10))),h==="number"&&(f=s.config.digits?parseFloat(f):parseInt(f,10)),n.set(l,f,u))):t||r.each(n._FORM_elements,function(e,t){n.UIToModel(t)})},destructor:function(){var e=this;e._autoSaveTimer&&e._autoSaveTimer.cancel(),e._fireEventTimer&&e._fireEventTimer.cancel(),e._clearEventhandlers(),e._removeTargets(),e._FORM_elements={},e._ATTRS_nodes={},e._focusNextElements={}},_bindUI:function(){var t=this,n=t._eventhandlers,r=e.one("body");n.push(r.delegate([H,B,j,L,P,A,O,_,M,D],function(e){e.preventDefault();var n=e.target,r=e.type,i=n.getAttribute(w),s={target:t,value:r===H||r===B||r===j?(new Date).setTime(parseInt(i,10)):i,formElement:t._FORM_elements[n.get("id")],buttonNode:n,type:r};t.fire(r,s)},function(e,n){return t._FORM_elements[n.target.get("id")]})),n.push(r.delegate("click",function(e){e.preventDefault()},".itsa-widget-parent")),n.push(r.delegate("valuechange",function(e){var n=e.target,r=k,i={target:t,value:n.get(w),formElement:t._FORM_elements[n.get("id")],node:n,nodeid:n.get("id"),type:r};t.fire(r,i)},function(e,n){return t._FORM_elements[n.target.get("id")]})),n.push(t.after("*:change",function(n){n.formelement||e.use("gallery-itsadialog",function(){t._lifeUpdate?e.confirm(o).then(e.bind(t._modelToUI,t,null),e.bind(t.UIToModel,t,null)):e.confirm(u).then(e.bind(t._modelToUI,t,null))})})),n.push(r.delegate("keypress",function(e){e.preventDefault();var n=N,r={target:e.target,type:n};t.fire(n,r)},function(e,n){var r=t._FORM_elements[n.target.get("id")];return r&&n.keyCode===13&&t._focusNextElements[r.type]}))},_clearEventhandlers:function(){n.each(this._eventhandlers,function(e){e.detach()})},_defFnCancel:function(){var e=this;e.setAttrs(e._bkpAttrs)},_defFnDestroy:function(){this.destroyPromise()},_defFnChangeDate:function(t){e.use("gallery-itsadatetimepicker",function(){var n=t.target,r=t.type,s=t.buttonNode,o=e.ItsaDateTimePicker,u=t.formElement,a=i.isDate(t.value)?t.value:new Date,f,l;r===H?f=e.bind(o.getDate,o):r===B?f=e.bind(o.getTime,o):r===j&&(f=e.bind(o.getDateTime,o)),f(new Date(a),u.
config).then(function(e){l=u.config.format,n._updateDateTimeUI(u.name,e,r,l),n._lifeUpdate&&n.UIToModel(s.get("id"))},function(){return!0}).then(function(){s&&s.focus()})})},_defFnRemove:function(){this.destroyPromise({remove:!0})},_defFnReset:function(){var e=this;e.setAttrs(e._bkpAttrs),e._modelToUI(),e._removeValidation()},_defFnSubmit:function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.submitPromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(C,{nodelist:n})},_defFnSave:function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.savePromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(C,{nodelist:n})},_defFnUIChanged:function(e){var t=this,n=e.formElement,r=n.name,i=n.type,s=e.value,o,u;n.widget?t._updateSimularWidgetUI(e.nodeid,r,t._getWidgetValueField(i),s):(o=e.node,u=t._validValue(o,n,r,s),t._updateSimularUI(o,r,s,u),t._lifeUpdate&&u&&t.UIToModel(o.get("id")))},_getWidgetValue:function(e,t){var n=this._getWidgetValueField(t);return console.log("_getWidgetValue "+e),console.log("_getWidgetValue "+n),console.log("typeof field "+typeof n),console.log("_getWidgetValue "+n[1]),console.log("_getWidgetValue "+(e&&e.get(typeof n=="string"?n:n[1]))),e&&e.get(typeof n=="string"?n:n[1])},_getWidgetValueField:function(e){var t=typeof e=="function"&&e.prototype.BOUNDING_TEMPLATE;return t&&this._widgetValueFields[e.NAME]||"value"},_modelToUI:function(t){var n=this,i,s,o,u,a,f,l,c,h;s=n._FORM_elements,i=t&&s[t],i&&(o=e.one("#"+t))&&o.getData("modelattribute")?(f=i.widget,a=i.name,u=n.get(a,u),f?f.set(n._getWidgetValueField(i.type),u):(c=i.type,l=c==="date"||c==="time"||c==="datetime",l?(h=i.config.format,n._updateDateTimeUI(i.name,u,c,h)):o.set("value",u))):t||r.each(n._FORM_elements,function(e,t){n._modelToUI(t)})},_removeTargets:function(){var e=this;r.each(e._FORM_elements,function(t){var n=t.widget;n&&n.removeTarget(e)})},_removeValidation:function(){r.each(this._FORM_elements,function(t){var n=e.one("#"+t.nodeid);n&&n.removeAttribute("data-valid")})},_renderBtn:function(e,t,n,r){var i=this,o,u;return t||(t={}),n||(n=E),e||(e=n),u=t.value||e,t.buttonText=e,t.data||(t.data=""),r&&(t.data+=" "+x+'="'+n+'"'),o=s.getElement(n===d||n===v?n:E,t),i._FORM_elements[o.nodeid]=o,o.html},_updateDateTimeUI:function(t,r,i,s){var o=this,u=o._ATTRS_nodes[t];u&&(s||(i==="date"?s="%x":i==="time"?s="%X":s="%x %X"),n.each(u,function(t){var n=e.one('span[data-for="'+t+'"]');n&&n.set("text",e.Date.format(r,{format:s}))}))},_updateSimularUI:function(t,r,i,s){var o=this,u=o._ATTRS_nodes[r];u&&n.each(u,function(n){var r=e.one("#"+n);r&&(r!==t&&r.set("value",i),r.setAttribute("data-valid",s))}),o._lifeUpdate&&o.UIToModel(t.get("id"))},_updateSimularWidgetUI:function(t,r,i,s){var o=this,u=o._ATTRS_nodes[r],a,f;u&&n.each(u,function(n){a=o._FORM_elements[n],f=a&&a.widget,n!==t&&f&&f.set(i,s);if(f&&f.getClassName()==="yui3-slider"){var r=e.one('span[data-for="'+n+'"]');r&&r.set("text",s)}}),o._lifeUpdate&&o.UIToModel(t)},_validValue:function(e,t,n,r){var i=this,s=t.type,o=s==="date"||s==="time"||s==="datetime"||s==="checkbox",u,a,f,l,c;return o||(u=i._getAttrCfg(n),a=u.validator,f=e.getAttribute("data-pattern"),l=!a||a(s==="number"?t.config.digits?parseFloat(r):parseInt(r,10):r),c=!f||(new RegExp(f,"i")).test(r)),o||l&&c}},{_ATTR_CFG:["formtype","formconfig"]}),e.ITSAFormModel.prototype._widgetValueFields.itsacheckbox="checked",e.ITSAFormModel.prototype._widgetValueFields.itsaselectlist="index",e.ITSAFormModel.prototype._widgetValueFields.toggleButton=["checked","pressed"],n.each([E,l,c,h,p],function(t){e.Event.define(t+f,{on:function(e,n,r){n._handle=e.on(f,function(e){var n=e.target;n.getAttribute(T)===E&&n.getAttribute(x)===t&&r.fire(e)})},detach:function(e,t){t._handle.detach()},delegate:function(e,n,r,i){n._delegatehandle=e.on(f,function(e){var n=e.target;i&&n.getAttribute(T)===E&&n.getAttribute(x)===t&&r.fire(e)},i)},detachDelegate:function(e,t){t._delegatehandle.detach()}})})},"@VERSION@",{requires:["yui-base","base-base","attribute-base","base-build","model","datatype-date-format","node-base","node-core","oop","node-event-delegate","event-synthetic","event-valuechange","event-base","gallery-itsamodelsyncpromise","gallery-itsaformelement"]});
