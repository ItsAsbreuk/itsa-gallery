YUI.add("gallery-itsaformmodel",function(e,t){"use strict";var n=e.Array,r=e.Object,i=e.Node,s=e.Lang,o=e.ITSAFormElement,u="Data has been changed outside the form.<br />Load it into the form? (if not, then the data will be reset to the current form-values)",a="Data has been changed outside the form.<br />Load it into the form?",f="UNDEFINED FORM-ELEMENT",l="itsa-invisible",c="click",h="save",p="destroy",d="remove",v="cancel",m="submit",g="reset",y="date",b="time",w="picker",E="data",S="value",x="button",T="type",N=E+"-"+x+"sub"+T,C=E+"-"+x+T,k="focusnext",L="validationerror",A="uichanged",O=x+c,M=p+c,_=d+c,D=m+c,P=v+c,H=g+c,B=h+c,j=y+w+c,F=b+w+c,I=y+b+w+c;e.ITSAFormModel=e.Base.create("itsaformmodel",e.Model,[],{_widgetValueFields:{},_knownNodeIds:{},_allowedFormTypes:{text:!0,number:!0,password:!0,textarea:!0,checkbox:!0,date:!0,time:!0,datetime:!0,email:!0,url:!0,plain:!0},initializer:function(){var t=this;t._eventhandlers=[],t._FORM_elements={},t._ATTRS_nodes={},t._bkpAttrs=t.getAttrs(),t._lifeUpdate=!1,t._focusNextElements={text:!0,number:!0,password:!0,textarea:!0,email:!0,url:!0},t._renderBtnFns={button:t.renderBtn,cancel:t.renderCancelBtn,destroy:t.renderDestroyBtn,remove:t.renderRemoveBtn,reset:t.renderResetBtn,save:t.renderSaveBtn,submit:t.renderSubmitBtn},t.publish(k,{defaultFn:e.bind(t.defFnFocusNext,t),emitFacade:!0}),t.publish(A,{defaultFn:e.bind(t._defFnUIChanged,t),emitFacade:!0}),t.publish(M,{defaultFn:e.bind(t._defFnDestroy,t),emitFacade:!0}),t.publish(_,{defaultFn:e.bind(t._defFnRemove,t),emitFacade:!0}),t.publish(D,{defaultFn:e.bind(t._defFnSubmit,t),emitFacade:!0}),t.publish(P,{defaultFn:e.bind(t._defFnCancel,t),emitFacade:!0}),t.publish(H,{defaultFn:e.bind(t._defFnReset,t),emitFacade:!0}),t.publish(B,{defaultFn:e.bind(t._defFnSave,t),emitFacade:!0}),t.publish(j,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(F,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t.publish(I,{defaultFn:e.bind(t._defFnChangeDate,t),emitFacade:!0}),t._bindUI()},crossValidation:function(){},defFnFocusNext:function(){},getCurrentFormElements:function(t){var i=this,s=i._ATTRS_nodes[t],o=[],u;return s?n.each(s,function(t){var n=e.one("#"+t);n&&(u=i._FORM_elements[t],u.node=n,o.push(u))}):r.each(i._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&r.getAttribute("name")===t&&(n.node=r,o.push(n))}),o},getUI:function(t){var n=this,r,i,o,u,a,f,l,c;return u=n._ATTRS_nodes[t],o=u&&u.length>0&&u[0],i=n._FORM_elements,r=o&&i[o],r&&(a=e.one("#"+o))&&a.getData("modelattribute")&&(l=r.widget,c=r.type,f=l?n._getWidgetValue(l,c):a.get(S),s.isValue(f)&&((c==="date"||c==="time"||c==="date")&&(f=new Date(parseInt(f,10))),c==="number"&&(f=r.config.digits?parseFloat(f):parseInt(f,10)))),f},getUnvalidatedUI:function(){var t=this,i,o,u,a=[];return r.each(this._FORM_elements,function(n){n.widget||(i=e.one("#"+n.nodeid),i&&(o=t._validValue(i,n,n.name,i.get("value")),t._setNodeValidation(i,o),o||a.push(i)))}),u=t.crossValidation(),s.isArray(u)&&u.length>0&&n.each(u,function(r){var i=r.attribute,s=i&&t._ATTRS_nodes[i];s&&n.each(s,function(n){var i=e.one("#"+n),s=r.validationerror,o;i&&(o=typeof s=="string"?s:null,t._setNodeValidation(i,!1,o),a.push(i))})}),new e.NodeList(a)},renderBtn:function(e,t){return this._renderBtn(e,t,x)},renderCancelBtn:function(e,t){return this._renderBtn(e,t,v)},renderDestroyBtn:function(e,t){return this._renderBtn(e,t,p)},renderRemoveBtn:function(e,t){return this._renderBtn(e,t,d)},renderResetBtn:function(e,t){return this._renderBtn(e,t,g)},renderSaveBtn:function(e,t){return this._renderBtn(e,t,h)},renderSubmitBtn:function(e,t){return this._renderBtn(e,t,m)},renderFormElement:function(t){var r=this,s=r._knownNodeIds,u,a,c,h,p,d,v,m,g,y,b,w,E;return u=r._FORM_elements,a=r._ATTRS_nodes,c=r.get(t),h=r._getAttrCfg(t),v=h.formtype||"text",w=typeof v=="function"&&v.NAME,w||r._allowedFormTypes[v]?(m=h.formconfig||{},m.value=c,w&&(g=r._getWidgetValueField(v),m.widgetconfig||(m.widgetconfig={}),E=typeof g!="string",E?n.each(g,function(e){m.widgetconfig[e]=c}):m.widgetconfig[g]=c),m.modelattribute=!0,m.name=t,m.tooltipinvalid=h.validationerror,m.removerequired=!0,m.removepattern=!0,m.hideatstartup=!0,p=o.getElement(v,m),y=p.nodeid,console.log("nodeid "+y+" was generated for "+t),u[y]=p,a[t]||(a[t]=[]),a[t].push(y),b=p.widget,b&&(E?n.each(g,function(t){r._eventhandlers.push(b.after(t+"Change",function(t){var n=A,i={target:r,value:t.newVal,formElement:p,node:e.one("#"+y),nodeid:y,type:n};r.fire(n,i)}))}):r._eventhandlers.push(b.after(g+"Change",function(t){var n=A,i={target:r,value:t.newVal,formElement:p,node:e.one("#"+y),nodeid:y,type:n};r.fire(n,i)}))),d=p.html,p.widget&&p.widget.addTarget(r),i.fireAvailabilities("#"+y),e.on("availableagain",function(e){var n=e.target;s[y]?(console.log("available but was here before "+n.get("id")),n.insert(r.renderFormElement(t),"replace")):(console.log("available for the first time "+n.get("id")),s[y]=!0,r._modelToUI(y),n.removeClass(l))},"#"+y),i.unavailablePromise("#"+y,{afteravailable:!0}).then(function(){var e=a[t],r=e&&n.indexOf(e,y);delete u[y],r>0&&e.splice(r,1)})):d=f,d},setLifeUpdate:function(e){var t=this;return typeof e=="boolean"&&(t._lifeUpdate=e),t},setResetAttrs:function(){var e=this;e._bkpAttrs=e.getAttrs()},setWidgetValueField:function(e,t){this._widgetValueFields[e]=t},toJSONUI:function(t){var i=this,o={},u=i.getAttrs(),a=i._renderBtnFns,f,l,c,h;return delete u.clientId,delete u.destroyed,delete u.initialized,i.idAttribute!=="id"&&delete u.id,r.each(u,function(e,t){o[t]=i.renderFormElement(t)}),s.isObject(t)?(f=t.propertykey,l=t.type,c=t.buttonText,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())):s.isArray(t)&&n.each(t,function(t){f=t.propertykey,l=t.type,c=t.buttonText,h=t.config,f&&l&&a[l]&&(o[f]=e.bind(a[l],i,c,h)())}),o},UIToModel:function(t){var n=this,i,o,u,a,f,l,c,h;o=n._FORM_elements,i=t&&o[t],i&&(a=e.one("#"+t))&&a.getData("modelattribute")?(c=i.widget,h=i.type,f=c?n._getWidgetValue(c,h):a.get(S),l=i.name,s
.isValue(f)&&(u={formelement:!0},(h==="date"||h==="time"||h==="date")&&(f=new Date(parseInt(f,10))),h==="number"&&(f=i.config.digits?parseFloat(f):parseInt(f,10)),n.set(l,f,u))):t||r.each(n._FORM_elements,function(e,t){n.UIToModel(t)})},destructor:function(){var e=this;e._autoSaveTimer&&e._autoSaveTimer.cancel(),e._fireEventTimer&&e._fireEventTimer.cancel(),e._clearEventhandlers(),e._removeTargets(),e._FORM_elements={},e._ATTRS_nodes={},e._focusNextElements={}},_bindUI:function(){var t=this,n=t._eventhandlers,r=e.one("body");n.push(r.delegate([j,F,I,O,B,M,_,P,D,H],function(e){if(t._FORM_elements[e.target.get("id")]){e.preventDefault();var n=e.target,r=e.type,i=n.getAttribute(S),s={target:t,value:r===j||r===F||r===I?(new Date).setTime(parseInt(i,10)):i,formElement:t._FORM_elements[n.get("id")],buttonNode:n,type:r};t.fire(r,s)}})),n.push(r.delegate("click",function(e){e.preventDefault()},".itsa-widget-parent")),n.push(r.delegate("valuechange",function(e){var n=e.target,r=A,i={target:t,value:n.get(S),formElement:t._FORM_elements[n.get("id")],node:n,nodeid:n.get("id"),type:r};t.fire(r,i)},function(e,n){return t._FORM_elements[n.target.get("id")]})),n.push(t.after("*:change",function(n){n.formelement||e.use("gallery-itsadialog",function(){t._lifeUpdate?e.confirm(u).then(e.bind(t._modelToUI,t,null),e.bind(t.UIToModel,t,null)):e.confirm(a).then(e.bind(t._modelToUI,t,null))})})),n.push(r.delegate("keypress",function(e){e.preventDefault();var n=k,r={target:e.target,type:n};t.fire(n,r)},function(e,n){var r=t._FORM_elements[n.target.get("id")];return r&&n.keyCode===13&&t._focusNextElements[r.type]}))},_clearEventhandlers:function(){n.each(this._eventhandlers,function(e){e.detach()})},_defFnCancel:function(){var e=this;e.setAttrs(e._bkpAttrs)},_defFnDestroy:function(){this.destroyPromise()},_defFnChangeDate:function(t){e.use("gallery-itsadatetimepicker",function(){var n=t.target,r=t.type,i=t.buttonNode,o=e.ItsaDateTimePicker,u=t.formElement,a=s.isDate(t.value)?t.value:new Date,f,l;r===j?f=e.bind(o.getDate,o):r===F?f=e.bind(o.getTime,o):r===I&&(f=e.bind(o.getDateTime,o)),f(new Date(a),u.config).then(function(e){l=u.config.format,n._updateDateTimeUI(u.name,e,r,l),n._lifeUpdate&&n.UIToModel(i.get("id"))},function(){return!0}).then(function(){i&&i.focus()})})},_defFnRemove:function(){this.destroyPromise({remove:!0})},_defFnReset:function(){var e=this;e.setAttrs(e._bkpAttrs),e._modelToUI(),e._removeValidation()},_defFnSubmit:function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.submitPromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(L,{nodelist:n})},_defFnSave:function(){var e=this,t,n;n=e.getUnvalidatedUI(),n.isEmpty()?(t=e.getAttrs(),e.UIToModel(),e.savePromise().then(null,function(){e.setAttrs(t),e._modelToUI()})):e.fire(L,{nodelist:n})},_defFnUIChanged:function(e){var t=this,r=e.formElement,i=r.name,s=r.type,o=e.value,u,a,f;r.widget?(f=this._getWidgetValueField(s),typeof f=="string"?t._updateSimularWidgetUI(e.nodeid,i,f,o):n.each(f,function(n){t._updateSimularWidgetUI(e.nodeid,i,n,o,!0)})):(u=e.node,a=t._validValue(u,r,i,o),t._updateSimularUI(u,i,o,a),t._lifeUpdate&&a&&t.UIToModel(u.get("id")))},_getWidgetValue:function(e,t){var n=this._getWidgetValueField(t);return e&&e.get(typeof n=="string"?n:n[0])},_getWidgetValueField:function(e){var t=typeof e=="function"&&e.NAME;return t&&this._widgetValueFields[e.NAME]||"value"},_modelToUI:function(t){var n=this,i,s,o,u,a,f,l,c,h,p;s=n._FORM_elements,i=t&&s[t],i&&(o=e.one("#"+t))&&o.getData("modelattribute")?(f=i.widget,a=i.name,u=n.get(a,u)||"",f?(p=this._getWidgetValueField(i.type),f.set(typeof p=="string"?p:p[0],u)):(c=i.type,l=c==="date"||c==="time"||c==="datetime",l?(h=i.config.format,n._updateDateTimeUI(i.name,u,c,h)):o.set("value",u))):t||r.each(n._FORM_elements,function(e,t){n._modelToUI(t)})},_removeTargets:function(){var e=this;r.each(e._FORM_elements,function(t){var n=t.widget;n&&n.removeTarget(e)})},_removeValidation:function(){var t=this;r.each(t._FORM_elements,function(n){var r=e.one("#"+n.nodeid);r&&t._setNodeValidation(r,!1)})},_renderBtn:function(e,t,n){var r=this,s=r._FORM_elements,u,a;return t||(t={}),n||(n=x),e||(e=n),t.data||(t.data=""),t.data+=" "+N+'="'+n+'"',t.buttontype=x,t.buttonText=e,u=o.getElement(x,t),a=u.nodeid,s[a]=u,i.unavailablePromise("#"+a,{afteravailable:!0}).then(function(){delete s[a]}),u.html},_updateDateTimeUI:function(t,r,i,s){var o=this,u=o._ATTRS_nodes[t];u&&(s||(i==="date"?s="%x":i==="time"?s="%X":s="%x %X"),n.each(u,function(t){var n=e.one('span[data-for="'+t+'"]');n&&n.set("text",e.Date.format(r,{format:s}))}))},_updateSimularUI:function(t,r,i,s){var o=this,u=o._ATTRS_nodes[r];u&&n.each(u,function(n){var r=e.one("#"+n);r&&(r!==t&&r.set("value",i),o._setNodeValidation(r,s))}),o._lifeUpdate&&o.UIToModel(t.get("id"))},_setNodeValidation:function(e,t,n){var r;e.setAttribute("data-valid",t),r=n||e.getAttribute("data-content"+(t?"valid":"invalid")),r?e.setAttribute("data-content",r):e.removeAttribute("data-content")},_updateSimularWidgetUI:function(t,r,i,s,o){var u=this,a=u._ATTRS_nodes[r],f,l;a&&n.each(a,function(n){f=u._FORM_elements[n],l=f&&f.widget,(n!==t||o)&&l&&l.set(i,s);if(l&&l.getClassName()==="yui3-slider"){var r=e.one('span[data-for="'+n+'"]');r&&r.set("text",s)}}),u._lifeUpdate&&u.UIToModel(t)},_validValue:function(e,t,n,r){var i=this,s=t.type,o=s==="date"||s==="time"||s==="datetime"||s==="checkbox",u,a,f,l,c,h,p,d;return o||(u=i._getAttrCfg(n),a=u.validator,f=e.getAttribute("data-pattern"),d=u.formconfig,p=d&&d.required,h=typeof p=="boolean"&&p,l=!a||a(s==="number"?t.config.digits?parseFloat(r):parseInt(r,10):r),c=!f||r===""&&!h||(new RegExp(f,"i")).test(r)),o||l&&c}},{_ATTR_CFG:["formtype","formconfig","validationerror"]}),e.ITSAFormModel.prototype._widgetValueFields.itsacheckbox="checked",e.ITSAFormModel.prototype._widgetValueFields.itsaselectlist="index",e.ITSAFormModel.prototype._widgetValueFields.toggleButton=["checked","pressed"],e.ITSAFormModel
.prototype._widgetValueFields.editorBase="content",n.each([x,h,p,d,v],function(t){var n={on:function(e,n,r){n._handle=e.on(c,function(e){var n=e.target;n.getAttribute(C)===x&&n.getAttribute(N)===t&&r.fire(e)})},detach:function(e,t){t._handle.detach()}};n.delegate=n.on,n.detachDelegate=n.detach,e.Event.define(t+c,n)})},"@VERSION@",{requires:["yui-base","base-base","attribute-base","base-build","model","datatype-date-format","node-base","node-core","oop","node-event-delegate","event-synthetic","event-valuechange","event-base","gallery-itsanodepromise","gallery-itsamodelsyncpromise","gallery-itsaformelement"]});
