YUI.add("gallery-itsamessagecontroller",function(e,t){"use strict";function Y(){Y.superclass.constructor.apply(this,arguments)}var n=e.Array,r="application",i="boolean",s="error",o="info",u="warn",a="string",f="delete",l="destroy",c="essage",h="m"+c,p="mail",d="e"+p,v="url",m=5e3,g="modelsync",y="_pub_",b="queued"+h,w=y+b,E="new"+h,S=y+E,x="gallery-itsamessage",T="get",N="show",C="remove",k="Status",L="Confirmation",A=T+"Retry"+L,O=T+L,M=T+"Input",_=T+"Number",D=T+"E"+p,P=T+"URL",H=N+"M"+c,B=N+"Warning",j=N+"Error",F=N+k,I=C+k,q="_",R="base-build",U="textarea",z="question",W=o+"rm",X="itsaicon-dialog-",V=X+W,$=X+s,J=X+o,K=X+z,Q=X+u,G="itsadialog";Y.NAME="ITSAMessageControllerClass",e.ITSAMessageControllerClass=e.extend(Y,e.Base),Y.prototype.initializer=function(){var t=this;t.queue=[],t._eventhandlers=[],t._targets={info:G,warn:G,error:G},t._simpleTargets={info:G,warn:G,error:G},t.errorMidi="error.midi",t.soundWarning=!0,t.soundError=!0,t.warnMidi="warn.midi",e.later(m,t,t.isReady)},Y.prototype.isReady=function(){var t=this;return t._readyPromise||(t._readyPromise=e.usePromise(R,x).then(function(){t._intlMessageObj=new e.ITSAMessage,t._syncMessage={load:"loading data...",submit:"submitting data...",save:"updating data...",destroy:"updating data..."}},function(e){var n={error:e&&(e.message||e),src:"ITSAMessageViewer._processQueue"};t._lazyFireErrorEvent(n)}))},Y.prototype.queueMessage=function(t){var n=this,r,i,s;return r=new e.Promise(function(e,t){i=e,s=t}),t||(t={}),t._promise=r,t._resolvePromise=i,t._rejectPromise=s,n[w]||(n[w]=e._publishAsync(b,{defaultTargetOnly:!0,emitFacade:!0,defaultFn:e.rbind(n._defQueueFn,n),preventedFn:n._prevDefFn})),e.fire(b,{itsamessage:t}),r},Y.prototype.sound=function(e){var t=this;t.isReady().then(function(){var n,r=e.soundfile;r?n=r:e.level===u?t.soundWarning&&(n=t.warnMidi):e.level===s&&t.soundError&&(n=t.errorMidi),n&&t._playMidi(n)})},Y.prototype.destructor=function(){var t=this,r=t.queue,i=t._intlMessageObj;t._clearEventhandlers(),t.removeTarget(e),n.each(r,function(e){e.detachAll(),e.destroy(),e=null}),r.length=0,i&&i.destroy()&&(t._intlMessageObj=null),t._targets={},t._simpleTargets={},t._syncMessage={}},Y.prototype._clearEventhandlers=function(){var e=this;n.each(e._eventhandlers,function(e){e.detach()})},Y.prototype._playMidi=function(e){console.log("playing "+e)},Y.prototype._retrieveParams=function(e,t,n){var r=typeof t===a,i;return r||(n=t,t=e,e=null),i=typeof t===a,i||(n=t,t="",e=null),n||(n={}),{title:e,message:t,config:n}},Y.prototype._setupModelSyncListeners=function(){var t=this,n=t._eventhandlers;n.push(e.on(["*:load","*:submit","*:save","*:destroy"],function(n){var r=n.target,i=n.type,s=n.options,o=s.remove||s[f],u=i.split(":")[1],a;e.usePromise("model","gallery-itsamodelsyncpromise").then(function(){r instanceof e.Model&&(u!==l||o)&&(a=t._showStatus(n.statusmessage||t._syncMessage[u],{source:g}),n.promise.then(function(){t._removeStatus(a)},function(){t._removeStatus(a)}))})}))},Y.prototype[q+A]=function(e,t,n){return this._queueMessage(e,t,n,"{btn_abort}{btn_ignore}{btn_retry}","btn_retry","btn_abort",A,u,Q)},Y.prototype[q+O]=function(e,t,n){return this._queueMessage(e,t,n,"{btn_no}{btn_yes}","btn_yes","btn_no",O,o,K)},Y.prototype[q+P]=function(e,t,n){var r=this,i=r._retrieveParams(e,t,n),s=i.config;return s.url=!0,r[q+M](i.title,i.message,s)},Y.prototype[q+D]=function(e,t,n){var r=this,i=r._retrieveParams(e,t,n),s=i.config;return s.email=!0,r[q+M](i.title,i.message,s)},Y.prototype[q+M]=function(t,n,r){var s=this,u=s._retrieveParams(t,n,r),a,f,l,c,h,p;return t=u.title,n=u.message,r=u.config,p=r.formconfig||{},p.fullselect=!0,l=typeof r.email===i&&r.email,c=typeof r.url===i&&r.url,p.primarybtnonenter=!r[U]||l||c,h=l?d:c?v:r[U]?U:"text",p.classname="itsa-"+h+(p.classname?" "+p.classname:""),a=typeof r.required===i&&r.required,p.required=a,s.isReady().then(function(){return(r.email||r.url)&&(r.validationerror||(r.validationerror=s._intlMessageObj.translate("enterrightformat"))),f=e.Base.create("itsamessageinput",e.ITSAMessage,[],null,{ATTRS:{input:{value:r.value,formtype:h,formconfig:p,validator:r.validator,validationerror:r.validationerror}}}),n+='<fieldset class="itsa-input"><div class="pure-control-group">{input}</div></fieldset>',s._queueMessage(t,n,r,(a?"":"{btn_cancel}")+"{btn_ok}","btn_ok",a?null:"btn_cancel",M,o,J,null,null,f)})},Y.prototype[q+_]=function(t,n,r){var s=this,u=s._retrieveParams(t,n,r),a,f,l;return t=u.title,n=u.message,r=u.config,l=r.formconfig||{},l.fullselect=!0,l.primarybtnonenter=!0,l.classname="itsa-number"+(l.classname?" "+l.classname:""),l.required=!0,a=typeof r.required===i&&r.required,s.isReady().then(function(){return r.validationerror||(r.validationerror=s._intlMessageObj.translate("entervalidnumber")),f=e.Base.create("itsamessagenumber",e.ITSAMessage,[],null,{ATTRS:{number:{value:r.value,formtype:"number",formconfig:l,validator:r.validator,validationerror:r.validationerror}}}),n+='<fieldset class="itsa-number"><div class="pure-control-group">{number}</div></fieldset>',s._queueMessage(t,n,r,(a?"":"{btn_cancel}")+"{btn_ok}","btn_ok",a?null:"btn_cancel",_,o,J,null,null,f)})},Y.prototype[q+I]=function(e){e.then(function(e){e.resolve()})},Y.prototype[q+H]=function(e,t,n){return this._queueMessage(e,t,n,"{btn_ok}","btn_ok",null,H,o,V,!1,!0)},Y.prototype[q+B]=function(e,t,n){return this._queueMessage(e,t,n,"{btn_ok}","btn_ok",null,B,u,Q,!1,!0)},Y.prototype[q+j]=function(e,t,n){return this._queueMessage(e,t,n,"{btn_ok}","btn_ok",null,j,s,$,!1,!0)},Y.prototype[q+F]=function(t,n){var i=this;return t=typeof t===a?t:"",n||(n={}),i.isReady().then(function(){var s=new e.ITSAMessage;return s.message=t,s._simpleMessage=!0,s._statusMessage=!0,s.type=F,s.level=o,s.noButtons=!0,s.priority=n.priority,s.timeoutResolve=n.timeoutResolve,s.timeoutReject=n.timeoutReject,s.target=n.target,s.source=n.source||r,s.messageType=F,i.queueMessage(s),s})},Y.prototype._lazyFireErrorEvent=function(e){var t=this;t._errorEvent||(t._errorEvent=
t.publish(s,{broadcast:1})),t.fire(s,e)},Y.prototype._prevDefFn=function(t){var n=t.itsamessage;return new e.Promise(function(e){n.detachAll(),n.destroy(),n=null,e()})},Y.prototype._defQueueFn=function(t){var n=this,r=t.itsamessage,i=n.queue;return i.push(r),n[S]||(n[S]=e.publish(E,{defaultTargetOnly:!0,broadcast:2,emitFacade:!0})),e.fire(E,{itsamessage:r}),r._promise.then(null,function(){return!0}).then(function(){var e=i.indexOf(r);e>-1&&i.splice(e,1),r.detachAll(),r.destroy(),r=null})},Y.prototype._queueMessage=function(t,n,s,o,u,a,f,l,c,h,p,d){var v=this,m=v._retrieveParams(t,n,s),g,y,b;return t=m.title,n=m.message,s=m.config,g=typeof s.imageButtons===i&&s.imageButtons,b=typeof s.simpleMessage===i&&s.simpleMessage||typeof p===i&&p||!1,y=typeof s.required===i&&s.required||!1,g&&(o=o.replace(/\{btn_/g,"{imgbtn_"),u&&(u=u.replace(/btn_/g,"imgbtn_"))),v.isReady().then(function(){var i=d?new d:new e.ITSAMessage;return i.title=t,i.message=n,i._config=s,i._simpleMessage=b,i.footer=o,i.icon=s.icon||c,i.closeButton=y?!1:s.closeButton||h,i.priority=s.priority,i.imageButtons=g,i.primaryButton=s.primaryButton||u,i.rejectButton=a,i.timeoutResolve=s.timeoutResolve,i.timeoutReject=s.timeoutReject,i.target=s.target,i.level=s.level||l,i.source=s.source||r,i.messageType=f,v.queueMessage(i)})},e._publishAsync=function(t,n){var r=this,i=r.publish(t,n);return i._firing=new e.Promise(function(e){e()}),i.fire=function(t){var n=e.Array(arguments,0,!0),s,o;i._firing=i._firing.then(function(){s={id:i.id,next:i,silent:i.silent,stopped:0,prevented:0,bubbling:null,type:i.type,defaultTargetOnly:i.defaultTargetOnly},i.details=n;var e=i._subscribers,u=[],a,f,l;u.push.apply(u,t),a=i._createFacade(u),a.target=a.target||r;if(e)for(f=0,l=e.length;f<l;++f)try{e[f].fn.call(e[f].context,a)}catch(c){}return i.bubbles&&!i.stopped&&(r.bubble(i,n,null,s),a.prevented=Math.max(a.prevented,s.prevented)),a.prevented?i.preventedFn.call(r,a).then(null,function(e){return!1}):i.defaultFn.call(r,a).then(function(){e=i._afters;if(e)for(f=0,l=e.length;f<l;++f)try{e[f].fn.call(e[f].context,a)}catch(t){}if(s.afterQueue)while(o=s.afterQueue.last())o()}).then(null,function(e){var t={error:e&&(e.message||e),src:"ITSAMessageViewer._processQueue"};return r._lazyFireErrorEvent(t),!1})})},i._fire=function(e){return i.fire(e[0])},i},e.Global.ITSAMessageController||(e.Global.ITSAMessageController=new Y),e.ITSAMessageController=e.Global.ITSAMessageController},"@VERSION@",{requires:["yui-base","oop","base-base","base-build","event-custom-complex","promise","gallery-itsamodulesloadedpromise"]});
