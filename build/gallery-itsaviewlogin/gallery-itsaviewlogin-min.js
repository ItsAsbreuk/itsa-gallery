YUI.add("gallery-itsaviewlogin",function(e,t){"use strict";function Yt(){Yt.superclass.constructor.apply(this,arguments)}var n=e.Lang,r=500,i="icon",s="message",o="model",u="formconfig",a="validator",f="validationerror",l="mail",c="e"+l,h="address",p=c+h,d="button",v="primarybtnonenter",m="fullselect",g="required",y="logged",b=y+"in",w=y+"out",E="compressed",S="stay"+b,x="sername",T="assword",N="emember",C="u"+x,k="p"+T,L="r"+N,A="U"+x,O="P"+T,M="R"+N,_=C+"IsEmail",D="sync",P="itsa",H="ogin",B="ogout",j="get",F="messageLoggedin",I=j+"L"+H,q="l"+H,R="l"+B,U=i+"L"+H,z=i+"L"+B,W=j+q,X=P+"-"+q,V="Template",$=q+V,J=R+V,K="label",Q="placeholder",G="classname",Y='<span class="itsa-messagewrapper">',Z='<span class="itsa-buttonwrapper">',et='<fieldset class="'+X+'">',tt="</span>",nt='<div class="pure-control-group">',rt='<div class="pure-controls">',it='<div class="itsa-',st="</fieldset>",ot="</div>",ut="error",at="Change",ft="object",lt="string",ct="boolean",ht="function",pt="create",dt="ccount",vt="img",mt="submit",gt="forgot",yt="btn_",bt=yt+mt,wt=vt+yt,Et=pt+"a"+dt,St="btn_"+Et,xt=pt+"A"+dt,Tt="regain",Nt=C+"or"+k,Ct=gt+C,kt=gt+k,Lt=kt+c,At=gt+Nt,Ot="dialog",Mt="destroyed",_t="imageButtons",Dt='<i class="itsa-mainicon {icon} itsa-iconsize-{size}"></i>',Pt=P+"button-iconleft",Ht=P+"button-textbottom",Bt='<i class="itsaicon-'+Ot,jt="container",Ft="small",It="large",qt="gallery",Rt=qt+"css-itsa-",Ut=Rt+Ot,zt=Rt+"form",Wt=Rt+"animatespin",Xt=qt+"-"+P+"-i18n-login",Vt=qt+"-"+P+Ot,$t=qt+"-"+P+q,Jt=P+"view"+q,Kt=Jt+"-"+y+"in",Qt=Jt+"-"+y+"out",Gt=function(t){if(typeof t=="string")try{return e.JSON.parse(t)}catch(n){return this.fire(ut,{error:n,response:t,src:"parse"}),{}}return t||{}};Yt.NAME="itsaviewlogin",e.ITSAViewLogin=e.extend(Yt,e.ITSAViewModel,{},{ATTRS:{compressed:{value:!0,validator:function(e){return typeof e===ct},initOnly:!0},createAccount:{value:null,validator:function(t){return t instanceof e.LazyPromise}},editable:{value:!0,readOnly:!0},formconfigPassword:{value:{},validator:function(e){return typeof e===ft},initOnly:!0},formconfigRemember:{value:{},validator:function(e){return typeof e===ft},initOnly:!0},formconfigUsername:{value:{},validator:function(e){return typeof e===ft},initOnly:!0},iconLogin:{value:null,validator:function(e){return e===null||typeof e===lt}},iconLogout:{value:null,validator:function(e){return e===null||typeof e===lt}},imageButtons:{value:!1,validator:function(e){return typeof e===ct},initOnly:!0},loginTemplate:{value:null,validator:function(e){return e===null||typeof e===lt}},logoutTemplate:{value:null,validator:function(e){return e===null||typeof e===lt}},message:{value:null,validator:function(e){return typeof e===lt}},messageLoggedin:{value:null,validator:function(e){return typeof e===lt}},model:{readOnly:!0},partOfMultiView:{value:!1,readOnly:!0},password:{value:""},regain:{value:null,validator:function(e){return e===null||e===Nt||e===C||e===k},initOnly:!0},remember:{value:!1},showStayLoggedin:{value:!1,initOnly:!0},sync:{value:null,validator:function(e){return typeof e===ht}},template:{readOnly:!0,getter:"_getterTempl"},username:{value:""},usernameIsEmail:{value:!1,initOnly:!0},validationerrorPassword:{value:null,validator:function(e){return e===null||typeof e===lt},initOnly:!0},validationerrorUsername:{value:null,validator:function(e){return e===null||typeof e===lt},initOnly:!0},validatorPassword:{value:null,validator:function(e){return e===null||typeof e===ht},initOnly:!0},validatorUsername:{value:null,validator:function(e){return e===null||typeof e===ht},initOnly:!0}}}),Yt.prototype.setSubmitButtons=function(e){var t=this,n=e?q:R,r=t._loginintl;t.get(_t)?t.setButtonLabel(wt+mt,Bt+"-"+n+'"></i>'+r[n]):t.setButtonLabel(bt,r[n])},Yt.prototype.initializer=function(){var t=this,n=t._eventhandlers,i;t.get(jt).addClass(Jt),i=t._loginintl,t.setSubmitButtons(!0),t.get(_t)?(t.setPrimaryButton(wt+mt),e.usePromise("gallerycss-itsa-dialog","gallerycss-itsa-form","gallerycss-itsa-animatespin")):t.setPrimaryButton(bt),t._defineModel(),t.get(E)&&e.later(r,null,function(){e.use($t)}),n.push(t.after(C+at,function(e){t.get(o).set(C,e.newVal)})),n.push(t.after(k+at,function(e){t.get(o).set(k,e.newVal)})),n.push(t.after(L+at,function(e){t.get(o).set(L,e.newVal)})),n.push(t.after(D+at,function(e){t.get(o)[D+"Promise"]=e.newVal})),n.push(t.on("buttonclick",function(n){var r=n.value;console.log("value: "+r),r===gt?e.usePromise($t).then(function(){var n=e.ITSADialog,r=t.get(Tt),i={},s=t.get(D);t.focusInitialItem().then(null,function(){return!0}).then(function(){return r===Nt?n._regainFn_UnPw(i):!0}).then(function(e){if(e.button===Ct||r===C)return n._regainFn_Un(i,s);if(e.button===kt||r===k)return n._regainFn_Pw(i,s)},function(t){t instanceof Error&&e.showError(t.message)})}):r!==Et&&r===q&&e.usePromise($t).then(function(){console.log("check 1")}).then(function(){console.log("logged in!")})})),n.push(e.after(b,function(e){var n=e.messageLoggedin,r=t.get(o);t._loggedin=!0,t._user=e.user,t.get(Mt)||(t.get(jt).addClass(Kt),t.get(jt).removeClass(Qt),n&&t.set(F,n),t.setSubmitButtons(!1),r._set(C,t.get(C)),r._set(k,t.get(k)),r._set(L,t.get(L)),r._set(d,R),r.setSyncMessage(mt,i.loggingout),t._setTemplateRenderer(!1),t.render())})),n.push(e.on(w,function(n){var r=t.get(o);t._loggedin=!1,t._user=null,e.soon(function(){t.get(Mt)||(t.get(jt).addClass(Qt),t.get(jt).removeClass(Kt),t.setSubmitButtons(!0),r._set(d,W),r.setSyncMessage(mt,i.attemptlogin),t._setTemplateRenderer(!0),t.render())})})),n.push(t.on("*:submit",function(n){var r=n.target,i=r.get("button")===R;n.currentTarget===t&&(n.promise._logout=i,i&&e.fire(w))})),n.push(t.after("*:submit",function(n){var r=n.target,i=n.promise;n.currentTarget===t&&i.then(function(n){var s=Gt(n),o=t._loginintl,u=r.messageType,a,f;s&&s.status&&!i._logout?(s.status==="ERROR"&&(a=s.message||o.unspecifiederror,e.showError(s.title||o[ut],a)),s.status==="OK"?(f=e.merge(s,r.toJSON()),e.fire(b,f),(a=s.message)&&e.showMessage(s.title,a)):u===I&&s.status==="NOACCESS"?
(a=s.message||o.loginblocked,e.usePromise(Vt).then(function(){e.showError(s.title||o[ut],a)})):s.status==="RETRY"?(a=s.message||o.unknownlogin,e.usePromise(Vt).then(function(){e.showWarning(s.title||o[ut],a)})):s.status!=="CHANGEPASSWORD"&&(a="Wrong response.status found: "+s.status,f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))):(a="Response returned without response.status",f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))}).then(null,function(t){var n=t&&(t.message||t)||"Undefined error during submission";e.usePromise(Vt).then(function(){e.showWarning(n)})})}))},Yt.prototype.getLogin=function(){},Yt.prototype.renderOnReady=function(){var t=this;return e.usePromise(Ut,zt,Wt).then(function(){t.render()})},Yt.prototype._defineModel=function(){var t=this,n=t._loginintl,r=t.get(_),i=t.get(_t),s=[],l,c,h,d,y;c=t.get(u+A),c[K]||c[Q]||(c[K]=n[r?p:C]),c.initialfocus=!0,c[m]=!0,c[v]=!1,c[G]=X+(c[G]?" "+c[G]:""),c[g]=!0,h=t.get(u+O),h[K]||h[Q]||(h[K]=n[k]),h[m]=!0,h[v]=!0,h[G]=X+(h[G]?" "+h[G]:""),h[g]=!0,d=t.get(u+M),d.widgetconfig={primarybtnonenter:!0},c[K]&&!h[K]&&(h[K]=" "),h[K]&&!c[K]&&(c[K]=" "),d[K]||(d[K]=n[S]),d.switchlabel=!0,t.get(Tt)&&s.push(i?{buttonId:wt+gt,labelHTML:Bt+'-question"></i>'+n[gt],config:{value:gt,classname:Pt}}:{buttonId:yt+gt,labelHTML:n[gt],config:{value:gt}}),t.get(xt)&&s.push(i?{buttonId:wt+Et,labelHTML:Bt+'-user"></i>'+n[Et],config:{value:Et,classname:Pt}}:{buttonId:St,labelHTML:n[Et],config:{value:Et}}),t.get(E)&&s.push(i?{buttonId:wt+q,labelHTML:Bt+'-login"></i>'+n[q],config:{value:q,classname:Pt+" "+Ht}}:{buttonId:yt+q,labelHTML:n[q],config:{value:q,classname:Ht}}),s.length>0&&t.addCustomBtns(s),l=e.Base.create("itsaviewloginmodel",e.ITSAFormModel,[],null,{ATTRS:{username:{value:t.get(C),formtype:r?"email":"text",formconfig:c,validator:t.get(a+A),validationerror:t.get(f+A)},password:{value:t.get(k),formtype:k,formconfig:h,validator:t.get(a+O),validationerror:t.get(f+O)},remember:{value:t.get(L),formtype:e.ITSACheckbox,formconfig:d},button:{value:W,writeOnce:"initOnly"}}}),y=new l,y.setSyncMessage(mt,n.attemptlogin),t._set(o,y),y.addTarget(t),y.syncPromise=t.get(D),t._setTemplateRenderer(!0)},Yt.prototype._getterTempl=function(){var e=this,t=e._loggedin?e._logoutTempl():e._loginTempl();return e.get(_t)?t.replace(/\{btn_/g,"{"+wt):t},Yt.prototype._loginTempl=function(){var e=this,t=e.get(E),r=e.get(U);return(r?n.sub(Dt,{icon:r,size:t?Ft:It}):"")+(e.get($)||(e.get(E)?e._defComprLoginTempl():e._defLoginTempl()))},Yt.prototype._defComprLoginTempl=function(){return"{"+yt+q+"}"},Yt.prototype._defLoginTempl=function(){var e=this,t;return t=e.get(Tt)?"{"+yt+gt+"}":"",e.get(xt)&&(t+="{"+St+"}"),t+="{"+bt+"}",Y+(e.get(s)||"")+tt+et+nt+"{"+C+"}"+ot+nt+"{"+k+"}"+ot+(e.get("showStayLoggedin")?it+'login-checkbox pure-controls">'+"{remember}"+ot:"")+rt+t+ot+st},Yt.prototype._logoutTempl=function(){var e=this,t=e.get(E),r=e.get(z);return(r?n.sub(Dt,{icon:r,size:t?Ft:It}):"")+(e.get(J)||(t?e._defComprLogoutTempl():e._defLogoutTempl()))},Yt.prototype._defComprLogoutTempl=function(){return this._defLogoutTempl()},Yt.prototype._defLogoutTempl=function(){var e=this,t=e._user,r=e.get(F)||(t?e._loginintl.youareloggedinas:e._loginintl.youareloggedin),i=t||"",s="{"+bt+"}";return Y+n.sub(r,{displayname:i})+tt+Z+s+tt},Yt.prototype._loginintl=e.Intl.get(Xt)},"@VERSION@",{requires:["yui-base","intl","base-build","gallery-itsaformmodel","gallery-itsaviewmodel","gallery-itsacheckbox","gallery-itsa-i18n-login","gallery-itsamodelsyncpromise","gallery-itsamodulesloadedpromise","gallery-lazy-promise"],skinnable:!0});
