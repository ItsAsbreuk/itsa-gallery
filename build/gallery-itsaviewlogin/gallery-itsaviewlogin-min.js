YUI.add("gallery-itsaviewlogin",function(e,t){"use strict";function Rt(){Rt.superclass.constructor.apply(this,arguments)}var n=e.Lang,r="icon",i="message",s="model",o="formconfig",u="validator",a="validationerror",f="mail",l="e"+f,c="address",h=l+c,p="button",d="primarybtnonenter",v="fullselect",m="required",g="logged",y=g+"in",b=g+"out",w="stay"+y,E="sername",S="assword",x="emember",T="u"+E,N="p"+S,C="r"+x,k="U"+E,L="P"+S,A="R"+x,O=T+"IsEmail",M="sync",_="itsa",D="ogin",P="ogout",H="get",B="messageLoggedin",j=H+"L"+D,F="l"+D,I="l"+P,q=r+"L"+D,R=r+"L"+P,U=H+F,z=_+"-"+F,W="Template",X=F+W,V=I+W,$="label",J="placeholder",K="classname",Q='<span class="itsa-messagewrapper">',G='<fieldset class="'+z+'">',Y="</span>",Z='<div class="pure-control-group">',et='<div class="pure-controls">',tt='<div class="itsa-',nt="</fieldset>",rt="</div>",it="error",st="Change",ot="object",ut="string",at="boolean",ft="function",lt="create",ct="ccount",ht="img",pt="submit",dt="btn_",vt=dt+pt,mt=ht+dt,gt=lt+"a"+ct,yt="btn_"+gt,bt=lt+"A"+ct,wt="regain",Et=T+"or"+N,St="forgot",xt="dialog",Tt="destroyed",Nt="imageButtons",Ct='<i class="{icon}"></i>',kt=_+"button-iconleft",Lt='<i class="itsaicon-'+xt,At="container",Ot="gallery",Mt=Ot+"css-itsa-",_t=Mt+xt,Dt=Mt+"form",Pt=Mt+"animatespin",Ht=Ot+"-itsa-i18n-login",Bt=Ot+"-itsa"+xt,jt=_+"view"+F,Ft=jt+"-"+g+"in",It=jt+"-"+g+"out",qt=function(t){if(typeof t=="string")try{return e.JSON.parse(t)}catch(n){return this.fire(it,{error:n,response:t,src:"parse"}),{}}return t||{}};Rt.NAME="itsaviewlogin",e.ITSAViewLogin=e.extend(Rt,e.ITSAViewModel,{},{ATTRS:{createAccount:{value:null,validator:function(t){return t instanceof e.LazyPromise}},editable:{value:!0,readOnly:!0},formconfigPassword:{value:{},validator:function(e){return typeof e===ot},initOnly:!0},formconfigRemember:{value:{},validator:function(e){return typeof e===ot},initOnly:!0},formconfigUsername:{value:{},validator:function(e){return typeof e===ot},initOnly:!0},iconLogin:{value:null,validator:function(e){return e===null||typeof e===ut}},iconLogout:{value:null,validator:function(e){return e===null||typeof e===ut}},imageButtons:{value:!1,validator:function(e){return typeof e===at},initOnly:!0},loginTemplate:{value:null,validator:function(e){return e===null||typeof e===ut}},logoutTemplate:{value:null,validator:function(e){return e===null||typeof e===ut}},message:{value:null,validator:function(e){return typeof e===ut}},messageLoggedin:{value:null,validator:function(e){return typeof e===ut}},model:{readOnly:!0},partOfMultiView:{value:!1,readOnly:!0},password:{value:""},regain:{value:null,validator:function(e){return e===null||e===Et||e===T||e===N},initOnly:!0},remember:{value:!1},showStayLoggedin:{value:!1,initOnly:!0},sync:{value:null,validator:function(e){return typeof e===ft}},template:{readOnly:!0,getter:"_getterTempl"},username:{value:""},usernameIsEmail:{value:!1,initOnly:!0},validationerrorPassword:{value:null,validator:function(e){return e===null||typeof e===ut},initOnly:!0},validationerrorUsername:{value:null,validator:function(e){return e===null||typeof e===ut},initOnly:!0},validatorPassword:{value:null,validator:function(e){return e===null||typeof e===ft},initOnly:!0},validatorUsername:{value:null,validator:function(e){return e===null||typeof e===ft},initOnly:!0}}}),Rt.prototype.setSubmitButtons=function(e){var t=this,n=e?F:I,r=t._loginintl;t.get(Nt)?t.setButtonLabel(mt+pt,Lt+"-"+n+'"></i>'+r[n]):t.setButtonLabel(vt,r[n])},Rt.prototype.initializer=function(){var t=this,n=t._eventhandlers,r;t.get(At).addClass(jt),r=t._loginintl,t.setSubmitButtons(!0),t.get(Nt)?(t.setPrimaryButton(mt+pt),e.usePromise("gallerycss-itsa-dialog","gallerycss-itsa-form","gallerycss-itsa-animatespin")):t.setPrimaryButton(vt),t._defineModel(),n.push(t.after(T+st,function(e){t.get(s).set(T,e.newVal)})),n.push(t.after(N+st,function(e){t.get(s).set(N,e.newVal)})),n.push(t.after(C+st,function(e){t.get(s).set(C,e.newVal)})),n.push(t.after(M+st,function(e){t.get(s)[M+"Promise"]=e.newVal})),n.push(e.after(y,function(e){var n=e.messageLoggedin,i=t.get(s);t._loggedin=!0,t._user=e.user,t.get(Tt)||(t.get(At).addClass(Ft),t.get(At).removeClass(It),n&&t.set(B,n),t.setSubmitButtons(!1),i._set(T,t.get(T)),i._set(N,t.get(N)),i._set(C,t.get(C)),i._set(p,I),i.setSyncMessage(pt,r.loggingout),t._setTemplateRenderer(!1),t.render())})),n.push(e.on(b,function(n){var i=t.get(s);t._loggedin=!1,t._user=null,e.soon(function(){t.get(Tt)||(t.get(At).addClass(It),t.get(At).removeClass(Ft),t.setSubmitButtons(!0),i._set(p,U),i.setSyncMessage(pt,r.attemptlogin),t._setTemplateRenderer(!0),t.render())})})),n.push(t.on("*:submit",function(n){var r=n.target,i=r.get("button")===I;n.currentTarget===t&&(n.promise._logout=i,console.log("before submit, logout: "+n.promise._logout),i&&e.fire(b))})),n.push(t.after("*:submit",function(n){var r=n.target,i=n.promise;n.currentTarget===t&&i.then(function(n){var s=qt(n),o=t._loginintl,u=r.messageType,a,f;console.log("after submit, logout: "+i._logout),s&&s.status&&!i._logout?(s.status==="ERROR"&&(a=s.message||o.unspecifiederror,e.showError(s.title||o[it],a)),s.status==="OK"?(f=e.merge(s,r.toJSON()),e.fire(y,f),(a=s.message)&&e.showMessage(s.title,a)):u===j&&s.status==="NOACCESS"?(a=s.message||o.loginblocked,e.usePromise(Bt).then(function(){e.showError(s.title||o[it],a)})):s.status==="RETRY"?(a=s.message||o.unknownlogin,e.usePromise(Bt).then(function(){e.showWarning(s.title||o[it],a)})):s.status!=="CHANGEPASSWORD"&&(a="Wrong response.status found: "+s.status,f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))):(a="Response returned without response.status",f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))}).then(null,function(t){var n=t&&(t.message||t)||"Undefined error during submission";e.usePromise(Bt).then(function(){e.showWarning(n)})})}))},Rt.prototype.getLogin=function(){},Rt.prototype.renderOnReady=function(){var t=this;return e.usePromise(_t,Dt,Pt).then(function(){t.render()})},Rt.prototype._defineModel=function(){var t=this
,n=t._loginintl,r=t.get(O),i=t.get(Nt),f=[],l,c,p,g,y;c=t.get(o+k),c[$]||c[J]||(c[$]=n[r?h:T]),c.initialfocus=!0,c[v]=!0,c[d]=!1,c[K]=z+(c[K]?" "+c[K]:""),c[m]=!0,p=t.get(o+L),p[$]||p[J]||(p[$]=n[N]),p[v]=!0,p[d]=!0,p[K]=z+(p[K]?" "+p[K]:""),p[m]=!0,g=t.get(o+A),g.widgetconfig={primarybtnonenter:!0},c[$]&&!p[$]&&(p[$]=" "),p[$]&&!c[$]&&(c[$]=" "),g[$]||(g[$]=n[w]),g.switchlabel=!0,t.get(wt)&&f.push(i?{buttonId:mt+St,labelHTML:Lt+'-question"></i>'+n[St],config:{value:St,classname:kt}}:{buttonId:dt+St,labelHTML:n[St],config:{value:St}}),t.get(bt)&&f.push(i?{buttonId:mt+gt,labelHTML:Lt+'-user"></i>'+n[gt],config:{value:gt,classname:kt}}:{buttonId:yt,labelHTML:n[gt],config:{value:gt}}),f.length>0&&t.addCustomBtns(f),l=e.Base.create("itsaviewloginmodel",e.ITSAFormModel,[],null,{ATTRS:{username:{value:t.get(T),formtype:r?"email":"text",formconfig:c,validator:t.get(u+k),validationerror:t.get(a+k)},password:{value:t.get(N),formtype:N,formconfig:p,validator:t.get(u+L),validationerror:t.get(a+L)},remember:{value:t.get(C),formtype:e.ITSACheckbox,formconfig:g},button:{value:U,writeOnce:"initOnly"}}}),y=new l,y.setSyncMessage(pt,n.attemptlogin),t._set(s,y),y.addTarget(t),y.syncPromise=t.get(M),t._setTemplateRenderer(!0)},Rt.prototype._getterTempl=function(){var e=this,t=e._loggedin?e._logoutTempl():e._loginTempl();return e.get(Nt)?t.replace(/\{btn_/g,"{"+mt):t},Rt.prototype._loginTempl=function(){var e=this,t=e.get(q);return(t?n.sub(Ct,{icon:t}):"")+(e.get(X)||e._defLoginTempl())},Rt.prototype._defLoginTempl=function(){var e=this,t;return t=e.get(wt)?"{"+dt+St+"}":"",e.get(bt)&&(t+="{"+yt+"}"),t+="{"+vt+"}",Q+(e.get(i)||"")+Y+G+Z+"{"+T+"}"+rt+Z+"{"+N+"}"+rt+(e.get("showStayLoggedin")?tt+'login-checkbox pure-controls">'+"{remember}"+rt:"")+et+t+rt+nt},Rt.prototype._logoutTempl=function(){var e=this,t=e.get(R);return(t?n.sub(Ct,{icon:t}):"")+(e.get(V)||e._defLogoutTempl())},Rt.prototype._defLogoutTempl=function(){var e=this,t=e._user,r=e.get(B)||(t?e._loginintl.youareloggedinas:e._loginintl.youareloggedin),i=t||"",s="{"+vt+"}";return Q+n.sub(r,{user:i})+Y+s},Rt.prototype._loginintl=e.Intl.get(Ht)},"@VERSION@",{requires:["yui-base","intl","base-build","gallery-itsaformmodel","gallery-itsaviewmodel","gallery-itsacheckbox","gallery-itsa-i18n-login","gallery-itsamodelsyncpromise","gallery-itsamodulesloadedpromise","gallery-lazy-promise"],skinnable:!0});
