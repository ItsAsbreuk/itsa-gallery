YUI.add("gallery-itsaviewlogin",function(e,t){"use strict";function $t(){$t.superclass.constructor.apply(this,arguments)}var n=e.Lang,r="icon",i="message",s="model",o="formconfig",u="validator",a="validationerror",f="mail",l="e"+f,c="address",h=l+c,p="button",d="primarybtnonenter",v="fullselect",m="required",g="logged",y=g+"in",b=g+"out",w="stay"+y,E="sername",S="assword",x="emember",T="u"+E,N="p"+S,C="r"+x,k="U"+E,L="P"+S,A="R"+x,O=T+"IsEmail",M="sync",_="itsa",D="ogin",P="ogout",H="get",B="messageLoggedin",j=H+"L"+D,F="l"+D,I="l"+P,q=r+"L"+D,R=r+"L"+P,U=H+F,z=_+"-"+F,W="Template",X=F+W,V=I+W,$="label",J="placeholder",K="classname",Q='<span class="itsa-messagewrapper">',G='<span class="itsa-buttonwrapper">',Y='<fieldset class="'+z+'">',Z="</span>",et='<div class="pure-control-group">',tt='<div class="pure-controls">',nt='<div class="itsa-',rt="</fieldset>",it="</div>",st="error",ot="Change",ut="object",at="string",ft="boolean",lt="function",ct="create",ht="ccount",pt="img",dt="submit",vt="forgot",mt="btn_",gt=mt+dt,yt=pt+mt,bt=ct+"a"+ht,wt="btn_"+bt,Et=ct+"A"+ht,St="regain",xt=T+"or"+N,Tt=vt+T,Nt=vt+N,Ct=Nt+l,kt=vt+xt,Lt="dialog",At="destroyed",Ot="imageButtons",Mt='<i class="itsa-mainicon {icon}"></i>',_t=_+"button-iconleft",Dt='<i class="itsaicon-'+Lt,Pt="container",Ht="gallery",Bt=Ht+"css-itsa-",jt=Bt+Lt,Ft=Bt+"form",It=Bt+"animatespin",qt=Ht+"-"+_+"-i18n-login",Rt=Ht+"-"+_+Lt,Ut=Ht+"-"+_+F,zt=_+"view"+F,Wt=zt+"-"+g+"in",Xt=zt+"-"+g+"out",Vt=function(t){if(typeof t=="string")try{return e.JSON.parse(t)}catch(n){return this.fire(st,{error:n,response:t,src:"parse"}),{}}return t||{}};$t.NAME="itsaviewlogin",e.ITSAViewLogin=e.extend($t,e.ITSAViewModel,{},{ATTRS:{createAccount:{value:null,validator:function(t){return t instanceof e.LazyPromise}},editable:{value:!0,readOnly:!0},formconfigPassword:{value:{},validator:function(e){return typeof e===ut},initOnly:!0},formconfigRemember:{value:{},validator:function(e){return typeof e===ut},initOnly:!0},formconfigUsername:{value:{},validator:function(e){return typeof e===ut},initOnly:!0},iconLogin:{value:null,validator:function(e){return e===null||typeof e===at}},iconLogout:{value:null,validator:function(e){return e===null||typeof e===at}},imageButtons:{value:!1,validator:function(e){return typeof e===ft},initOnly:!0},loginTemplate:{value:null,validator:function(e){return e===null||typeof e===at}},logoutTemplate:{value:null,validator:function(e){return e===null||typeof e===at}},message:{value:null,validator:function(e){return typeof e===at}},messageLoggedin:{value:null,validator:function(e){return typeof e===at}},model:{readOnly:!0},partOfMultiView:{value:!1,readOnly:!0},password:{value:""},regain:{value:null,validator:function(e){return e===null||e===xt||e===T||e===N},initOnly:!0},remember:{value:!1},showStayLoggedin:{value:!1,initOnly:!0},sync:{value:null,validator:function(e){return typeof e===lt}},template:{readOnly:!0,getter:"_getterTempl"},username:{value:""},usernameIsEmail:{value:!1,initOnly:!0},validationerrorPassword:{value:null,validator:function(e){return e===null||typeof e===at},initOnly:!0},validationerrorUsername:{value:null,validator:function(e){return e===null||typeof e===at},initOnly:!0},validatorPassword:{value:null,validator:function(e){return e===null||typeof e===lt},initOnly:!0},validatorUsername:{value:null,validator:function(e){return e===null||typeof e===lt},initOnly:!0}}}),$t.prototype.setSubmitButtons=function(e){var t=this,n=e?F:I,r=t._loginintl;t.get(Ot)?t.setButtonLabel(yt+dt,Dt+"-"+n+'"></i>'+r[n]):t.setButtonLabel(gt,r[n])},$t.prototype.initializer=function(){var t=this,n=t._eventhandlers,r;t.get(Pt).addClass(zt),r=t._loginintl,t.setSubmitButtons(!0),t.get(Ot)?(t.setPrimaryButton(yt+dt),e.usePromise("gallerycss-itsa-dialog","gallerycss-itsa-form","gallerycss-itsa-animatespin")):t.setPrimaryButton(gt),t._defineModel(),n.push(t.after(T+ot,function(e){t.get(s).set(T,e.newVal)})),n.push(t.after(N+ot,function(e){t.get(s).set(N,e.newVal)})),n.push(t.after(C+ot,function(e){t.get(s).set(C,e.newVal)})),n.push(t.after(M+ot,function(e){t.get(s)[M+"Promise"]=e.newVal})),n.push(t.on("buttonclick",function(n){var r=n.value;r===vt?e.usePromise(Ut).then(function(){var n=e.ITSADialog,r=t.get(St),i={},s=t.get(M);t.focusInitialItem().then(null,function(){return!0}).then(function(){return r===xt?n._regainFn_UnPw(i):!0}).then(function(e){if(e.button===Tt||r===T)return n._regainFn_Un(i,s);if(e.button===Nt||r===N)return n._regainFn_Pw(i,s)},function(t){t instanceof Error&&e.showError(t.message)})}):r===bt})),n.push(e.after(y,function(e){var n=e.messageLoggedin,i=t.get(s);t._loggedin=!0,t._user=e.user,t.get(At)||(t.get(Pt).addClass(Wt),t.get(Pt).removeClass(Xt),n&&t.set(B,n),t.setSubmitButtons(!1),i._set(T,t.get(T)),i._set(N,t.get(N)),i._set(C,t.get(C)),i._set(p,I),i.setSyncMessage(dt,r.loggingout),t._setTemplateRenderer(!1),t.render())})),n.push(e.on(b,function(n){var i=t.get(s);t._loggedin=!1,t._user=null,e.soon(function(){t.get(At)||(t.get(Pt).addClass(Xt),t.get(Pt).removeClass(Wt),t.setSubmitButtons(!0),i._set(p,U),i.setSyncMessage(dt,r.attemptlogin),t._setTemplateRenderer(!0),t.render())})})),n.push(t.on("*:submit",function(n){var r=n.target,i=r.get("button")===I;n.currentTarget===t&&(n.promise._logout=i,console.log("before submit, logout: "+n.promise._logout),i&&e.fire(b))})),n.push(t.after("*:submit",function(n){var r=n.target,i=n.promise;n.currentTarget===t&&i.then(function(n){var s=Vt(n),o=t._loginintl,u=r.messageType,a,f;console.log("after submit, logout: "+i._logout),s&&s.status&&!i._logout?(s.status==="ERROR"&&(a=s.message||o.unspecifiederror,e.showError(s.title||o[st],a)),s.status==="OK"?(f=e.merge(s,r.toJSON()),e.fire(y,f),(a=s.message)&&e.showMessage(s.title,a)):u===j&&s.status==="NOACCESS"?(a=s.message||o.loginblocked,e.usePromise(Rt).then(function(){e.showError(s.title||o[st],a)})):s.status==="RETRY"?(a=s.message||o.unknownlogin,e.usePromise(Rt).then(function(){e.showWarning(s.title||o[st],a)})):s.status!=="CHANGEPASSWORD"&&
(a="Wrong response.status found: "+s.status,f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))):(a="Response returned without response.status",f={src:"Y.ITSALogin.submit()",msg:a},t.fire("warn",f))}).then(null,function(t){var n=t&&(t.message||t)||"Undefined error during submission";e.usePromise(Rt).then(function(){e.showWarning(n)})})}))},$t.prototype.getLogin=function(){},$t.prototype.renderOnReady=function(){var t=this;return e.usePromise(jt,Ft,It).then(function(){t.render()})},$t.prototype._defineModel=function(){var t=this,n=t._loginintl,r=t.get(O),i=t.get(Ot),f=[],l,c,p,g,y;c=t.get(o+k),c[$]||c[J]||(c[$]=n[r?h:T]),c.initialfocus=!0,c[v]=!0,c[d]=!1,c[K]=z+(c[K]?" "+c[K]:""),c[m]=!0,p=t.get(o+L),p[$]||p[J]||(p[$]=n[N]),p[v]=!0,p[d]=!0,p[K]=z+(p[K]?" "+p[K]:""),p[m]=!0,g=t.get(o+A),g.widgetconfig={primarybtnonenter:!0},c[$]&&!p[$]&&(p[$]=" "),p[$]&&!c[$]&&(c[$]=" "),g[$]||(g[$]=n[w]),g.switchlabel=!0,t.get(St)&&f.push(i?{buttonId:yt+vt,labelHTML:Dt+'-question"></i>'+n[vt],config:{value:vt,classname:_t}}:{buttonId:mt+vt,labelHTML:n[vt],config:{value:vt}}),t.get(Et)&&f.push(i?{buttonId:yt+bt,labelHTML:Dt+'-user"></i>'+n[bt],config:{value:bt,classname:_t}}:{buttonId:wt,labelHTML:n[bt],config:{value:bt}}),f.length>0&&t.addCustomBtns(f),l=e.Base.create("itsaviewloginmodel",e.ITSAFormModel,[],null,{ATTRS:{username:{value:t.get(T),formtype:r?"email":"text",formconfig:c,validator:t.get(u+k),validationerror:t.get(a+k)},password:{value:t.get(N),formtype:N,formconfig:p,validator:t.get(u+L),validationerror:t.get(a+L)},remember:{value:t.get(C),formtype:e.ITSACheckbox,formconfig:g},button:{value:U,writeOnce:"initOnly"}}}),y=new l,y.setSyncMessage(dt,n.attemptlogin),t._set(s,y),y.addTarget(t),y.syncPromise=t.get(M),t._setTemplateRenderer(!0)},$t.prototype._getterTempl=function(){var e=this,t=e._loggedin?e._logoutTempl():e._loginTempl();return e.get(Ot)?t.replace(/\{btn_/g,"{"+yt):t},$t.prototype._loginTempl=function(){var e=this,t=e.get(q);return(t?n.sub(Mt,{icon:t}):"")+(e.get(X)||e._defLoginTempl())},$t.prototype._defLoginTempl=function(){var e=this,t;return t=e.get(St)?"{"+mt+vt+"}":"",e.get(Et)&&(t+="{"+wt+"}"),t+="{"+gt+"}",Q+(e.get(i)||"")+Z+Y+et+"{"+T+"}"+it+et+"{"+N+"}"+it+(e.get("showStayLoggedin")?nt+'login-checkbox pure-controls">'+"{remember}"+it:"")+tt+t+it+rt},$t.prototype._logoutTempl=function(){var e=this,t=e.get(R);return(t?n.sub(Mt,{icon:t}):"")+(e.get(V)||e._defLogoutTempl())},$t.prototype._defLogoutTempl=function(){var e=this,t=e._user,r=e.get(B)||(t?e._loginintl.youareloggedinas:e._loginintl.youareloggedin),i=t||"",s="{"+gt+"}";return Q+n.sub(r,{user:i})+Z+G+s+Z},$t.prototype._loginintl=e.Intl.get(qt)},"@VERSION@",{requires:["yui-base","intl","base-build","gallery-itsaformmodel","gallery-itsaviewmodel","gallery-itsacheckbox","gallery-itsa-i18n-login","gallery-itsamodelsyncpromise","gallery-itsamodulesloadedpromise","gallery-lazy-promise"],skinnable:!0});
