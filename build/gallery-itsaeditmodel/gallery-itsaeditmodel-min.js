YUI.add("gallery-itsaeditmodel",function(e,t){"use strict";var n=e.one("body"),r=e.Lang,i=e.Array,s=e.Object,o="undefined value",u="The data you are editing has been changed from outside the form. If you save your data, then these former changed will be overridden.",a="datetimepickerclick",f="itsa-button-datetime",l="itsa-datetimepicker-icondate",c="itsa-datetimepicker-icontime",h="itsa-datetimepicker-icondatetime",p="yui3-itsaformelement",d=p+"-inputbutton",v=p+"-lifechange",m=p+"-changed",g=p+"-enternextfield",y=p+"-button",b=p+"-submit",w=p+"-reset",E=p+"-save",S=p+"-destroy",x={name:"undefined-name",type:"",value:"",keyValidation:null,validation:null,validationMessage:"",autoCorrection:null,className:null,dateFormat:null,initialFocus:!1,selectOnFocus:!1,widgetConfig:{}},T=function(e){var t=/yui3-itsaformelement-property-(\w+)/;return t.test(e)?RegExp.$1:null},N="submitclick",C="saveclick",k="resetclick",L="destroyclick",A="focusnext",O="dialog:warn",M="inputchange",_="inputvaluechange",D="inputbuttonclick",P="pluggedin";e.namespace("Plugin").ITSAEditModel=e.Base.create("itsaeditmodel",e.Plugin.Base,[],{host:null,_eventhandlers:[],_itsaformelement:null,_configAttrs:{},_elementIds:{},_needAutoSaved:!1,_autoSaveTimer:null,_fireEventTimer:null,initializer:function(){var t=this,n;n=t.host=t.get("host"),t.get("template")===null,t._itsaformelement=new e.ITSAFormElement,n.publish(N,{defaultFn:e.rbind(t._defPluginSubmitFn,t)}),n.publish(k,{defaultFn:e.rbind(t._defPluginResetFn,t)}),n.publish(C,{defaultFn:e.rbind(t._defSaveFn,t)}),n.publish(L,{defaultFn:e.rbind(t._defPluginDestroyFn,t)}),t._bindUI(),t.addTarget(n),t._fireEventTimer=e.later(50,t,function(){n.itsaeditmodel&&(t._fireEventTimer.cancel(),t.fire(P))},null,!0)},getButton:function(t,n){var r=this,i=t,s=t.replace(/ /g,"_"),o=n.type,u=e.merge(x,n||{},{name:s,value:i}),a,f;return s&&n&&(o==="button"||o==="reset"||o==="submit"||o==="save"||o==="destroy")?(r._configAttrs[s]=u,r._elementIds[s]||(r._elementIds[s]=e.guid()),f=r._elementIds[s],a=r._itsaformelement.render(u,f),r._isDateTimeType(u.type)&&e.use("gallery-itsadatetimepicker")):a="",a},getElement:function(t,n,r){var i=this,s=r||i.host.get(t),o=e.merge(x,n||{},{name:t,value:s}),u,a;return t&&n?(i._configAttrs[t]=o,i._elementIds[t]||(i._elementIds[t]=e.guid()),a=i._elementIds[t],u=i._itsaformelement.render(o,a),i._isDateTimeType(o.type)&&e.use("gallery-itsadatetimepicker")):u="",u},savePromise:function(e,t){var n=this,r=n.get("updateMode");return n._needAutoSaved=!1,r!==3&&n._editFieldsToModel(),n.host.savePromise(e,t)},submitPromise:function(e,t){var n=this,r=n.get("updateMode");return n._needAutoSaved=!1,r!==3&&n._editFieldsToModel(),n.host.submitPromise(e,t)},toJSON:function(t){var n=this,r=n.host,i,u,a;return t?(i=e.merge(r.getAttrs()),s.each(i,function(r,i,s){u=e.merge(x,t&&t[i]||{},{name:i,value:r}),t[i]?(t[i].name=i,t[i].value=r,n._elementIds[i]||(n._elementIds[i]=e.guid()),a=n._elementIds[i],s[i]=n._itsaformelement.render(u,a)):delete s[i]}),s.each(t,function(t,r){var s=t.type;if(s==="button"||s==="reset"||s==="submit"||s==="save"||s==="destroy")u=e.merge(x,t,{name:r,value:t.buttonText||o}),r.name=r,r.value=t.buttonText,n._elementIds[r]||(n._elementIds[r]=e.guid()),a=n._elementIds[r],i[r]=n._itsaformelement.render(u,a)})):i="",n._configAttrs=t,i},destructor:function(){var e=this;e._autoSaveTimer&&e._autoSaveTimer.cancel(),e._clearEventhandlers(),e._itsaformelement.destroy(),e._configAttrs={},e._elementIds={},e.removeTarget(e.host)},_autoStore:function(){var e=this;e._needAutoSaved&&(e._editFieldsToModel(),e._needAutoSaved=!1)},_bindUI:function(){var t=this,n=t._eventhandlers;n.push(e.on(a,function(n){var r=n.buttonNode,i=r.one("span"),s=r.previous("span"),o=e.ItsaDateTimePicker,u=n.property,a=t._configAttrs[u],f=t.host.get(u),p=a&&a.widgetConfig||{},d;n.elementId===t._elementIds[u]&&(i.hasClass(l)?d=e.rbind(o.getDate,o):i.hasClass(c)?d=e.rbind(o.getTime,o):i.hasClass(h)&&(d=e.rbind(o.getDateTime,o)),p.alignToNode=r,d(f,p).then(function(e){var n;t._storeProperty(s,u,e,!0),n=t.getElement(u,a,a.value),s.setHTML(t._getDateTimeValueFromRender(n)),r.focus()},function(){r&&r.focus()}))})),n.push(e.on([k,N,C,D,L],function(e){e.elementId===t._elementIds[e.property]&&(e.halt(),t._fireModelEvent(e.type,e))})),n.push(e.on(A,function(e){e.elementId===t._elementIds[e.property]&&(e.halt(),t.fire(A,e))})),n.push(e.on(_,function(e){e.elementId===t._elementIds[e.property]&&t._storeProperty(e.inputNode,e.property,e.inputNode.get("value"))})),n.push(e.on(M,function(e){e.elementId===t._elementIds[e.property]&&t._storeProperty(e.inputNode,e.property,e.inputNode.get("value"),!0)})),t.host.on("model:change",function(){e.fire(O,{message:u})})},_clearEventhandlers:function(){i.each(this._eventhandlers,function(e){e.detach()})},_defPluginDestroyFn:function(){var e=this;e._needAutoSaved=!1,e._syncModel("destroy")},_defPluginResetFn:function(){var e=this;e._needAutoSaved=!1},_defPluginSubmitFn:function(){this._defStoreFn("submit")},_defSaveFn:function(){this._defStoreFn("save")},_defStoreFn:function(e){var t=this,n=t.get("updateMode");t._needAutoSaved=!1,n!==3&&t._editFieldsToModel(),t._syncModel(e)},_editFieldsToModel:function(){var e=this,t=e._configAttrs,n={};s.each(t,function(e,t){n[t]=e.value}),e._setProperty(null,n)},_fireModelEvent:function(e,t){var n=this.host;t.model=n,n.fire(e,t)},_getDateTimeValueFromRender:function(e){var t=/<span[^>]+>([^<]*)</;return t.test(e)?RegExp.$1:""},_isDateTimeType:function(e){return e==="date"||e==="time"||e==="datetime"},_setProperty:function(e,t){var n=this,r=n.host,i={fromEditModel:!0},s;s=n._configAttrs[e],s&&(s.value=t),e?r.set(e,t,i):r.setAttrs(t,i)},_storeProperty:function(t,n,i,s){var o=this,u=o.get("updateMode"),a=r.isObject(i),f={node:t,property:n,newVal:a?e.merge(i):i,finished:s},l,c,h;l=o._configAttrs[n],l?(f.prevValue=a?e.merge(l.value):l.value,l.value=i):(h=o.host.get(n),f.prevValue=a?e.merge(h):h),c=u===3||u===1&&s,c?o._setProperty(n,i):(t.addClass(m),
u===2&&(o._needAutoSaved=!0)),o.fire(n+"Change",f)},_syncModel:function(e){var t=this,n=t.host,r,i,s;i=t.get("syncOptions"),s=t.get("syncCallbacks"),e==="destroy"?(r=i.destroy||{},r.remove=!0,n.destroy(r,s.destroy)):n.sync(e,i[e],s[e])}},{NS:"itsaeditmodel",ATTRS:{autosaveInterval:{value:30,validator:function(e){return typeof e=="number"&&e>0&&e<=3600},setter:function(t){var n=this,r=n.get("updateMode");n._autoSaveTimer&&n._autoSaveTimer.cancel(),r===2&&(n._autoSaveTimer=e.later(1e3*t,n,n._autoStore,null,!0))}},editmodelConfigAttrs:{value:{},validator:function(e){return r.isObject(e)}},syncCallbacks:{value:{},validator:function(e){return r.isObject(e)}},syncOptions:{value:{},validator:function(e){return r.isObject(e)}},template:{value:null,validator:function(e){return typeof e=="string"}},updateMode:{value:0,lazyAdd:!1,validator:function(e){return typeof e=="number"&&e>=0&&e<=3},setter:function(t){var n=this,r=n.get("autosaveInterval");t?n._autoSaveTimer=e.later(1e3*r,n,n._autoStore,null,!0):n._autoSaveTimer&&n._autoSaveTimer.cancel()}}}}),n.delegate("click",function(t){var n=t.currentTarget,r=n.previous("span");t.halt(),n.focus(),e.use("gallery-itsadatetimepicker",function(e){t.elementId=r.get("id"),t.type=a,t.buttonNode=n,t.property=T(r.getAttribute("class")),e.fire(a,t)})},"."+f),n.delegate("valuechange",function(t){var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=T(n.getAttribute("class")),t.type=_,e.fire(_,t)},"."+v),n.delegate("change",function(t){var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=T(n.getAttribute("class")),t.type=M,e.fire(M,t)},"."+v),n.delegate("keypress",function(t){if(t.keyCode===13){t.halt();var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=T(n.getAttribute("class")),t.type=A,e.fire(A,t)}},"."+g),n.delegate("click",function(t){var n=t.currentTarget,r=n.getAttribute("class");t.halt(),n.focus(),t.elementId=n.get("id"),t.buttonNode=n,t.property=T(n.getAttribute("class")),r.indexOf(b)!==-1?(t.type=N,e.fire(N,t)):r.indexOf(y)!==-1?(t.type=D,e.fire(D,t)):r.indexOf(w)!==-1?(t.type=k,e.fire(k,t)):r.indexOf(E)!==-1?(t.type=C,e.fire(C,t)):r.indexOf(S)!==-1&&(t.type=L,e.fire(L,t))},"."+d)},"@VERSION@",{requires:["yui-base","base-build","node-base","node-delegate","plugin","lazy-model-list","event-valuechange","gallery-itsamodelsyncpromise","gallery-itsaformelement"]});
