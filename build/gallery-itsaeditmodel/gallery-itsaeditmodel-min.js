YUI.add("gallery-itsaeditmodel",function(e,t){"use strict";var n=e.one("body"),r=e.Lang,i=e.Array,s=e.Object,o="datetimepickerclick",u="date",a="time",f=u+a,l=e.ITSAFormElement,c="The data you are editing has been changed from outside the form. If you save your data, then these former changed will be overridden.",h="datetimepickerclick",p="itsa-button-datetime",d="itsa-datetimepicker-icondate",v="itsa-datetimepicker-icontime",m="itsa-datetimepicker-icondatetime",g="yui3-itsaformelement",y=g+"-button",b=g+"-lifechange",w=g+"-changed",E=g+"-enternextfield",S=g+"-checkbox",x=g+"-button",T=g+"-add",N=g+"-submit",C=g+"-reset",k=g+"-save",L=g+"-destroy",A=g+"-stopedit",O=function(e){var t=/yui3-itsaformelement-property-(\w+)/;return t.test(e)?RegExp.$1:null},M="internal",_="submitclick",D="addclick",P="saveclick",H="resetclick",B="destroyclick",j="stopeditclick",F="focusnext",I="dialog:warn",q="inputchange",R="inputvaluechange",U="buttonclick",z="pluggedin";e.namespace("Plugin").ITSAEditModel=e.Base.create("itsaeditmodel",e.Plugin.Base,[],{initializer:function(){var t=this,n;t.host=t.get("host"),t._eventhandlers=[],t._UIelements={},t._needAutoSaved=!1,t._autoSaveTimer=null,t._fireEventTimer=null,n=t.host,n.publish(_,{defaultFn:e.rbind(t._defPluginSubmitFn,t),emitFacade:!0}),n.publish(D,{defaultFn:e.rbind(t._defPluginAddFn,t),emitFacade:!0}),n.publish(H,{defaultFn:e.rbind(t._defPluginResetFn,t),emitFacade:!0}),n.publish(P,{defaultFn:e.rbind(t._defPluginSaveFn,t),emitFacade:!0}),n.publish(B,{defaultFn:e.rbind(t._defPluginDestroyFn,t),emitFacade:!0}),n.publish(j,{defaultFn:e.rbind(t._defPluginStopEditFn,t),emitFacade:!0}),t._bindUI(),t.addTarget(n),t._fireEventTimer=e.later(50,t,function(){n.itsaeditmodel&&(t._fireEventTimer.cancel(),t.fire(z))},null,!0)},getButton:function(t,n){var r=this,i=t,s=n&&n.type,o,u,a,f;return!t||s!=="button"&&s!=="reset"&&s!=="submit"&&s!=="save"&&s!=="destroy"&&s!=="stopedit"?o="":(f=t.replace(/ /g,"_"),r._UIelements[f]||(r._UIelements[f]={nodeid:e.guid()}),u=r._UIelements[f],a=u.config=e.merge(n),u.type=u.config.type,a.name=f,a.value=i,o=u.html=l.getElement(u.type,u.config,u.nodeid).html,r._isDateTimeType(s)&&e.use("gallery-itsadatetimepicker")),o},getElement:function(t,n){var r=this,i,s,o,u,a;return t&&n?(r._UIelements[t]||(r._UIelements[t]={nodeid:e.guid()}),o=r._UIelements[t],a=o.config=e.merge(n),o.type=a.type,u=r._getWidgetValueField(o.type),o.value=a[u]=a.differentValue||r.host.get(t),i=l.getElement(o.type,a,o.nodeid),s=o.html=i.html,o.widget=i.widget,r._isDateTimeType(o.type)&&e.use("gallery-itsadatetimepicker")):s="",s},getGeneratedUIelement:function(e){return this._UIelements[e]},savePromise:function(e){var t=this,n=t.get("updateMode");return t._needAutoSaved=!1,n!==3&&t._editFieldsToModel(),t.host.savePromise(e)},submitPromise:function(e){var t=this,n=t.get("updateMode");return t._needAutoSaved=!1,n!==3&&t._editFieldsToModel(),t.host.submitPromise(e)},toJSON:function(t){var n=this,r=n.host,i,o,u,a;return t?(o=e.clone(t),i=e.merge(r.getAttrs()),s.each(i,function(t,r,i){var s=o[r],f;s?(n._UIelements[r]||(n._UIelements[r]={nodeid:e.guid()}),u=n._UIelements[r],u.config=s,u.type=s.type,a=n._getWidgetValueField(u.type),u.value=s[a]=s.differentValue||t,f=l.getElement(u.type,s,u.nodeid),u.widget=f.widget,i[r]=u.html=f.html):delete i[r]}),s.each(o,function(t,r){var s=t.type,o,a,f;if(s==="button"||s==="reset"||s==="submit"||s==="save"||s==="destroy"||s==="stopedit")n._UIelements[f]||(n._UIelements[f]={nodeid:e.guid()}),u=n._UIelements[f],a=t.buttonText||s,f=a.replace(/ /g,"_"),t.name=f,t.value=a,u.type=t.type,u.config=t,u.type=t.type,o=l.getElement(u.type,u.config,u.nodeid),u.widget=o.widget,i[r]=u.html=o.html})):i={},i},destructor:function(){var e=this;e._autoSaveTimer&&e._autoSaveTimer.cancel(),e._fireEventTimer&&e._fireEventTimer.cancel(),e._clearEventhandlers(),e._itsaformelement.destroy(),e._UIelements={},e.removeTarget(e.host)},_autoStore:function(){var e=this;e._needAutoSaved&&(e._editFieldsToModel(),e._needAutoSaved=!1)},_retreiveProp:function(e){var t=this,n=e&&e.getData("property"),r=n&&t._UIelements[n];return r&&r.nodeid===e.get("id")?n:null},_retreiveType:function(e){return e&&e.getData("type")},_bindUI:function(){var t=this,n=t._eventhandlers,r=t.host;e.one("body").on(o,function(n){var r=n.target,i=t._retreiveProp(r),s=e.ItsaDateTimePicker,o,l,c,h,p,d,v;i&&(o=t.host.get(i),l=t._UIelements[i],c=l&&l.widgetConfig||{},h=t._retreiveType(r),h===u?p=e.bind(s.getDate,s):h===a?p=e.bind(s.getTime,s):h===f&&(p=e.bind(s.getDateTime,s)),d=r.one("span"),v=r.previous("span"),p(o,c).then(function(e){var n;t._storeProperty(v,s,i,e,!0),n=t.getElement(i,l,l.value),v.setHTML(t._getDateTimeValueFromRender(n)),r&&r.focus()},function(){r&&r.focus()}))}),n.push(r.on(h,function(n){var r=n.buttonNode,i=r.one("span"),s=r.previous("span"),o=e.ItsaDateTimePicker,u=n.property,a=t._UIelements[u],f=t.host.get(u),l=a&&a.widgetConfig||{},c;console.log("clicked datetime fase 1 property "+u+"| "+n.elementId+" | "+a.nodeid),a&&n.elementId===a.nodeid&&(console.log("clicked datetime fase 2"),i.hasClass(d)?c=e.rbind(o.getDate,o):i.hasClass(v)?c=e.rbind(o.getTime,o):i.hasClass(m)&&(c=e.rbind(o.getDateTime,o)),l.alignToNode=r,c(f,l).then(function(e){var n;t._storeProperty(s,o,u,e,!0),n=t.getElement(u,a,a.value),s.setHTML(t._getDateTimeValueFromRender(n)),r.focus()},function(){r&&r.focus()}))},"."+p)),n.push(e.on([M+H,M+_,M+P,M+U,M+D,M+B,M+j],function(n){var r=t._UIelements[n.property],i;r&&n.elementId===r.nodeid&&(n.halt(),i={type:n.type},e.rbind(t._fireModelEvent,t,n.type,i)())})),n.push(e.on(F,function(e){var n=t._UIelements[e.property];n&&e.elementId===n.nodeid&&(e.halt(),t.fire(F,e))})),n.push(e.on(R,function(e){var n=t._UIelements[e.property];n&&e.elementId===n.nodeid&&t._storeProperty(e.inputNode,e.widget,e.property,e.inputNode.get("value"))})),n.push(e.on(q,function(e){var n=t._UIelements[e.property];n&&e.elementId===n.nodeid&&t._storeProperty(e.inputNode,null,e.property,e.inputNode.get("value"
),!0)})),t.host.on("*:change",function(t){t.target instanceof e.Model&&e.fire(I,{message:c})})},_clearEventhandlers:function(){i.each(this._eventhandlers,function(e){e.detach()})},_defPluginDestroyFn:function(){var e=this;e._needAutoSaved=!1},_defPluginStopEditFn:function(){var e=this;e._needAutoSaved=!1,e.host.unplug("itsaeditmodel")},_defPluginAddFn:function(){var e=this;e._needAutoSaved=!1},_defPluginResetFn:function(){var e=this;e._needAutoSaved=!1},_defPluginSubmitFn:function(){this._defStoreFn("submit")},_defPluginSaveFn:function(){this._defStoreFn("save")},_defStoreFn:function(){var e=this,t=e.get("updateMode");e._needAutoSaved=!1,t!==3&&e._editFieldsToModel()},_editFieldsToModel:function(){var e=this,t={};s.each(e._UIelements,function(e,n){t[n]=e.value}),e._setProperty(null,t)},_getWidgetValueField:function(e){var t=typeof e=="function"&&e.prototype.BOUNDING_TEMPLATE,n,r;return t&&(n=e.NAME,n==="itsacheckbox"&&(r="checked")),r||"value"},_fireModelEvent:function(t,n){var r=this,i=r.host,s,o,u,a,f;n.target=i,t===D&&(s=r.get("newModelClass"),u=new s,o=e.clone(r.getAttrs()),u.plug(e.Plugin.ITSAEditModel,o),n.newModel=u),t===P?(a=r.get("syncOptions"),f=a.save||{},n.promise=r.host.savePromise(f)):t===_?(a=r.get("syncOptions"),f=a.submit||{},n.promise=r.host.submitPromise(f)):t===B&&(a=r.get("syncOptions"),f=e.merge({remove:!0},a.destroy||{}),n.promise=r.host.destroyPromise(f)),i.fire(t,n)},_getDateTimeValueFromRender:function(e){var t=/<span[^>]+>([^<]*)</;return t.test(e)?RegExp.$1:""},_isDateTimeType:function(e){return e==="date"||e==="time"||e==="datetime"},_setProperty:function(e,t){var n=this,r=n.host,i={fromEditModel:!0},s;s=n._UIelements[e],s&&(s.value=t),e?r.set(e,t,i):r.setAttrs(t,i)},_storeProperty:function(t,n,i,s,o){var u=this,a=u.get("updateMode"),f=r.isObject(s),l={node:t,widget:n,property:i,newVal:f?e.merge(s):s,finished:o},c,h,p;c=u._UIelements[i],c?(l.prevValue=f?e.merge(c.value):c.value,c.value=s):(p=u.host.get(i),l.prevValue=f?e.merge(p):p),h=a===3||a===1&&o,h?u._setProperty(i,s):(t.addClass(w),a===2&&(u._needAutoSaved=!0)),u.fire(i+"Change",l)}},{NS:"itsaeditmodel",ATTRS:{autosaveInterval:{value:30,validator:function(e){return typeof e=="number"&&e>0&&e<=3600},setter:function(t){var n=this,r=n.get("updateMode");n._autoSaveTimer&&n._autoSaveTimer.cancel(),r===2&&(n._autoSaveTimer=e.later(1e3*t,n,n._autoStore,null,!0))}},syncOptions:{value:{},validator:function(e){return r.isObject(e)}},newModelClass:{value:e.Model},xtemplate:{value:null,validator:function(e){return typeof e=="string"}},updateMode:{value:0,lazyAdd:!1,validator:function(e){return typeof e=="number"&&e>=0&&e<=3},setter:function(t){var n=this,r=n.get("autosaveInterval");t?n._autoSaveTimer=e.later(1e3*r,n,n._autoStore,null,!0):n._autoSaveTimer&&n._autoSaveTimer.cancel()}}}}),e.augment(e.Model,e.Plugin.Host),e.Event.define(o,{on:function(e,t,n){t._handle=e.on("click",function(e){var t=e.target;console.log("fase 1 "+e.target),t.getAttribute("data-datetime")&&(console.log("fase 2"),n.fire(e))})},detach:function(e,t){t._handle.detach()}}),n.delegate("click",function(t){var n=t.currentTarget,r=n.previous("span");t.halt(),n.focus(),e.use("gallery-itsadatetimepicker",function(e){t.elementId=r.get("id"),t.type=h,t.buttonNode=n,t.property=O(r.getAttribute("class")),e.fire(h,t)})},"."+p),n.delegate("valuechange",function(t){var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=O(n.getAttribute("class")),t.type=R,e.fire(R,t)},"."+b),n.delegate("change",function(t){var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=O(n.getAttribute("class")),t.type=q,e.fire(q,t)},"."+b),e.delegate("valuechange",function(t){var n=t.currentTarget,r=n.get("boundingBox");t.elementId=r.get("id"),t.widget=n,t.property=O(r.getAttribute("class")),t.type=R,e.fire(R,t)},"."+S),n.delegate("keypress",function(t){if(t.keyCode===13){t.halt();var n=t.currentTarget;t.elementId=n.get("id"),t.inputNode=n,t.property=O(n.getAttribute("class")),t.type=F,e.fire(F,t)}},"."+E),n.delegate("click",function(t){var n=t.currentTarget,r=n.getAttribute("class");t.halt(),n.focus(),t.elementId=n.get("id"),t.buttonNode=n,t.property=O(n.getAttribute("class")),r.indexOf(N)!==-1?(t.type=_,e.fire(M+_,t)):r.indexOf(C)!==-1?(t.type=H,e.fire(M+H,t)):r.indexOf(k)!==-1?(t.type=P,e.fire(M+P,t)):r.indexOf(L)!==-1?(t.type=B,e.fire(M+B,t)):r.indexOf(A)!==-1?(t.type=j,e.fire(M+j,t)):r.indexOf(T)!==-1?(t.type=D,e.fire(M+D,t)):r.indexOf(x)!==-1&&(t.type=U,e.fire(M+U,t))},"."+y)},"@VERSION@",{requires:["yui-base","base-build","node-base","node-event-delegate","event-synthetic","plugin","pluginhost-base","lazy-model-list","event-valuechange","gallery-itsamodelsyncpromise","gallery-itsaformelement"]});
